# Система уведомлений для Mini App

## Обзор

Реализована полная система уведомлений с возможностью включения/выключения в настройках мини-приложения. Пользователи получают уведомления о новых сообщениях и ответах на комментарии, админы - обо всех событиях (жалобы, комментарии, подписки и т.д.).

## Реализованные компоненты

### 1. Модели данных

#### MiniAppUser
- **Новое поле**: `notifications_enabled` (BooleanField, default=True)
- Общий переключатель всех уведомлений

#### Notification (новая модель)
- `recipient_telegram_id` - получатель уведомления
- `notification_type` - тип уведомления (message, comment_reply, report, subscription, comment)
- `title` - заголовок уведомления
- `message` - текст уведомления
- `related_object_id` - ID связанного объекта
- `related_object_type` - тип связанного объекта
- `is_read` - статус прочтения
- `sent_to_telegram` - статус отправки в Telegram
- `created_at` - время создания

**Миграция**: `accounts/migrations/0011_add_notifications.py`

### 2. API

#### Сериализаторы
- `MiniAppUserSerializer` - добавлено поле `notifications_enabled`
- `MiniAppUserUpdateSerializer` - поддержка обновления `notifications_enabled`

#### Эндпоинт
Существующий эндпоинт `PATCH /api/accounts/miniapp-users/update/{telegram_id}/` теперь поддерживает обновление настроек уведомлений.

### 3. Сервис отправки уведомлений

**Файл**: `quiz_backend/accounts/utils_folder/telegram_notifications.py`

#### Функции:
- `send_telegram_notification_sync(telegram_id, message, parse_mode)` - синхронная отправка в Telegram
- `create_notification(...)` - создание уведомления в БД и отправка в Telegram
- `notify_all_admins(...)` - массовая отправка уведомлений всем админам

### 4. Интеграция с событиями

#### Уведомления пользователям:
1. **Ответы на комментарии** (`quiz_backend/tasks/comment_views.py`)
   - При создании ответа на комментарий автор родительского комментария получает уведомление
   - Тип: `comment_reply`

2. **Новые сообщения** (`quiz_backend/blog/views.py`)
   - При отправке личного сообщения получатель получает уведомление
   - Тип: `message`

#### Уведомления админам:
1. **Новые комментарии** (`quiz_backend/tasks/comment_views.py`)
   - Все админы получают уведомления о новых комментариях
   - Тип: `comment`

2. **Жалобы на комментарии** (`quiz_backend/tasks/comment_views.py`)
   - Все админы получают уведомления о жалобах
   - Тип: `report`

3. **Новые подписки** (`quiz_backend/accounts/models.py`)
   - Все админы получают уведомления о новых подписках пользователей
   - Тип: `subscription`

### 5. UI настроек

**Файлы**:
- `mini_app/templates/settings.html` - HTML с переключателем уведомлений
- `mini_app/static/js/settings.js` - логика сохранения через API

**Функциональность**:
- Переключатель синхронизируется с профилем пользователя
- Изменения сохраняются через PATCH запрос к API
- Пользователь получает подтверждение об изменении настройки

### 6. Админка Django

**Файл**: `quiz_backend/accounts/admin.py`

#### MiniAppUserAdmin
- Добавлено поле `notifications_enabled` в list_display и list_filter
- Новая секция "Настройки" в fieldsets

#### NotificationAdmin (новый)
- Список уведомлений с фильтрами
- Действия: отметить как прочитанные/непрочитанные, повторно отправить в Telegram
- Поиск по получателю и тексту

### 7. Логика работы

1. **Проверка настроек**: Перед отправкой уведомления проверяется, включены ли уведомления у получателя
2. **Двойная запись**: Уведомление сохраняется в БД и отправляется в Telegram
3. **Статусы**: Отслеживается статус прочтения и отправки
4. **Админы**: Идентифицируются через связи с `TelegramAdmin` или `DjangoAdmin`

## Типы уведомлений

| Тип | Описание | Получатели |
|-----|----------|------------|
| `message` | Новое личное сообщение | Получатель сообщения |
| `comment_reply` | Ответ на комментарий | Автор родительского комментария |
| `comment` | Новый комментарий | Все админы |
| `report` | Жалоба на комментарий | Все админы |
| `subscription` | Новая подписка | Все админы |

## Техническая информация

### Отправка в Telegram
- Используется внутренний API бота: `http://bot:8000/api/send-message/`
- Формат сообщения: Markdown
- Таймаут: 10 секунд

### База данных
- Таблица уведомлений: `notifications`
- Индексы по: `recipient_telegram_id`, `is_read`, `created_at`
- История уведомлений сохраняется для просмотра в админке

### Локализация
- Переводы уже существуют в `mini_app/services/localization.py`
- Ключ: `notifications`
- Поддерживаемые языки: русский, английский

## Тестирование

### Шаги для проверки:

1. **Настройки уведомлений**:
   - Открыть страницу настроек в Mini App
   - Переключить уведомления вкл/выкл
   - Проверить сохранение в профиле пользователя

2. **Уведомления пользователям**:
   - Оставить комментарий
   - Ответить на чужой комментарий
   - Отправить личное сообщение
   - Проверить получение уведомлений в Telegram

3. **Уведомления админам**:
   - Оставить комментарий (как обычный пользователь)
   - Подать жалобу на комментарий
   - Подписаться на канал
   - Проверить получение уведомлений админами в Telegram

4. **Админка Django**:
   - Просмотреть список уведомлений
   - Отметить как прочитанные
   - Повторно отправить уведомление

## Файлы изменений

### Модели и миграции:
- `quiz_backend/accounts/models.py` - модели MiniAppUser, Notification, UserChannelSubscription
- `quiz_backend/accounts/migrations/0011_add_notifications.py` - миграция

### API и сериализаторы:
- `quiz_backend/accounts/serializers.py` - обновлены сериализаторы

### Сервисы:
- `quiz_backend/accounts/utils_folder/telegram_notifications.py` - сервис уведомлений

### Обработчики событий:
- `quiz_backend/tasks/comment_views.py` - уведомления о комментариях и жалобах
- `quiz_backend/blog/views.py` - уведомления о сообщениях

### Админка:
- `quiz_backend/accounts/admin.py` - админ-панели для моделей

### UI:
- `mini_app/static/js/settings.js` - логика работы с настройками

## Примеры использования

### Отправка пользовательского уведомления:
```python
from accounts.utils_folder.telegram_notifications import create_notification

create_notification(
    recipient_telegram_id=123456789,
    notification_type='message',
    title='Новое сообщение',
    message='Пользователь отправил вам сообщение',
    related_object_id=message.id,
    related_object_type='message',
    send_to_telegram=True
)
```

### Уведомление всех админов:
```python
from accounts.utils_folder.telegram_notifications import notify_all_admins

notify_all_admins(
    notification_type='report',
    title='Новая жалоба',
    message='Пользователь подал жалобу',
    related_object_id=report.id,
    related_object_type='report'
)
```

## Дополнительные возможности для развития

1. **Веб-интерфейс уведомлений в Mini App**:
   - Страница со списком уведомлений
   - Отметка прочитанных
   - Счетчик непрочитанных

2. **Настройки уведомлений по типам**:
   - Раздельные переключатели для разных типов уведомлений
   - Тихие часы (не отправлять уведомления ночью)

3. **Push-уведомления**:
   - Интеграция с Web Push API
   - Уведомления прямо в браузере

4. **Email-уведомления**:
   - Дублирование важных уведомлений на email
   - Дайджесты уведомлений

## Заключение

Система уведомлений полностью функциональна и готова к использованию. Все компоненты интегрированы, миграции применены, контейнеры перезапущены.

