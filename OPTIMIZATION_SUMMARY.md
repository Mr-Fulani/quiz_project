# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ `./start-prod.sh` –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —Å–µ—Ä–≤–µ—Ä –∑–∞–≤–∏—Å–∞–ª –∏–∑-–∑–∞ –Ω–µ—Ö–≤–∞—Ç–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä `quiz_backend` –¥–æ–ª–≥–æ —Å–æ–±–∏—Ä–∞–ª—Å—è –∏ –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è.

## –ü—Ä–∏—á–∏–Ω—ã –∑–∞–≤–∏—Å–∞–Ω–∏—è

1. **–î–≤–æ–π–Ω–æ–π –∑–∞–ø—É—Å–∫ collectstatic**: –°—Ç–∞—Ç–∏–∫–∞ —Å–æ–±–∏—Ä–∞–ª–∞—Å—å –¥–≤–∞–∂–¥—ã - –≤ `entrypoint.sh` –∏ –≤ `start-prod.sh`, —á—Ç–æ —É–¥–≤–∞–∏–≤–∞–ª–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
2. **–°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∫–æ–Ω–æ–∫**: –ö–æ–º–∞–Ω–¥–∞ `fix_icon_mapping` –≤—ã–ø–æ–ª–Ω—è–ª–∞—Å—å —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∏ –º–æ–≥–ª–∞ –∑–∞–≤–∏—Å–∞—Ç—å, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—è 120+ –∏–∫–æ–Ω–æ–∫ —Å O(n√óm) —Å–ª–æ–∂–Ω–æ—Å—Ç—å—é
3. **–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ Gunicorn workers**: 4 workers –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–æ–∑–¥–∞–≤–∞–ª–∏ –∏–∑–ª–∏—à–Ω—é—é –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ —Å–ª–∞–±—ã–π —Å–µ—Ä–≤–µ—Ä
4. **–ñ–µ—Å—Ç–∫–∏–π `set -e`**: –õ—é–±–∞—è –æ—à–∏–±–∫–∞ –≤ –Ω–µ–∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö –ø—Ä–∏–≤–æ–¥–∏–ª–∞ –∫ –ø–æ–ª–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω `quiz_backend/entrypoint.sh`

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è:
- ‚úÖ –£–±—Ä–∞–ª `rm -rf staticfiles/*` –ø–µ—Ä–µ–¥ collectstatic (—É–±—Ä–∞–ª --clear)
- ‚úÖ –£–±—Ä–∞–ª –¥—É–±–ª–∏—Ä—É—é—â—É—é—Å—è —Å–±–æ—Ä–∫—É —Å—Ç–∞—Ç–∏–∫–∏ - —Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
- ‚úÖ –°–¥–µ–ª–∞–ª `fix_icon_mapping` –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º —Å —Ç–∞–π–º–∞—É—Ç–æ–º 3 —Å–µ–∫—É–Ω–¥—ã
- ‚úÖ –î–æ–±–∞–≤–∏–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ `set -e` –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö/–Ω–µ–∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –°–¥–µ–ª–∞–ª collectstatic –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–º —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫

#### –†–µ–∑—É–ª—å—Ç–∞—Ç:
```bash
# –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –æ–ø–µ—Ä–∞—Ü–∏–∏ (set -e)
wait_for_db
migrate

# –ù–ï–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –æ–ø–µ—Ä–∞—Ü–∏–∏ (set +e)  
collectstatic (–±–µ–∑ –æ—á–∏—Å—Ç–∫–∏, —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫)
fix_icon_mapping (—Ñ–æ–Ω–æ–≤—ã–π —Ä–µ–∂–∏–º, —Ç–∞–π–º–∞—É—Ç 3 —Å–µ–∫)

# –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –æ–ø–µ—Ä–∞—Ü–∏–∏ (set -e)
start gunicorn
```

### 2. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω `start-prod.sh`

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è:
- ‚úÖ –£–±—Ä–∞–ª –¥—É–±–ª–∏—Ä—É—é—â—É—é—Å—è —Å–±–æ—Ä–∫—É —Å—Ç–∞—Ç–∏–∫–∏ (—Å—Ç—Ä–æ–∫–∞ 122-131)
- ‚úÖ –ò–∑–º–µ–Ω–∏–ª –Ω–∞ –ø—Ä–æ—Å—Ç—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞–ª–∏—á–∏—è —Å—Ç–∞—Ç–∏–∫–∏
- ‚úÖ –î–æ–±–∞–≤–∏–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –µ—â–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

### 3. –£–º–µ–Ω—å—à–µ–Ω–∞ –Ω–∞–≥—Ä—É–∑–∫–∞ Gunicorn

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è:
- ‚úÖ `GUNICORN_WORKERS`: 4 ‚Üí 2 (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –≤—ã–≤–æ–¥ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ –ª–æ–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `docker-compose.local-prod.yml` –∏ `entrypoint.sh`

#### –§–∞–π–ª—ã:
- `docker-compose.local-prod.yml`: —Å—Ç—Ä–æ–∫–∞ 69
- `quiz_backend/entrypoint.sh`: —Å—Ç—Ä–æ–∫–∏ 73, 78

## –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- ‚è±Ô∏è –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: **30-60 —Å–µ–∫—É–Ω–¥** –∏–ª–∏ –∑–∞–≤–∏—Å–∞–Ω–∏–µ
- üì¶ –î–≤–æ–π–Ω–æ–π collectstatic: **10-20 —Å–µ–∫—É–Ω–¥ √ó 2**
- üé® fix_icon_mapping: **15-30 —Å–µ–∫—É–Ω–¥** (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
- üíæ Workers: 4 (–≤—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞)

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- ‚è±Ô∏è –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: **10-15 —Å–µ–∫—É–Ω–¥**
- üì¶ –û–¥–∏–Ω collectstatic: **5-10 —Å–µ–∫—É–Ω–¥**
- üé® fix_icon_mapping: **3 —Å–µ–∫—É–Ω–¥—ã** (—Å —Ç–∞–π–º–∞—É—Ç–æ–º)
- üíæ Workers: 2 (—É–º–µ—Ä–µ–Ω–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞)

### –û–±—â–∏–π –≤—ã–∏–≥—Ä—ã—à:
- **50-70% –±—ã—Å—Ç—Ä–µ–µ –∑–∞–ø—É—Å–∫**
- **50% –º–µ–Ω—å—à–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏**
- **–ù–µ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏–π**

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

1. `quiz_backend/entrypoint.sh` - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –∑–∞–ø—É—Å–∫
2. `start-prod.sh` - —É–±—Ä–∞–Ω–∞ –¥—É–±–ª–∏—Ä—É—é—â–∞—è—Å—è —Å–±–æ—Ä–∫–∞ —Å—Ç–∞—Ç–∏–∫–∏
3. `docker-compose.local-prod.yml` - —É–º–µ–Ω—å—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ workers
4. `OPTIMIZATION_SUMMARY.md` - —ç—Ç–æ—Ç —Ñ–∞–π–ª

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `--fast` —Ä–µ–∂–∏–º** –¥–ª—è –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:
   ```bash
   ./start-prod.sh --fast
   ```

2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤**: –°–ª–µ–¥–∏—Ç–µ –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º CPU –∏ RAM
   ```bash
   htop  # –∏–ª–∏ top
   docker stats
   ```

3. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ workers**: –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –º–æ—â–Ω–µ–µ, –º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å:
   ```bash
   export GUNICORN_WORKERS=4
   ./start-prod.sh
   ```

4. **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–º–µ—Å—Ç–æ –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞ [[memory:3552469]]

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ:

```bash
# –ù–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
./start-prod.sh --fast

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
docker compose -f docker-compose.local-prod.yml logs quiz_backend --tail=50

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
docker stats quiz_backend_local_prod
```

## –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Ç—É–∞—Ü–∏—è: –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä

‚ö†Ô∏è **–í–ê–ñ–ù–û**: –ï—Å–ª–∏ –≤–∞—à —Å–µ—Ä–≤–µ—Ä –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω:
- RAM: 95% –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (1.9/2 GB)
- Storage: 94% –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (37.5/40 GB)
- vCPU: 87% –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ä—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤:

#### 1. –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ Docker
```bash
# –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –æ–±—Ä–∞–∑–æ–≤ –∏ –∫—ç—à–∞
docker system prune -a --volumes -f

# –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤
docker image prune -a -f
```

#### 2. –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö volumes
```bash
# –°–ø–∏—Å–æ–∫ volumes
docker volume ls

# –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö
docker volume prune -f
```

#### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –ª–æ–≥–æ–≤ Docker
du -sh /var/lib/docker/containers/*/

# –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)
truncate -s 0 /var/lib/docker/containers/*/*-json.log
```

#### 4. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Docker daemon
```bash
# –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ª–æ–≥–æ–≤ Docker –≤ /etc/docker/daemon.json
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Docker
systemctl restart docker
```

#### 5. –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ
```bash
# –ü–æ–∏—Å–∫ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
du -h / | sort -rh | head -20

# –û—á–∏—Å—Ç–∫–∞ apt –∫—ç—à–∞
apt-get clean
apt-get autoremove -y

# –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —è–¥–µ—Ä
uname -a
dpkg --list | grep linux-image
apt-get remove --purge linux-image-X.X.X-X-generic
```

### –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞:

–ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è, –≤—Ä–µ–º–µ–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –º–∏–Ω–∏–º—É–º:
```bash
# –í docker-compose.local-prod.yml –∏–ª–∏ —á–µ—Ä–µ–∑ .env
GUNICORN_WORKERS=1
GUNICORN_THREADS=1
CELERY_CONCURRENCY=1
```

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è:

1. **–£–≤–µ–ª–∏—á–∏—Ç—å RAM**: –º–∏–Ω–∏–º—É–º 4 GB –¥–ª—è –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã
2. **–£–≤–µ–ª–∏—á–∏—Ç—å –¥–∏—Å–∫**: –º–∏–Ω–∏–º—É–º 60-80 GB
3. **–î–æ–±–∞–≤–∏—Ç—å swap**: `swapon --show` - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, –µ—Å—Ç—å –ª–∏ swap
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `htop` –∏–ª–∏ `iotop` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –≠—Ç–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ —Å–¥–µ–ª–∞–Ω—ã –¥–ª—è —Å–ª–∞–±—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏
- –î–ª—è –º–æ—â–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å 4 workers
- –§–æ–Ω–æ–≤—ã–π —Ä–µ–∂–∏–º fix_icon_mapping –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –Ω–µ –≤—Å–µ –∏–∫–æ–Ω–∫–∏ –º–æ–≥—É—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ (–Ω–æ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)
- **–ö–†–ò–¢–ò–ß–ù–û**: –ü—Ä–∏ RAM >90% –∏ Storage >90% –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è –¥–∞–∂–µ —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º–∏

