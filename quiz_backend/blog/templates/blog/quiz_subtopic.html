{% extends "blog/base.html" %}
{% load static %}
{% load blog_tags %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'blog/css/quiz_styles.css' %}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
{% endblock %}

{% block content %}
<article class="quiz-subtopic active" data-page="quiz-subtopic">
    <header>
        <h2 class="h2 article-title">{{ topic.name }}</h2>
    </header>

    <section class="tasks">
        {% for task in page_obj %}
            <div class="task-item" data-task-id="{{ task.id }}">
                {% if task.image_url %}
                    <div class="task-image">
                        <img src="{{ task.image_url|safe_url }}" alt="Task {{ task.id }} question">
                    </div>
                {% else %}
                    <p>Изображение отсутствует.</p>
                {% endif %}

                {% if task.translation %}
                    <div class="answers" data-correct="{{ task.correct_answer }}">
                        {% for answer in task.answers %}
                            <span class="answer-option quiz-option"
                                  data-answer="{{ answer }}"
                                  data-correct="{% if answer == task.correct_answer %}true{% else %}false{% endif %}">
                                {{ answer }}
                            </span>
                        {% endfor %}
                    </div>
                {% else %}
                    <p>Перевод отсутствует.</p>
                {% endif %}
            </div>
        {% empty %}
            <p>Задачи отсутствуют.</p>
        {% endfor %}

        <!-- Пагинация -->
        {% if paginator.num_pages > 1 %}
            <div class="pagination">
                {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}" class="btn">Назад</a>
                {% endif %}
                <span>Страница {{ page_obj.number }} из {{ paginator.num_pages }}</span>
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}" class="btn">Далее</a>
                {% endif %}
            </div>
        {% endif %}
    </section>
</article>
{% endblock %}



{% block scripts %}
    <!-- Загружаем только один JS файл -->
    <script src="{% static 'blog/js/quiz_combined.js' %}"></script>
    <!-- Инициализируем дополнительную обработку событий для мобильных устройств -->
    <script>
        // Проверка на мобильное устройство
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        if (isMobile) {
            console.log("Mobile device detected, enabling touch optimizations");
            document.documentElement.classList.add('mobile-device');

            // Предзагрузка звуков для iOS
            function initAudio() {
                const sounds = [
                    new Audio('/static/blog/sounds/thunder.mp3'),
                    new Audio('/static/blog/sounds/success.mp3')
                ];

                sounds.forEach(sound => {
                    sound.volume = 0;
                    sound.play().catch(e => console.log('Sound preload error:', e));
                    setTimeout(() => { sound.pause(); sound.volume = 0.3; }, 10);
                });
            }

            // Запрос разрешений для iOS и предзагрузка звуков
            document.addEventListener('touchstart', function permissionHandler() {
                // Инициализация аудио
                initAudio();

                // Проверка и запрос разрешения на вибрацию для iOS
                if (typeof DeviceMotionEvent !== 'undefined' &&
                    typeof DeviceMotionEvent.requestPermission === 'function') {
                    DeviceMotionEvent.requestPermission()
                        .then(response => {
                            if (response === 'granted') {
                                console.log('Motion permission granted');
                                // Тестовая вибрация
                                if ('vibrate' in navigator) {
                                    navigator.vibrate(50);
                                }
                            }
                        })
                        .catch(e => console.log('Motion permission error:', e));
                } else {
                    // Для Android и других платформ
                    if ('vibrate' in navigator) {
                        try {
                            // Проверяем вибрацию сразу
                            navigator.vibrate(50);
                            console.log('Vibration test successful');
                        } catch(e) {
                            console.error('Vibration test failed:', e);
                        }
                    }
                }

                document.removeEventListener('touchstart', permissionHandler);
            }, { once: true });

            // Альтернативный метод вибрации - добавьте эту функцию в глобальную область видимости
            window.doVibrate = function(pattern) {
                if (!pattern) pattern = [100, 30, 200, 30, 100];

                try {
                    if ('vibrate' in navigator) {
                        navigator.vibrate(pattern);
                        console.log('Vibration activated with pattern:', pattern);
                        return true;
                    }
                } catch (e) {
                    console.error('Vibration error:', e);
                }
                return false;
            };

            // Переопределяем метод выбора ответа для проверки вибрации
            const originalHandleAnswerSelection = window.handleAnswerSelection;
            window.handleAnswerSelection = function(event) {
                // Вызываем оригинальный обработчик
                if (originalHandleAnswerSelection) {
                    originalHandleAnswerSelection.call(this, event);
                }

                // Проверяем корректность ответа
                const option = this;
                const isCorrect = option.dataset.correct === 'true';

                // Если ответ неверный - вибрируем отдельно от основного эффекта
                if (!isCorrect) {
                    setTimeout(() => {
                        window.doVibrate([100, 30, 200, 30, 300]);
                    }, 100);
                }
            };
        }

        // Функция для активации вибрации по требованию - может быть вызвана из консоли
        window.testVibration = function() {
            console.log("Testing vibration...");
            try {
                if ('vibrate' in navigator) {
                    navigator.vibrate([100, 50, 100, 50, 100]);
                    console.log("Vibration command sent!");
                    return true;
                } else {
                    console.log("Vibration API not supported on this device");
                    return false;
                }
            } catch (e) {
                console.error("Vibration error:", e);
                return false;
            }
        };
    </script>
{% endblock %}