{% extends "blog/base.html" %}
{% load static %}
{% load blog_tags %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'blog/css/quiz_styles.css' %}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
{% endblock %}

{% block content %}
<article class="quiz-subtopic active" data-page="quiz-subtopic">
    <header>
        <h2 class="h2 article-title">{{ topic.name }}</h2>
    </header>

    <section class="tasks">
        {% for task in page_obj %}
            <div class="task-item" data-task-id="{{ task.id }}">
                {% if task.image_url %}
                    <div class="task-image">
                        <img src="{{ task.image_url|safe_url }}" alt="Task {{ task.id }} question">
                    </div>
                {% else %}
                    <p>Изображение отсутствует.</p>
                {% endif %}

                {% if task.translation %}
                    <div class="answers" data-correct="{{ task.correct_answer }}">
                        {% for answer in task.answers %}
                            <span class="answer-option quiz-option"
                                  data-answer="{{ answer }}"
                                  data-correct="{% if answer == task.correct_answer %}true{% else %}false{% endif %}">
                                {{ answer }}
                            </span>
                        {% endfor %}
                    </div>
                {% else %}
                    <p>Перевод отсутствует.</p>
                {% endif %}
            </div>
        {% empty %}
            <p>Задачи отсутствуют.</p>
        {% endfor %}

        <!-- Пагинация -->
        {% if paginator.num_pages > 1 %}
            <div class="pagination">
                {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}" class="btn">Назад</a>
                {% endif %}
                <span>Страница {{ page_obj.number }} из {{ paginator.num_pages }}</span>
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}" class="btn">Далее</a>
                {% endif %}
            </div>
        {% endif %}
    </section>
</article>
{% endblock %}

{% block scripts %}
    <!-- Загружаем только один JS файл -->
    <script src="{% static 'blog/js/quiz_combined.js' %}"></script>
    <!-- Инициализируем дополнительную обработку событий для мобильных устройств -->
    <script>
        // Проверка на мобильное устройство
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        if (isMobile) {
            console.log("Mobile device detected, enabling touch optimizations");
            document.documentElement.classList.add('mobile-device');

            // Предзагрузка звуков для iOS
            document.addEventListener('touchstart', function initAudio() {
                const sounds = [
                    new Audio('/static/blog/sounds/thunder.mp3'),
                    new Audio('/static/blog/sounds/success.mp3')
                ];

                sounds.forEach(sound => {
                    sound.volume = 0;
                    sound.play().catch(e => console.log('Sound preload error:', e));
                    setTimeout(() => { sound.pause(); sound.volume = 0.3; }, 10);
                });

                document.removeEventListener('touchstart', initAudio);
            }, { once: true });
        }
    </script>
{% endblock %}