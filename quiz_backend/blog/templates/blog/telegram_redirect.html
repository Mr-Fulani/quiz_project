<!DOCTYPE html>
<html>
<head>
    <title>Telegram Auth Handler</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .error { background: #ffebee; color: #c62828; }
        .widget-container { 
            border: 2px dashed #ccc; 
            padding: 20px; 
            margin: 20px 0; 
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>üéØ Telegram Auth Handler</h1>
    <p><strong>–≠—Ç–æ—Ç URL:</strong> <code>/auth/telegram/</code></p>
    <p>–ó–¥–µ—Å—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∑–∞–ø—Ä–æ—Å—ã –æ—Ç Telegram</p>
    
    <div id="logs"></div>
    
    <div class="widget-container">
        <h2>üîÑ Test Widget (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π return_to):</h2>
        <script async src="https://telegram.org/js/telegram-widget.js?22"
                data-telegram-login="quiz_login_test_bot"
                data-size="large"
                data-userpic="true"
                data-request-access="write"
                data-lang="ru"
                data-onauth="onTelegramAuth(user)">
        </script>
        <p><small>–≠—Ç–æ—Ç –≤–∏–¥–∂–µ—Ç –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å <code>/auth/telegram/</code> –∫–∞–∫ return_to</small></p>
    </div>
    
    <script>
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `${new Date().toLocaleTimeString()}: ${message}`;
            document.getElementById('logs').appendChild(div);
            console.log(message);
        }
        
        // Callback —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞
        function onTelegramAuth(user) {
            log('üöÄ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –æ—Ç –≤–∏–¥–∂–µ—Ç–∞!', 'success');
            log(`User data: ${JSON.stringify(user)}`, 'success');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Ç–µ–∫—É—â–∏–π URL –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
            const params = new URLSearchParams(user);
            window.location.href = window.location.pathname + '?' + params.toString();
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('id')) {
            log('‚úÖ –ü–æ–ª—É—á–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏!', 'success');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            const authData = {};
            for (const [key, value] of urlParams.entries()) {
                authData[key] = value;
            }
            log(`–ü–∞—Ä–∞–º–µ—Ç—Ä—ã: ${JSON.stringify(authData)}`, 'success');
            
            // –í —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –∑–¥–µ—Å—å —É–∂–µ –¥–æ–ª–∂–µ–Ω —Å—Ä–∞–±–æ—Ç–∞—Ç—å Django view
            log('Django TelegramAuthView –¥–æ–ª–∂–µ–Ω –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —ç—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã', 'success');
        } else {
            log('–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–¥–∂–µ—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏–¥–∂–µ—Ç
        window.addEventListener('load', () => {
            setTimeout(() => {
                const iframe = document.querySelector('iframe');
                if (iframe) {
                    log(`üéØ Iframe: ${iframe.src}`, 'success');
                    
                    const url = new URL(iframe.src);
                    const returnTo = url.searchParams.get('return_to');
                    if (returnTo?.includes('/auth/telegram/')) {
                        log('‚úÖ Return URL –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π!', 'success');
                    } else {
                        log(`‚ùå Return URL –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π: ${returnTo}`, 'error');
                    }
                }
            }, 2000);
        });
    </script>
</body>
</html> 