<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Telegram Login Widget - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .status.warning { background: #fff3cd; color: #856404; }
        
        .test-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .test-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .test-btn.primary { background: #007bff; color: white; }
        .test-btn.success { background: #28a745; color: white; }
        .test-btn.warning { background: #ffc107; color: black; }
        .test-btn.danger { background: #dc3545; color: white; }
        
        .diagnostic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .diagnostic-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .check-item {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background: white;
        }
        .check-item.success { border-left: 4px solid #28a745; }
        .check-item.error { border-left: 4px solid #dc3545; }
        .check-item.warning { border-left: 4px solid #ffc107; }
        .check-item.info { border-left: 4px solid #17a2b8; }
        
        .widget-container {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .user-info {
            margin: 20px 0;
            padding: 20px;
            background: #e7f3ff;
            border-radius: 5px;
            border: 1px solid #b3d9ff;
        }
        .widget-variants {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .widget-variant {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .copy-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin: 10px 0;
        }
        .debug {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
        .solutions {
            margin: 30px 0;
        }
        .solution {
            background: #f8f9fa;
            padding: 20px;
            margin: 15px 0;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        pre {
            background: #f1f3f4;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        .error-highlight {
            background: #ffebee;
            border: 1px solid #f44336;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Telegram Login Widget - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h1>
        <p>–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ Telegram</p>
        
        <div id="status" class="status info">
            üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...
        </div>
        
        <div class="test-buttons">
            <button class="test-btn primary" onclick="runFullDiagnostic()">üîç –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</button>
            <button class="test-btn success" onclick="testTelegramAuth()">üß™ –¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</button>
            <button class="test-btn warning" onclick="checkBotFatherSettings()">ü§ñ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å BotFather</button>
            <button class="test-btn danger" onclick="clearDebug()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
        </div>
        
        <div class="diagnostic-grid">
            <div class="diagnostic-card">
                <h4>üìä –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                <div id="system-info">
                    <div class="check-item">
                        <span class="icon">‚è≥</span>
                        <span>–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                </div>
            </div>
            
            <div class="diagnostic-card">
                <h4>üåê –°–µ—Ç–µ–≤–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h4>
                <div id="network-info">
                    <div class="check-item">
                        <span class="icon">‚è≥</span>
                        <span>–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
                    </div>
                </div>
            </div>
            
            <div class="diagnostic-card">
                <h4>üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∂–µ—Ç–∞</h4>
                <div id="widget-info">
                    <div class="check-item">
                        <span class="icon">‚è≥</span>
                        <span>–ê–Ω–∞–ª–∏–∑...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="widget-container">
            <h3>üéØ –í–∏–¥–∂–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Telegram:</h3>
            <div class="error-highlight">
                <strong>‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:</strong> –£–±—Ä–∞–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä (user) –∏–∑ data-onauth
            </div>
            <div id="telegram-widget">
                <script async src="https://telegram.org/js/telegram-widget.js?22"
                        data-telegram-login="mr_proger_bot"
                        data-size="large"
                        data-userpic="true"
                        data-request-access="write"
                        data-lang="ru"
                        data-auth-url="https://quiz-code.com/api/social-auth/telegram/redirect/"
                        data-origin="https://quiz-code.com">
                </script>
            </div>
        </div>
        
        <div id="user-info" class="user-info" style="display: none;">
            <h3>üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:</h3>
            <div id="user-details"></div>
        </div>
        
        <div class="widget-variants">
            <div class="widget-variant">
                <h4>üîß –í–∞—Ä–∏–∞–Ω—Ç 1: Callback —Ñ—É–Ω–∫—Ü–∏—è</h4>
                <p>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ <code>data-onauth</code> –¥–ª—è –≤—ã–∑–æ–≤–∞ —Ñ—É–Ω–∫—Ü–∏–∏</p>
                <div class="error-highlight">
                    <strong>‚ùå –ë—ã–ª–æ:</strong> data-onauth="handleTelegramAuth(user)"<br>
                    <strong>‚úÖ –°—Ç–∞–ª–æ:</strong> data-onauth="handleTelegramAuth"
                </div>
                <button class="copy-btn" onclick="copyWidgetCode('callback')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
                <div id="widget-callback"></div>
            </div>
            
            <div class="widget-variant">
                <h4>üîß –í–∞—Ä–∏–∞–Ω—Ç 2: Redirect URL</h4>
                <p>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ <code>data-auth-url</code> –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞</p>
                <button class="copy-btn" onclick="copyWidgetCode('redirect')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
                <div id="widget-redirect"></div>
            </div>
            
            <div class="widget-variant">
                <h4>üîß –í–∞—Ä–∏–∞–Ω—Ç 3: PostMessage</h4>
                <p>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ postMessage –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö</p>
                <button class="copy-btn" onclick="copyWidgetCode('postmessage')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
                <div id="widget-postmessage"></div>
            </div>
        </div>
        
        <div id="debug" class="debug"></div>
        
        <div class="solutions">
            <h3>üõ†Ô∏è –†–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã:</h3>
            
            <div class="solution">
                <h4>üî¥ –ù–∞–π–¥–µ–Ω–Ω–∞—è —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞</h4>
                <div class="error-highlight">
                    <p><strong>–ü—Ä–æ–±–ª–µ–º–∞:</strong> –í –∞—Ç—Ä–∏–±—É—Ç–µ <code>data-onauth</code> –±—ã–ª —É–∫–∞–∑–∞–Ω –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º:</p>
                    <pre>data-onauth="handleTelegramAuth(user)"</pre>
                    <p><strong>–†–µ—à–µ–Ω–∏–µ:</strong> –£–±—Ä–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä, –æ—Å—Ç–∞–≤–∏–≤ —Ç–æ–ª—å–∫–æ –∏–º—è —Ñ—É–Ω–∫—Ü–∏–∏:</p>
                    <pre>data-onauth="handleTelegramAuth"</pre>
                    <p><strong>–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:</strong> Telegram Widget –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥–∞–µ—Ç –æ–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ callback-—Ñ—É–Ω–∫—Ü–∏—é –∫–∞–∫ –ø–µ—Ä–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä.</p>
                </div>
            </div>
            
            <div class="solution">
                <h4>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ BotFather</h4>
                <p>–í BotFather –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã:</p>
                <pre>/setdomain
                    mr_proger_bot
quiz-code.com</pre>
                <p><strong>‚ö†Ô∏è –í–∞–∂–Ω–æ:</strong> –î–æ–º–µ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∫–∞–∑–∞–Ω –±–µ–∑ <code>https://</code> –∏ –±–µ–∑ —Å–ª–µ—à–∞ –≤ –∫–æ–Ω—Ü–µ!</p>
                <button class="test-btn warning" onclick="checkBotFatherSettings()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            </div>
            
            <div class="solution">
                <h4>2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ auth-url –≤–º–µ—Å—Ç–æ onauth</h4>
                <p>–ó–∞–º–µ–Ω–∏—Ç–µ <code>data-onauth</code> –Ω–∞ <code>data-auth-url</code>:</p>
                <pre>data-auth-url="https://quiz-code.com/api/social-auth/telegram/redirect/"</pre>
                <p>–≠—Ç–æ –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π –º–µ—Ç–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç Same-Origin Policy.</p>
            </div>
            
            <div class="solution">
                <h4>3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ</h4>
                <p>–î–æ–±–∞–≤—å—Ç–µ –≤ Django settings:</p>
                <pre>CORS_ALLOWED_ORIGINS = [
    "https://oauth.telegram.org",
    "https://telegram.org"
]

CORS_ALLOW_CREDENTIALS = True</pre>
            </div>
            
            <div class="solution">
                <h4>4. –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞</h4>
                <p>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∞—à ngrok –¥–æ–º–µ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç:</p>
                <pre>ngrok http 8001 --domain=quiz-code.com</pre>
                <p>–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –¥–æ–º–µ–Ω ngrok —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º SSL.</p>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let diagnosticProgress = 0;
        let debugLog = [];
        
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function handleTelegramAuth(user) {
            console.log('üîê Telegram auth callback called:', user);
            console.log('üîç User object:', JSON.stringify(user, null, 2));
            addDebugInfo('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!');
            displaySuccess('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram —É—Å–ø–µ—à–Ω–∞!');
            displayUserInfo(user);
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            sendToServer(user);
        }
        
        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ
        window.handleTelegramAuth = handleTelegramAuth;
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞
        if (window.TelegramLoginWidget) {
            window.TelegramLoginWidget.dataOnauth = handleTelegramAuth;
        }
        
        // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± - –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        window.addEventListener('message', function(event) {
            if (event.origin === 'https://oauth.telegram.org' && event.data && event.data.user) {
                console.log('üîê –ü–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç Telegram:', event.data);
                handleTelegramAuth(event.data.user);
            }
        });
        
        // –û—Ç–ª–∞–¥–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–∂–µ—Ç–∞
        window.addEventListener('load', function() {
            console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏–¥–∂–µ—Ç Telegram...');
            const widget = document.querySelector('[data-telegram-login]');
            console.log('üîç –í–∏–¥–∂–µ—Ç –Ω–∞–π–¥–µ–Ω:', widget);
            if (widget) {
                console.log('üîç –ê—Ç—Ä–∏–±—É—Ç—ã –≤–∏–¥–∂–µ—Ç–∞:', {
                    'data-telegram-login': widget.getAttribute('data-telegram-login'),
                    'data-onauth': widget.getAttribute('data-onauth'),
                    'data-auth-url': widget.getAttribute('data-auth-url'),
                    'data-origin': widget.getAttribute('data-origin')
                });
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞
            console.log('üîç handleTelegramAuth –¥–æ—Å—Ç—É–ø–Ω–∞:', typeof window.handleTelegramAuth);
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
            setTimeout(function() {
                if (window.TelegramLoginWidget) {
                    window.TelegramLoginWidget.dataOnauth = handleTelegramAuth;
                    console.log('üîß –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è TelegramLoginWidget');
                }
                
                // –¢–∞–∫–∂–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                window.onTelegramAuth = handleTelegramAuth;
                console.log('üîß –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ onTelegramAuth —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
            }, 1000);
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ postMessage –¥–ª—è iframe
        window.addEventListener('message', function(event) {
            console.log('üì® PostMessage received:', event);
            addDebugInfo('üì® PostMessage –æ—Ç: ' + event.origin);
            addDebugInfo('üì® –î–∞–Ω–Ω—ã–µ: ' + JSON.stringify(event.data));
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫
            if (event.origin !== 'https://oauth.telegram.org') {
                addDebugInfo('‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞');
                return;
            }
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π
            if (event.data.type === 'telegram-auth') {
                handleTelegramAuth(event.data.user);
            } else if (event.data.user) {
                // –ü—Ä—è–º–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                handleTelegramAuth(event.data.user);
            } else if (event.data && typeof event.data === 'object') {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ª—é–±–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
                const userData = event.data.user || event.data;
                if (userData && userData.id && userData.first_name) {
                    console.log('üîê –ù–∞–π–¥–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏:', userData);
                    handleTelegramAuth(userData);
                }
            }
        }, false);
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        function sendToServer(user) {
            addDebugInfo('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä...');
            
            fetch('/api/social-auth/telegram/auth/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(user)
            })
            .then(response => response.json())
            .then(data => {
                addDebugInfo('üì• –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ' + JSON.stringify(data));
                if (data.success) {
                    displaySuccess('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä!');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                } else {
                    displayError('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            })
            .catch(error => {
                addDebugInfo('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error);
                displayError('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä: ' + error);
            });
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
        function displaySuccess(message) {
            const status = document.getElementById('status');
            status.className = 'status success';
            status.textContent = '‚úÖ ' + message;
        }
        
        function displayError(message) {
            const status = document.getElementById('status');
            status.className = 'status error';
            status.textContent = '‚ùå ' + message;
        }
        
        function displayInfo(message) {
            const status = document.getElementById('status');
            status.className = 'status info';
            status.textContent = '‚ÑπÔ∏è ' + message;
        }
        
        function displayWarning(message) {
            const status = document.getElementById('status');
            status.className = 'status warning';
            status.textContent = '‚ö†Ô∏è ' + message;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        function displayUserInfo(user) {
            const userInfo = document.getElementById('user-info');
            const userDetails = document.getElementById('user-details');
            
            userDetails.innerHTML = `
                <p><strong>üÜî ID:</strong> ${user.id}</p>
                <p><strong>üë§ –ò–º—è:</strong> ${user.first_name}</p>
                <p><strong>üìù –§–∞–º–∏–ª–∏—è:</strong> ${user.last_name || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                <p><strong>üîó Username:</strong> ${user.username || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                <p><strong>üì∏ –§–æ—Ç–æ:</strong> ${user.photo_url ? '<img src="' + user.photo_url + '" alt="Avatar" style="width: 50px; height: 50px; border-radius: 50%;">' : '–ù–µ—Ç —Ñ–æ—Ç–æ'}</p>
                <p><strong>üìÖ Auth Date:</strong> ${new Date(user.auth_date * 1000).toLocaleString()}</p>
                <p><strong>üîê Hash:</strong> ${user.hash}</p>
            `;
            
            userInfo.style.display = 'block';
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        function addDebugInfo(message) {
            const debug = document.getElementById('debug');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLog.push(logEntry);
            debug.textContent = debugLog.join('\n');
            debug.scrollTop = debug.scrollHeight;
            console.log(logEntry);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        function clearDebug() {
            debugLog = [];
            document.getElementById('debug').textContent = '';
            addDebugInfo('üóëÔ∏è –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—á–∏—â–µ–Ω–∞');
        }
        
        // –°–∏—Å—Ç–µ–º–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
        function runSystemDiagnostic() {
            const systemInfo = document.getElementById('system-info');
            
            const checks = [
                {
                    name: 'URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã',
                    value: window.location.href,
                    status: 'info'
                },
                {
                    name: 'User Agent',
                    value: navigator.userAgent.substring(0, 50) + '...',
                    status: 'info'
                },
                {
                    name: '–ü–æ–¥–¥–µ—Ä–∂–∫–∞ postMessage',
                    value: !!window.postMessage,
                    status: !!window.postMessage ? 'success' : 'error'
                },
                {
                    name: '–ü–æ–¥–¥–µ—Ä–∂–∫–∞ addEventListener',
                    value: !!window.addEventListener,
                    status: !!window.addEventListener ? 'success' : 'error'
                },
                {
                    name: 'HTTPS —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ',
                    value: window.location.protocol === 'https:',
                    status: window.location.protocol === 'https:' ? 'success' : 'warning'
                },
                {
                    name: '–î–æ–º–µ–Ω ngrok',
                    value: window.location.hostname.includes('ngrok'),
                    status: window.location.hostname.includes('ngrok') ? 'success' : 'warning'
                }
            ];
            
            systemInfo.innerHTML = checks.map(check => `
                <div class="check-item ${check.status}">
                    <span class="icon">${check.status === 'success' ? '‚úÖ' : check.status === 'error' ? '‚ùå' : check.status === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span>
                    <span><strong>${check.name}:</strong> ${check.value}</span>
                </div>
            `).join('');
        }
        
        // –°–µ—Ç–µ–≤–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
        function runNetworkDiagnostic() {
            const networkInfo = document.getElementById('network-info');
            
            const checks = [
                {
                    name: '–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API',
                    value: '–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è...',
                    status: 'info'
                },
                {
                    name: 'CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏',
                    value: '–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è...',
                    status: 'info'
                },
                {
                    name: 'SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç',
                    value: window.location.protocol === 'https:' ? '–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π' : '–ù–µ HTTPS',
                    status: window.location.protocol === 'https:' ? 'success' : 'warning'
                }
            ];
            
            networkInfo.innerHTML = checks.map(check => `
                <div class="check-item ${check.status}">
                    <span class="icon">${check.status === 'success' ? '‚úÖ' : check.status === 'error' ? '‚ùå' : check.status === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span>
                    <span><strong>${check.name}:</strong> ${check.value}</span>
                </div>
            `).join('');
        }
        
        // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤–∏–¥–∂–µ—Ç–∞
        function runWidgetDiagnostic() {
            const widgetInfo = document.getElementById('widget-info');
            
            const checks = [
                {
                    name: 'Telegram Widget JS',
                    value: typeof window.TelegramLoginWidget !== 'undefined' ? '–ó–∞–≥—Ä—É–∂–µ–Ω' : '–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω',
                    status: typeof window.TelegramLoginWidget !== 'undefined' ? 'success' : 'error'
                },
                {
                    name: '–ò–º—è –±–æ—Ç–∞',
                    value: 'mr_proger_bot',
                    status: 'info'
                },
                {
                    name: '–î–æ–º–µ–Ω –≤ –≤–∏–¥–∂–µ—Ç–µ',
                    value: 'quiz-code.com',
                    status: 'info'
                },
                {
                    name: '–§—É–Ω–∫—Ü–∏—è handleTelegramAuth',
                    value: typeof window.handleTelegramAuth,
                    status: typeof window.handleTelegramAuth === 'function' ? 'success' : 'error'
                },
                {
                    name: '–û–±—Ä–∞–±–æ—Ç—á–∏–∫ postMessage',
                    value: '–ù–∞—Å—Ç—Ä–æ–µ–Ω',
                    status: 'success'
                }
            ];
            
            widgetInfo.innerHTML = checks.map(check => `
                <div class="check-item ${check.status}">
                    <span class="icon">${check.status === 'success' ? '‚úÖ' : check.status === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
                    <span><strong>${check.name}:</strong> ${check.value}</span>
                </div>
            `).join('');
        }
        
        // –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
        function runFullDiagnostic() {
            addDebugInfo('üîç –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...');
            displayInfo('–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã...');
            
            diagnosticProgress = 0;
            updateProgress();
            
            setTimeout(() => {
                runSystemDiagnostic();
                diagnosticProgress = 33;
                updateProgress();
            }, 500);
            
            setTimeout(() => {
                runNetworkDiagnostic();
                diagnosticProgress = 66;
                updateProgress();
            }, 1000);
            
            setTimeout(() => {
                runWidgetDiagnostic();
                diagnosticProgress = 100;
                updateProgress();
                displaySuccess('–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
                addDebugInfo('‚úÖ –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
            }, 1500);
        }
        
        function updateProgress() {
            const progressBar = document.querySelector('.progress-fill');
            if (progressBar) {
                progressBar.style.width = diagnosticProgress + '%';
            }
        }
        
        // –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function testTelegramAuth() {
            addDebugInfo('üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...');
            
            const testUser = {
                id: 123456789,
                first_name: 'Test',
                last_name: 'User',
                username: 'testuser',
                photo_url: 'https://via.placeholder.com/150',
                auth_date: Math.floor(Date.now() / 1000),
                hash: 'test_hash'
            };
            
            handleTelegramAuth(testUser);
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ BotFather
        function checkBotFatherSettings() {
            addDebugInfo('ü§ñ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ BotFather...');
            displayInfo('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ BotFather:');
            
            const instructions = '1. –û—Ç–∫—Ä–æ–π—Ç–µ @BotFather –≤ Telegram\n' +
                               '2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É: /setdomain\n' +
                               '3. –í—ã–±–µ—Ä–∏—Ç–µ –±–æ—Ç–∞: mr_proger_bot\n' +
                               '4. –í–≤–µ–¥–∏—Ç–µ –¥–æ–º–µ–Ω: quiz-code.com\n' +
                               '5. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–æ–º–µ–Ω –±–µ–∑ https:// –∏ –±–µ–∑ —Å–ª–µ—à–∞ –≤ –∫–æ–Ω—Ü–µ\n\n' +
                               '–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: quiz-code.com\n' +
                               '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: https://quiz-code.com/';
            
            addDebugInfo(instructions);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ PostMessage
        function handlePostMessageAuth(user) {
            window.parent.postMessage({type: 'telegram-auth', user: user}, '*');
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–¥–∂–µ—Ç–æ–≤
        function initWidgetVariants() {
            // –í–∞—Ä–∏–∞–Ω—Ç 1: Callback
            const callbackWidget = '&lt;script async src="https://telegram.org/js/telegram-widget.js?22" data-telegram-login="mr_proger_bot" data-size="large" data-userpic="true" data-request-access="write" data-lang="ru" data-onauth="handleTelegramAuth"&gt;&lt;/script&gt;';
            
            // –í–∞—Ä–∏–∞–Ω—Ç 2: Redirect
            const redirectWidget = '&lt;script async src="https://telegram.org/js/telegram-widget.js?22" data-telegram-login="mr_proger_bot" data-size="large" data-userpic="true" data-request-access="write" data-lang="ru" data-auth-url="https://quiz-code.com/api/social-auth/telegram/redirect/"&gt;&lt;/script&gt;';
            
            // –í–∞—Ä–∏–∞–Ω—Ç 3: PostMessage
            const postMessageWidget = '&lt;script async src="https://telegram.org/js/telegram-widget.js?22" data-telegram-login="mr_proger_bot" data-size="large" data-userpic="true" data-request-access="write" data-lang="ru" data-onauth="handlePostMessageAuth"&gt;&lt;/script&gt;';
            
            document.getElementById('widget-callback').innerHTML = '<pre>' + callbackWidget + '</pre>';
            document.getElementById('widget-redirect').innerHTML = '<pre>' + redirectWidget + '</pre>';
            document.getElementById('widget-postmessage').innerHTML = '<pre>' + postMessageWidget + '</pre>';
        }
        
        // –§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ –≤–∏–¥–∂–µ—Ç–∞
        function copyWidgetCode(type) {
            let code = '';
            
            switch(type) {
                case 'callback':
                    code = '&lt;script async src="https://telegram.org/js/telegram-widget.js?22" data-telegram-login="mr_proger_bot" data-size="large" data-userpic="true" data-request-access="write" data-lang="ru" data-onauth="handleTelegramAuth"&gt;&lt;/script&gt;';
                    break;
                case 'redirect':
                    code = '&lt;script async src="https://telegram.org/js/telegram-widget.js?22" data-telegram-login="mr_proger_bot" data-size="large" data-userpic="true" data-request-access="write" data-lang="ru" data-auth-url="https://quiz-code.com/api/social-auth/telegram/redirect/"&gt;&lt;/script&gt;';
                    break;
                case 'postmessage':
                    code = '&lt;script async src="https://telegram.org/js/telegram-widget.js?22" data-telegram-login="mr_proger_bot" data-size="large" data-userpic="true" data-request-access="write" data-lang="ru" data-onauth="handlePostMessageAuth"&gt;&lt;/script&gt;';
                    break;
            }
            
            navigator.clipboard.writeText(code).then(() => {
                addDebugInfo('üìã –ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
                displaySuccess('–ö–æ–¥ –≤–∏–¥–∂–µ—Ç–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
            }).catch(err => {
                addDebugInfo('‚ùå –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ' + err);
                displayError('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞');
            });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            addDebugInfo('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            initWidgetVariants();
            runSystemDiagnostic();
            displayInfo('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ');
        });
        
        // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏
        window.handleTelegramAuth = handleTelegramAuth;
        window.runFullDiagnostic = runFullDiagnostic;
        window.testTelegramAuth = testTelegramAuth;
        window.checkBotFatherSettings = checkBotFatherSettings;
        window.clearDebug = clearDebug;
        window.copyWidgetCode = copyWidgetCode;
    </script>
</body>
</html>