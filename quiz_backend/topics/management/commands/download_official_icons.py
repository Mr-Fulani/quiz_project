import os
import requests
import time
from django.core.management.base import BaseCommand
from django.conf import settings
from topics.models import Topic
try:
    import cairosvg
    CAIROSVG_AVAILABLE = True
except ImportError:
    CAIROSVG_AVAILABLE = False

class Command(BaseCommand):
    help = '–°–∫–∞—á–∏–≤–∞–µ—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ PNG –∏–∫–æ–Ω–∫–∏ –¥–ª—è –≤—Å–µ—Ö —Ç–µ–º'
    
    def add_arguments(self, parser):
        parser.add_argument(
            '--topics',
            nargs='+',
            help='–°–ø–∏—Å–æ–∫ —Ç–µ–º –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏–∫–æ–Ω–æ–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—Å–µ)',
        )
        parser.add_argument(
            '--delay',
            type=int,
            default=2,
            help='–ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 2)',
        )

    def handle(self, *args, **options):
        self.stdout.write("üé® –ù–∞—á–∏–Ω–∞—é —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö PNG –∏–∫–æ–Ω–æ–∫...")
        
        # –ü–∞–ø–∫–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∫–æ–Ω–æ–∫
        icons_dir = os.path.join(settings.BASE_DIR, 'static', 'blog', 'images', 'icons')
        os.makedirs(icons_dir, exist_ok=True)
        
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–º—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
        if options['topics']:
            topics = Topic.objects.filter(name__in=options['topics'])
        else:
            topics = Topic.objects.all()
        
        self.stdout.write(f"üìö –ù–∞–π–¥–µ–Ω–æ {topics.count()} —Ç–µ–º –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏")
        
        downloaded_count = 0
        skipped_count = 0
        error_count = 0
        
        for i, topic in enumerate(topics):
            self.stdout.write(f"\nüîç –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ç–µ–º—É: {topic.name}")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ PNG –∏–∫–æ–Ω–∫–∞
            png_filename = f"{topic.name.lower().replace(' ', '-').replace('.', '').replace('#', 'sharp')}-icon.png"
            png_path = os.path.join(icons_dir, png_filename)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è PNG –∏–∫–æ–Ω–∫–∞
            if os.path.exists(png_path):
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ - –µ—Å–ª–∏ –±–æ–ª—å—à–µ 1000 –±–∞–π—Ç, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —ç—Ç–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –∏–∫–æ–Ω–∫–∞
                file_size = os.path.getsize(png_path)
                if file_size > 1000:
                    self.stdout.write(f"  ‚úÖ –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è PNG –∏–∫–æ–Ω–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: {png_filename} ({file_size} –±–∞–π—Ç)")
                    skipped_count += 1
                    continue
                else:
                    self.stdout.write(f"  üîÑ –ó–∞–º–µ–Ω—è—é —Å–∞–º–æ–¥–µ–ª—å–Ω—É—é/–ø—É—Å—Ç—É—é –∏–∫–æ–Ω–∫—É –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—É—é: {png_filename} ({file_size} –±–∞–π—Ç)")
                    os.remove(png_path)  # –£–¥–∞–ª—è–µ–º —Å–∞–º–æ–¥–µ–ª—å–Ω—É—é/–ø—É—Å—Ç—É—é –∏–∫–æ–Ω–∫—É
            
            # –°–∫–∞—á–∏–≤–∞–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—É—é –∏–∫–æ–Ω–∫—É
            success = self.download_official_icon(topic.name, png_path)
            
            if success:
                # –û–±–Ω–æ–≤–ª—è–µ–º –ø—É—Ç—å –∫ –∏–∫–æ–Ω–∫–µ –≤ –ë–î
                topic.icon = f'/static/blog/images/icons/{png_filename}'
                topic.save()
                self.stdout.write(f"  ‚úÖ –°–∫–∞—á–∞–Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è PNG –∏–∫–æ–Ω–∫–∞: {png_filename}")
                downloaded_count += 1
            else:
                self.stdout.write(f"  ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –∏–∫–æ–Ω–∫—É –¥–ª—è: {topic.name}")
                error_count += 1
            
            # –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
            if i < topics.count() - 1:  # –ù–µ –∂–¥–µ–º –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ
                time.sleep(options['delay'])
        
        self.stdout.write(f"\nüìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
        self.stdout.write(f"  - –í—Å–µ–≥–æ —Ç–µ–º: {topics.count()}")
        self.stdout.write(f"  - –°–∫–∞—á–∞–Ω–æ –∏–∫–æ–Ω–æ–∫: {downloaded_count}")
        self.stdout.write(f"  - –ü—Ä–æ–ø—É—â–µ–Ω–æ: {skipped_count}")
        self.stdout.write(f"  - –û—à–∏–±–æ–∫: {error_count}")
        
        self.stdout.write(self.style.SUCCESS("\n‚úÖ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö –∏–∫–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"))

    def download_official_icon(self, topic_name, output_path):
        """–°–∫–∞—á–∏–≤–∞–µ—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—É—é PNG –∏–∫–æ–Ω–∫—É –¥–ª—è —Ç–µ–º—ã"""
        
        # –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ URL –¥–ª—è –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π (–∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç—ã–µ –∏ –Ω–∞–¥–µ–∂–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏)
        official_urls = {
            'Python': 'https://www.python.org/static/img/python-logo.png',
            'JavaScript': 'https://upload.wikimedia.org/wikipedia/commons/6/6a/JavaScript-logo.png',
            'React': 'https://upload.wikimedia.org/wikipedia/commons/a/a7/React-icon.svg',
            'Node.js': 'https://nodejs.org/static/images/logo.png',
            'Vue.js': 'https://vuejs.org/images/logo.png',
            'Angular': 'https://angular.io/assets/images/logos/angular/angular.png',
            'TypeScript': 'https://upload.wikimedia.org/wikipedia/commons/4/4c/Typescript_logo_2020.svg',
            'PHP': 'https://www.php.net/images/logos/php-logo-white.png',
            'Java': 'https://www.java.com/assets/images/java-logo-icon.png',
            'C++': 'https://upload.wikimedia.org/wikipedia/commons/1/18/ISO_C%2B%2B_Logo.svg',
            'C#': 'https://upload.wikimedia.org/wikipedia/commons/4/4f/Csharp_Logo.png',
            'Ruby': 'https://www.ruby-lang.org/images/logo.png',
            'Go': 'https://go.dev/blog/go-brand/Go-Logo/PNG/Go-Logo_Blue.png',
            'Rust': 'https://www.rust-lang.org/logos/rust-logo-blk.png',
            'Swift': 'https://developer.apple.com/assets/elements/icons/swift/swift-64x64.png',
            'Kotlin': 'https://kotlinlang.org/assets/images/open-graph/kotlin_250x250.png',
            'Scala': 'https://www.scala-lang.org/resources/img/scala-logo.png',
            'R': 'https://www.r-project.org/Rlogo.png',
            'MATLAB': 'https://upload.wikimedia.org/wikipedia/commons/2/21/Matlab_Logo.png',
            'Julia': 'https://julialang.org/assets/img/logos/logo-square.png',
            'HTML': 'https://upload.wikimedia.org/wikipedia/commons/6/61/HTML5_logo_and_wordmark.svg',
            'CSS': 'https://upload.wikimedia.org/wikipedia/commons/d/d5/CSS3_logo_and_wordmark.svg',
            'Sass': 'https://sass-lang.com/assets/img/logos/logo-b6e1ef6e.svg',
            'Less': 'https://lesscss.org/public/img/less_logo.png',
            'Bootstrap': 'https://getbootstrap.com/docs/5.3/assets/brand/bootstrap-logo-shadow.png',
            'Tailwind CSS': 'https://tailwindcss.com/_next/static/media/social-square.b622e290.jpg',
            'Material-UI': 'https://mui.com/static/logo.png',
            'Redux': 'https://redux.js.org/img/redux.svg',
            'Vuex': 'https://vuex.vuejs.org/logo.png',
            'MobX': 'https://mobx.js.org/img/mobx.png',
            'GraphQL': 'https://graphql.org/img/logo.png',
            'REST API': 'https://upload.wikimedia.org/wikipedia/commons/b/b6/Rest_api_logo.png',
            'MongoDB': 'https://www.mongodb.com/assets/images/global/leaf.png',
            'PostgreSQL': 'https://www.postgresql.org/media/img/about/press/elephant.png',
            'MySQL': 'https://www.mysql.com/common/logos/logo-mysql-170x115.png',
            'Redis': 'https://redis.io/images/redis-white.png',
            'Elasticsearch': 'https://www.elastic.co/assets/blt0f7538f490728e20/logo-elastic-search-color-64-v2.png',
            'AWS': 'https://d0.awsstatic.com/logos/powered-by-aws.png',
            'Azure': 'https://azure.microsoft.com/sv-se/assets/brand/azure-icon-512x512.png',
            'Google Cloud': 'https://cloud.google.com/_static/cloud/images/social-icon-google-cloud-1200-630.png',
            'Heroku': 'https://www.heroku.com/assets/logos/heroku-logotype-vertical-purple-2021.png',
            'Kubernetes': 'https://kubernetes.io/images/favicon.png',
            'Jenkins': 'https://www.jenkins.io/images/logos/jenkins/jenkins.png',
            'GitLab CI': 'https://about.gitlab.com/images/press/press-kit-icon.png',
            'GitHub Actions': 'https://github.githubassets.com/images/modules/site/features/actions-icon-64x64.png',
            'Jest': 'https://jestjs.io/img/jest-logo.png',
            'Cypress': 'https://www.cypress.io/img/logo/cypress-logo-dark.png',
            'Selenium': 'https://www.selenium.dev/images/selenium_logo_square_green.png',
            'Postman': 'https://www.postman.com/_assets/logos/postman-logo-icon-orange.png',
            'Insomnia': 'https://insomnia.rest/images/insomnia-logo.png',
            'Figma': 'https://www.figma.com/static/images/og-image.png',
            'Adobe XD': 'https://www.adobe.com/content/dam/cc/icons/xd.svg',
            'Sketch': 'https://www.sketch.com/images/press/sketch-logo-square.png',
            'Django': 'https://static.djangoproject.com/img/logos/django-logo-positive.png',
            'Docker': 'https://www.docker.com/wp-content/uploads/2022/03/Moby-logo.png',
            'Git': 'https://git-scm.com/images/logos/downloads/Git-Icon-1788C.png',
            'Golang': 'https://go.dev/blog/go-brand/Go-Logo/PNG/Go-Logo_Blue.png',
            'SQL': 'https://upload.wikimedia.org/wikipedia/commons/8/87/Sql_data_base_with_logo.png',
        }
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π URL –¥–ª—è —Ç–µ–º—ã
        if topic_name in official_urls:
            url = official_urls[topic_name]
            try:
                response = requests.get(url, stream=True, timeout=15)
                response.raise_for_status()
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                content_type = response.headers.get('Content-Type', '')
                if 'image/svg' in content_type or url.endswith('.svg'):
                    # –ï—Å–ª–∏ —ç—Ç–æ SVG, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ PNG
                    if CAIROSVG_AVAILABLE:
                        try:
                            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º SVG –≤ PNG
                            png_data = cairosvg.svg2png(bytestring=response.content, output_width=64, output_height=64)
                            with open(output_path, 'wb') as f:
                                f.write(png_data)
                        except Exception as e:
                            self.stdout.write(f"    ‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ SVG: {e}")
                            return False
                    else:
                        self.stdout.write(f"    ‚ö†Ô∏è  cairosvg –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞—é SVG –¥–ª—è {topic_name}")
                        return False
                else:
                    with open(output_path, 'wb') as f:
                        for chunk in response.iter_content(chunk_size=8192):
                            f.write(chunk)
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª —Å–∫–∞—á–∞–ª—Å—è –∏ –Ω–µ –ø—É—Å—Ç–æ–π
                if os.path.exists(output_path) and os.path.getsize(output_path) > 100:  # –ú–∏–Ω–∏–º—É–º 100 –±–∞–π—Ç
                    return True
                else:
                    # –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª
                    if os.path.exists(output_path):
                        os.remove(output_path)
                        self.stdout.write(f"    ‚ö†Ô∏è  –£–¥–∞–ª–µ–Ω –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª –¥–ª—è {topic_name}")
                    
            except Exception as e:
                self.stdout.write(f"    ‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ URL: {e}")
        
        # –ï—Å–ª–∏ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π URL –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
        alternative_urls = [
            f'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/{topic_name.lower().replace(" ", "").replace(".", "").replace("#", "sharp")}/{topic_name.lower().replace(" ", "").replace(".", "").replace("#", "sharp")}-original.png',
            f'https://raw.githubusercontent.com/devicons/devicon/master/icons/{topic_name.lower().replace(" ", "").replace(".", "").replace("#", "sharp")}/{topic_name.lower().replace(" ", "").replace(".", "").replace("#", "sharp")}-original.png',
        ]
        
        for url in alternative_urls:
            try:
                response = requests.get(url, stream=True, timeout=10)
                response.raise_for_status()
                
                with open(output_path, 'wb') as f:
                    for chunk in response.iter_content(chunk_size=8192):
                        f.write(chunk)
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª —Å–∫–∞—á–∞–ª—Å—è –∏ –Ω–µ –ø—É—Å—Ç–æ–π
                if os.path.exists(output_path) and os.path.getsize(output_path) > 100:  # –ú–∏–Ω–∏–º—É–º 100 –±–∞–π—Ç
                    return True
                else:
                    # –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª
                    if os.path.exists(output_path):
                        os.remove(output_path)
                    
            except Exception:
                continue
        
        return False
