{% extends 'blog/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}Donation{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css?family=Raleway:300,400,600" rel="stylesheet">
<link rel="stylesheet" href="{% static 'donation/css/donation.css' %}">
{% endblock %}

{% block content %}
<article class="donation active" data-page="donation">
    <header>
        <h1 class="h2 article-title">Donation</h1>
    </header>
<div class="container preload">
    <div class="creditcard">
        <div class="front">
            <div id="ccsingle"></div>
            <svg version="1.1" id="cardfront" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                x="0px" y="0px" viewBox="0 0 750 471" style="enable-background:new 0 0 750 471;" xml:space="preserve">
                <g id="Front">
                    <g id="CardBackground">
                        <g id="Page-1_1_">
                            <g id="amex_1_">
                                <path id="Rectangle-1_1_" class="lightcolor grey" d="M40,0h670c22.1,0,40,17.9,40,40v391c0,22.1-17.9,40-40,40H40c-22.1,0-40-17.9-40-40V40
                        C0,17.9,17.9,0,40,0z" />
                            </g>
                        </g>
                        <path class="darkcolor greydark" d="M750,431V193.2c-217.6-57.5-556.4-13.5-750,24.9V431c0,22.1,17.9,40,40,40h670C732.1,471,750,453.1,750,431z" />
                    </g>
                    <text transform="matrix(1 0 0 1 60.106 295.0121)" id="svgnumber" class="st2 st3 st4">0123 4567 8910 1112</text>
                    <text transform="matrix(1 0 0 1 54.1064 428.1723)" id="svgname" class="st2 st5 st6">JOHN DOE</text>
                    <text transform="matrix(1 0 0 1 54.1074 389.8793)" class="st7 st5 st8">cardholder name</text>
                    <text transform="matrix(1 0 0 1 479.7754 388.8793)" class="st7 st5 st8">expiration</text>
                    <text transform="matrix(1 0 0 1 65.1054 241.5)" class="st7 st5 st8">card number</text>
                    <g>
                        <text transform="matrix(1 0 0 1 574.4219 433.8095)" id="svgexpire" class="st2 st5 st9">01/23</text>
                        <text transform="matrix(1 0 0 1 479.3848 417.0097)" class="st2 st10 st11">VALID</text>
                        <text transform="matrix(1 0 0 1 479.3848 435.6762)" class="st2 st10 st11">THRU</text>
                        <polygon class="st2" points="554.5,421 540.4,414.2 540.4,427.9 		" />
                    </g>
                    <g id="cchip">
                        <g>
                            <path class="st2" d="M168.1,143.6H82.9c-10.2,0-18.5-8.3-18.5-18.5V74.9c0-10.2,8.3-18.5,18.5-18.5h85.3
                    c10.2,0,18.5,8.3,18.5,18.5v50.2C186.6,135.3,178.3,143.6,168.1,143.6z" />
                        </g>
                        <g>
                            <g>
                                <rect x="82" y="70" class="st12" width="1.5" height="60" />
                            </g>
                            <g>
                                <rect x="167.4" y="70" class="st12" width="1.5" height="60" />
                            </g>
                            <g>
                                <path class="st12" d="M125.5,130.8c-10.2,0-18.5-8.3-18.5-18.5c0-4.6,1.7-8.9,4.7-12.3c-3-3.4-4.7-7.7-4.7-12.3
                        c0-10.2,8.3-18.5,18.5-18.5s18.5,8.3,18.5,18.5c0,4.6-1.7,8.9-4.7,12.3c3,3.4,4.7,7.7,4.7,12.3
                        C143.9,122.5,135.7,130.8,125.5,130.8z M125.5,70.8c-9.3,0-16.9,7.6-16.9,16.9c0,4.4,1.7,8.6,4.8,11.8l0.5,0.5l-0.5,0.5
                        c-3.1,3.2-4.8,7.4-4.8,11.8c0,9.3,7.6,16.9,16.9,16.9s16.9-7.6,16.9-16.9c0-4.4-1.7-8.6-4.8-11.8l-0.5-0.5l0.5-0.5
                        c3.1-3.2,4.8-7.4,4.8-11.8C142.4,78.4,134.8,70.8,125.5,70.8z" />
                            </g>
                            <g>
                                <rect x="82.8" y="82.1" class="st12" width="25.8" height="1.5" />
                            </g>
                            <g>
                                <rect x="82.8" y="117.9" class="st12" width="26.1" height="1.5" />
                            </g>
                            <g>
                                <rect x="142.4" y="82.1" class="st12" width="25.8" height="1.5" />
                            </g>
                            <g>
                                <rect x="142" y="117.9" class="st12" width="26.2" height="1.5" />
                            </g>
                        </g>
                    </g>
                </g>
                <g id="Back">
                </g>
            </svg>
        </div>
        <div class="back">
            <svg version="1.1" id="cardback" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                x="0px" y="0px" viewBox="0 0 750 471" style="enable-background:new 0 0 750 471;" xml:space="preserve">
                <g id="Front">
                    <line class="st0" x1="35.3" y1="10.4" x2="36.7" y2="11" />
                </g>
                <g id="Back">
                    <g id="Page-1_2_">
                        <g id="amex_2_">
                            <path id="Rectangle-1_2_" class="darkcolor greydark" d="M40,0h670c22.1,0,40,17.9,40,40v391c0,22.1-17.9,40-40,40H40c-22.1,0-40-17.9-40-40V40
                    C0,17.9,17.9,0,40,0z" />
                        </g>
                    </g>
                    <rect y="61.6" class="st2" width="750" height="78" />
                    <g>
                        <path class="st3" d="M701.1,249.1H48.9c-3.3,0-6-2.7-6-6v-52.5c0-3.3,2.7-6,6-6h652.1c3.3,0,6,2.7,6,6v52.5
                C707.1,246.4,704.4,249.1,701.1,249.1z" />
                        <rect x="42.9" y="198.6" class="st4" width="664.1" height="10.5" />
                        <rect x="42.9" y="224.5" class="st4" width="664.1" height="10.5" />
                        <path class="st5" d="M701.1,184.6H618h-8h-10v64.5h10h8h83.1c3.3,0,6-2.7,6-6v-52.5C707.1,187.3,704.4,184.6,701.1,184.6z" />
                    </g>
                    <text transform="matrix(1 0 0 1 621.999 227.2734)" id="svgsecurity" class="st6 st7">985</text>
                    <g class="st8">
                        <text transform="matrix(1 0 0 1 518.083 280.0879)" class="st9 st6 st10">security code</text>
                    </g>
                    <rect x="58.1" y="378.6" class="st11" width="375.5" height="13.5" />
                    <rect x="58.1" y="405.6" class="st11" width="421.7" height="13.5" />
                    <text transform="matrix(1 0 0 1 59.5073 228.6099)" id="svgnameback" class="st12 st13">John Doe</text>
                </g>
            </svg>
        </div>
    </div>
</div>
<div class="form-container">
    <div class="field-container">
        <label for="name">Name</label>
        <input id="name" maxlength="20" type="text">
    </div>
    <!-- Stripe Payment Section -->
    <div class="field-container" style="margin-bottom: 20px;">
        <label for="cardnumber">Card Number</label>
        <span id="generatecard" style="cursor: pointer; color: blue; margin-left: 10px;">generate random</span>
        <span id="show-debug" style="cursor: pointer; color: green; margin-left: 10px;">–ø–æ–∫–∞–∑–∞—Ç—å –æ—Ç–ª–∞–¥–∫—É</span>
        
        <!-- Stripe Element - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø–æ–ª–µ –≤–≤–æ–¥–∞ -->
        <div style="padding: 15px; border: 2px solid #4CAF50; border-radius: 8px; background: #f8fff8; margin-top: 10px;">
            <div style="font-weight: bold; color: #2E7D32; margin-bottom: 8px;">
                üí≥ –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã
            </div>
            <div id="card-element-visible" style="padding: 15px; border: 2px solid #007cba; border-radius: 6px; background: white; 
                                                   font-size: 16px; min-height: 50px; box-sizing: border-box;">
                <!-- Stripe Elements –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
            </div>
            <div style="font-size: 12px; color: #2E7D32; margin-top: 8px; font-weight: 500;">
                üé® –ê–Ω–∏–º–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ
            </div>
        </div>
    </div>
    
    <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∏–º–∞—Ü–∏–∏ -->
    <input id="cardnumber" type="hidden">
    <input id="expirationdate" type="hidden">  
    <input id="securitycode" type="hidden">
    
    <!-- Card Animation Display -->
    <div class="field-container" style="margin-bottom: 20px;">
        <svg id="ccicon" class="ccicon" width="750" height="471" viewBox="0 0 750 471" version="1.1" xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink">
        </svg>
    </div>
    <!-- Error Messages -->
    <div id="card-errors" role="alert" style="color: #fa755a; margin: 15px 0; text-align: center; padding: 8px; border-radius: 4px; background: #ffeaea; display: none;"></div>
    
    <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è - –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è -->
    <div id="debug-info" style="position: fixed; top: 10px; right: 10px; background: rgba(240,240,240,0.95); padding: 8px; border-radius: 4px; font-family: monospace; font-size: 10px; display: none; max-width: 300px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
        <div style="font-weight: bold; margin-bottom: 5px; color: #333;">üîß Debug</div>
        <div id="debug-content"></div>
        <button onclick="document.getElementById('debug-info').style.display='none'" style="position: absolute; top: 2px; right: 5px; border: none; background: none; font-size: 12px; cursor: pointer;">√ó</button>
    </div>
</div>

<!-- Donation Form -->
<div class="donation-form-container">
    <form method="post" class="donation-form">
        {% csrf_token %}
        <input type="hidden" name="card_name" id="hidden_card_name" value="">
        <div class="donation-fields">
            <div class="field-container">
                <label for="{{ form.amount.id_for_label }}">{{ form.amount.label }}</label>
                {{ form.amount }}
            </div>
            <div class="field-container">
                <label for="currency">{% trans "Currency" %}</label>
                <select id="currency" name="currency" class="form-control">
                    <option value="usd">USD ($)</option>
                    <option value="eur">EUR (‚Ç¨)</option>
                    <option value="rub">RUB (‚ÇΩ)</option>
                </select>
            </div>
            <div class="field-container">
                <label for="{{ form.email.id_for_label }}">{{ form.email.label }}</label>
                {{ form.email }}
            </div>
        </div>
        <button type="submit" class="donate-btn">Complete Donation</button>
    </form>
</div>

    <link rel="stylesheet" href="{% static 'donation/css/donation.css' %}">
    <script src="https://js.stripe.com/v3/"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/imask/3.4.0/imask.min.js'></script>
    <script src="{% static 'donation/js/notifications.js' %}"></script>
    <script src="{% static 'donation/js/donation.js' %}"></script>
    
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Stripe
        console.log('Template script loading...');
        console.log('Stripe publishable key:', '{{ stripe_publishable_key }}');
        
        if ('{{ stripe_publishable_key }}') {
            const stripe = Stripe('{{ stripe_publishable_key }}');
            console.log('Stripe object created:', stripe);
            
            // –°–æ–∑–¥–∞–µ–º Elements
            const elements = stripe.elements();
            
            // –°–æ–∑–¥–∞–µ–º –æ–¥–∏–Ω –æ–±—â–∏–π Card Element (–≤–∏–¥–∏–º—ã–π)
            const cardElement = elements.create('card', {
                style: {
                    base: {
                        fontSize: '16px',
                        color: '#424770',
                        fontFamily: 'Arial, sans-serif',
                        '::placeholder': { 
                            color: '#aab7c4' 
                        },
                    },
                    invalid: {
                        color: '#9e2146',
                    }
                },
                hidePostalCode: true
            });
            
            // –ú–æ–Ω—Ç–∏—Ä—É–µ–º Stripe Element –≤ –≤–∏–¥–∏–º—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            cardElement.mount('#card-element-visible');
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –∫–∞—Ä—Ç—ã –∏ –∞–Ω–∏–º–∞—Ü–∏–∏
            cardElement.on('change', (event) => {
                const displayError = document.getElementById('card-errors');
                if (event.error) {
                    displayError.textContent = event.error.message;
                    displayError.style.display = 'block';
                } else {
                    displayError.textContent = '';
                    displayError.style.display = 'none';
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Stripe
                updateCardAnimationFromStripe(event);
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ–∫—É—Å–∞ –Ω–∞ Stripe Element
            cardElement.on('focus', (event) => {
                showDebug('üéØ Focus on Stripe Element');
                // –ü—Ä–∏ —Ñ–æ–∫—É—Å–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–∏—Ü–µ–≤—É—é —Å—Ç–æ—Ä–æ–Ω—É –∫–∞—Ä—Ç—ã (–µ—Å–ª–∏ –Ω–µ –≤–≤–æ–¥–∏–º CVC)
                const creditcard = document.querySelector('.creditcard');
                if (creditcard && !isEnteringCVC) {
                    creditcard.classList.remove('flipped');
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Ç–µ—Ä–∏ —Ñ–æ–∫—É—Å–∞
            cardElement.on('blur', (event) => {
                showDebug('üëã Blur from Stripe Element');
                // –ü—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –ª–∏—Ü–µ–≤—É—é —Å—Ç–æ—Ä–æ–Ω—É
                const creditcard = document.querySelector('.creditcard');
                if (creditcard) {
                    creditcard.classList.remove('flipped');
                }
                isEnteringCVC = false;
            });
            
            // –ü–µ—Ä–µ–¥–∞–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            window.stripeInstance = stripe;
            window.cardElement = cardElement;
            
                         // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã
             initCardAnimation();
             
             // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª—É—á–∞–π–Ω–æ–π –∫–∞—Ä—Ç—ã
             initGenerateCard();
             
             // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–ª–∞–¥–∫–∏
             initDebugButton();
        } else {
            console.error('No Stripe publishable key provided');
        }
        
                                 // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–Ω–∏–º–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã
        function initCardAnimation() {
            const nameField = document.getElementById('name');
            
            if (!nameField) return;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
            nameField.addEventListener('input', function() {
                const name = this.value || 'JOHN DOE';
                const svgname = document.getElementById('svgname');
                const svgnameback = document.getElementById('svgnameback');
                if (svgname) svgname.innerHTML = name.toUpperCase();
                if (svgnameback) svgnameback.innerHTML = name;
            });
            
            // –°–æ–±—ã—Ç–∏—è —Ñ–æ–∫—É—Å–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –∫–∞—Ä—Ç—ã
            nameField.addEventListener('focus', function() {
                document.querySelector('.creditcard')?.classList.remove('flipped');
            });
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            updateCardDisplay('‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢', '‚Ä¢‚Ä¢/‚Ä¢‚Ä¢', '‚Ä¢‚Ä¢‚Ä¢');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è IMask –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π (–µ—Å–ª–∏ –æ–Ω–∏ –≤–∏–¥–∏–º—ã)
            initAnimationFieldMasks();
        }
        
        // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ IMask –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π
        function initAnimationFieldMasks() {
            const cardnumberField = document.getElementById('cardnumber');
            const expirationdateField = document.getElementById('expirationdate');
            const securitycodeField = document.getElementById('securitycode');
            
            if (!cardnumberField) {
                showDebug('–ê–Ω–∏–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–æ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                return;
            }
            
            if (cardnumberField.type === 'hidden') {
                showDebug('‚úÖ –ê–Ω–∏–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–æ–ª—è —Å–∫—Ä—ã—Ç—ã - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ Stripe –¥–ª—è –≤–≤–æ–¥–∞');
                return;
            }
            
            showDebug('–ê–Ω–∏–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–æ–ª—è –≤–∏–¥–∏–º—ã, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º IMask');
            
            // –ï—Å–ª–∏ –ø–æ–ª—è –≤–∏–¥–∏–º—ã, –ø—Ä–∏–º–µ–Ω—è–µ–º IMask –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ
            if (window.IMask && cardnumberField) {
                const cardnumber_mask = new IMask(cardnumberField, {
                    mask: [
                        {
                            mask: '0000 000000 00000',
                            regex: '^3[47]\\d{0,13}',
                            cardtype: 'amex'
                        },
                        {
                            mask: '0000 0000 0000 0000',
                            regex: '^(?:6011|65\\d{0,2}|64[4-9]\\d?)\\d{0,12}',
                            cardtype: 'discover'
                        },
                        {
                            mask: '0000 000000 0000',
                            regex: '^3(?:0([0-5]|9)|[689]\\d?)\\d{0,11}',
                            cardtype: 'diners'
                        },
                        {
                            mask: '0000 0000 0000 0000',
                            regex: '^(5[1-5]\\d{0,2}|22[2-9]\\d{0,1}|2[3-7]\\d{0,2})\\d{0,12}',
                            cardtype: 'mastercard'
                        },
                        {
                            mask: '0000 000000 00000',
                            regex: '^(?:2131|1800)\\d{0,11}',
                            cardtype: 'jcb15'
                        },
                        {
                            mask: '0000 0000 0000 0000',
                            regex: '^(?:35\\d{0,2})\\d{0,12}',
                            cardtype: 'jcb'
                        },
                        {
                            mask: '0000 0000 0000 0000',
                            regex: '^(?:5[0678]\\d{0,2}|6304|67\\d{0,2})\\d{0,12}',
                            cardtype: 'maestro'
                        },
                        {
                            mask: '0000 0000 0000 0000',
                            regex: '^4\\d{0,15}',
                            cardtype: 'visa'
                        },
                        {
                            mask: '0000 0000 0000 0000',
                            regex: '^62\\d{0,14}',
                            cardtype: 'unionpay'
                        },
                        {
                            mask: '0000 0000 0000 0000',
                            cardtype: 'Unknown'
                        }
                    ],
                    dispatch: function (appended, dynamicMasked) {
                        var number = (dynamicMasked.value + appended).replace(/\D/g, '');
                        for (var i = 0; i < dynamicMasked.compiledMasks.length; i++) {
                            let re = new RegExp(dynamicMasked.compiledMasks[i].regex);
                            if (number.match(re) != null) {
                                return dynamicMasked.compiledMasks[i];
                            }
                        }
                    }
                });
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                cardnumber_mask.on('accept', function () {
                    const svgnumber = document.getElementById('svgnumber');
                    if (svgnumber) {
                        svgnumber.innerHTML = cardnumber_mask.value || '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                    }
                    
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∫–∞—Ä—Ç—ã
                    const cardtype = cardnumber_mask.masked.currentMask.cardtype;
                    updateCardTypeFromBrandAdvanced(cardtype);
                    showDebug('IMask detected card type: ' + cardtype);
                });
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞—Å–∫—É –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º –æ–±—ä–µ–∫—Ç–µ
                window.cardMasks = window.cardMasks || {};
                window.cardMasks.cardnumber = cardnumber_mask;
            }
            
            // Mask –¥–ª—è –¥–∞—Ç—ã –∏—Å—Ç–µ—á–µ–Ω–∏—è
            if (window.IMask && expirationdateField) {
                const expirationdate_mask = new IMask(expirationdateField, {
                    mask: 'MM{/}YY',
                    groups: {
                        YY: new IMask.MaskedPattern.Group.Range([0, 99]),
                        MM: new IMask.MaskedPattern.Group.Range([1, 12]),
                    }
                });
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞—Ç—ã –∏—Å—Ç–µ—á–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                expirationdate_mask.on('accept', function () {
                    const svgexpire = document.getElementById('svgexpire');
                    if (svgexpire) {
                        svgexpire.innerHTML = expirationdate_mask.value || '‚Ä¢‚Ä¢/‚Ä¢‚Ä¢';
                    }
                });
                
                window.cardMasks = window.cardMasks || {};
                window.cardMasks.expirationdate = expirationdate_mask;
            }
            
            // Mask –¥–ª—è –∫–æ–¥–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            if (window.IMask && securitycodeField) {
                const securitycode_mask = new IMask(securitycodeField, {
                    mask: '0000',
                });
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                securitycode_mask.on('accept', function () {
                    const svgsecurity = document.getElementById('svgsecurity');
                    if (svgsecurity) {
                        svgsecurity.innerHTML = securitycode_mask.value || '‚Ä¢‚Ä¢‚Ä¢';
                    }
                });
                
                // –°–æ–±—ã—Ç–∏—è —Ñ–æ–∫—É—Å–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–∞ –∫–∞—Ä—Ç—ã
                securitycodeField.addEventListener('focus', function() {
                    document.querySelector('.creditcard')?.classList.add('flipped');
                });
                
                securitycodeField.addEventListener('blur', function() {
                    document.querySelector('.creditcard')?.classList.remove('flipped');
                });
                
                window.cardMasks = window.cardMasks || {};
                window.cardMasks.securitycode = securitycode_mask;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ä—Ç—ã
        function updateCardDisplay(number, expiry, cvv) {
            const svgnumber = document.getElementById('svgnumber');
            const svgexpire = document.getElementById('svgexpire');
            const svgsecurity = document.getElementById('svgsecurity');
            
            if (svgnumber) svgnumber.innerHTML = number || '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            if (svgexpire) svgexpire.innerHTML = expiry || '‚Ä¢‚Ä¢/‚Ä¢‚Ä¢';
            if (svgsecurity) svgsecurity.innerHTML = cvv || '‚Ä¢‚Ä¢‚Ä¢';
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–±—ã—Ç–∏–π Stripe
        function updateCardAnimationFromStripe(event) {
            showDebug('Stripe event: ' + JSON.stringify({
                brand: event.brand,
                complete: event.complete,
                empty: event.empty,
                error: event.error ? event.error.message : null
            }));
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∏–ø –∫–∞—Ä—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ brand –æ—Ç Stripe
            if (event.brand) {
                updateCardTypeFromBrandAdvanced(event.brand);
            }
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º Stripe
            const cardnumberField = document.getElementById('cardnumber');
            const expirationdateField = document.getElementById('expirationdate');
            const securitycodeField = document.getElementById('securitycode');
            
            // –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è Stripe
            if (event.complete) {
                // –ü–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø–æ–ª–Ω–µ–Ω–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                const cardNumber = getCardNumberByBrand(event.brand);
                const formattedNumber = formatCardNumber(cardNumber);
                
                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è
                if (cardnumberField) cardnumberField.value = cardNumber.replace(/\s/g, '');
                if (expirationdateField) expirationdateField.value = '1225';
                if (securitycodeField) securitycodeField.value = '123';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                updateCardDisplay(formattedNumber, '12/25', '123');
                showDebug('‚úÖ Stripe complete - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: ' + formattedNumber);
                
                // –£–±–∏—Ä–∞–µ–º –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç –∫–∞—Ä—Ç—ã
                const creditcard = document.querySelector('.creditcard');
                if (creditcard) creditcard.classList.remove('flipped');
                
            } else if (event.empty) {
                // –ü—É—Å—Ç–æ–µ –ø–æ–ª–µ - –æ—á–∏—â–∞–µ–º –≤—Å–µ
                if (cardnumberField) cardnumberField.value = '';
                if (expirationdateField) expirationdateField.value = '';
                if (securitycodeField) securitycodeField.value = '';
                
                updateCardDisplay('‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢', '‚Ä¢‚Ä¢/‚Ä¢‚Ä¢', '‚Ä¢‚Ä¢‚Ä¢');
                showDebug('‚≠ï Stripe empty - –æ—á–∏—â–µ–Ω–æ');
                
                // –£–±–∏—Ä–∞–µ–º –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç –∫–∞—Ä—Ç—ã
                const creditcard = document.querySelector('.creditcard');
                if (creditcard) creditcard.classList.remove('flipped');
                
            } else {
                // –ß–∞—Å—Ç–∏—á–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                if (event.brand) {
                    const partialNumber = getPartialCardNumber(event.brand);
                    const cardNumber = getCardNumberByBrand(event.brand);
                    
                    // –ß–∞—Å—Ç–∏—á–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º
                    if (cardnumberField) cardnumberField.value = cardNumber.replace(/\s/g, '').substring(0, 4);
                    
                    updateCardDisplay(partialNumber, '‚Ä¢‚Ä¢/‚Ä¢‚Ä¢', '‚Ä¢‚Ä¢‚Ä¢');
                    showDebug('‚è≥ Stripe partial - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º: ' + partialNumber);
                }
            }
        }
        
        // –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –∫–∞—Ä—Ç—ã —Å –ø–æ–ª–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π SVG
        function updateCardTypeFromBrandAdvanced(brand) {
            const ccicon = document.getElementById('ccicon');
            const ccsingle = document.getElementById('ccsingle');
            
            if (!ccicon || !ccsingle) return;
            
            // Define card brand SVG icons
            const cardIcons = {
                visa: `<g><rect fill="#1434CB" x="0" y="0" width="750" height="471" rx="40"></rect><path fill="white" d="M278.198,334.228l33.36-195.763h53.358l-33.384,195.763H278.198z M524.307,142.687c-10.57-3.966-27.135-8.222-47.822-8.222c-52.725,0-89.863,26.551-90.18,64.604c-0.297,28.129,26.514,43.821,46.754,53.185c20.77,9.597,27.752,15.716,27.652,24.283c-0.133,13.123-16.586,19.116-31.924,19.116c-21.355,0-32.701-2.967-50.225-10.274l-6.877-3.112l-7.488,43.823c12.463,5.466,35.508,10.199,59.438,10.445c56.09,0,92.502-26.248,92.916-66.884c0.199-22.27-14.016-39.216-44.801-53.188c-18.65-9.056-30.072-15.099-29.951-24.269c0-8.137,9.668-16.838,30.559-16.838c17.447-0.271,30.088,3.534,39.936,7.5l4.781,2.259L524.307,142.687 M661.615,138.464h-41.23c-12.773,0-22.332,3.486-27.941,16.234l-79.244,179.402h56.031c0,0,9.16-24.121,11.232-29.418c6.123,0,60.555,0.084,68.336,0.084c1.596,6.854,6.492,29.334,6.492,29.334h49.512L661.615,138.464z M596.198,264.872c4.414-11.279,21.26-54.724,21.26-54.724c-0.314,0.521,4.381-11.334,7.074-18.684l3.607,16.878c0,0,10.217,46.729,12.352,56.527h-44.293V264.872z M232.903,138.464L180.664,271.96l-5.565-27.129c-9.726-31.274-40.025-65.157-73.898-82.12l47.767,171.204l56.455-0.064l84.004-195.386L232.903,138.464 M131.92,138.464H45.879l-0.682,4.073c66.939,16.204,111.232,55.363,129.618,102.415l-18.709-89.96C152.877,142.596,143.509,138.896,131.92,138.464"></path></g>`,
                mastercard: `<g><rect fill="#000000" x="0" y="0" width="750" height="471" rx="40"></rect><rect fill="#FF5F00" x="170.55" y="32.39" width="143.72" height="234.42"></rect><path fill="#EB001B" d="M185.05,149.6c0.06-45.687,20.96-88.862,56.79-117.21c-61.128-48.07-148.928-41.084-201.687,16.048c-52.759,57.132-52.759,145.225,0,202.357c52.759,57.133,140.559,64.119,201.687,16.048C206.01,238.462,185.11,195.287,185.05,149.6z"></path><path fill="#F79E1B" d="M483.26,149.6c0.041,57.047-32.504,109.106-83.806,134.057C348.154,308.607,287.109,302.064,242.26,266.81c35.839-28.31,56.742-71.49,56.742-117.21s-20.902-88.9-56.742-117.21c44.849-35.254,105.894-41.797,157.195-16.846C450.756,40.494,483.301,92.553,483.26,149.6z"></path></g>`,
                amex: `<g><rect fill="#2557D6" x="0" y="0" width="750" height="471" rx="40"></rect><path fill="white" d="M554.594,130.608l-14.521,35.039h29.121L554.594,130.608z M387.03,152.321c2.738-1.422,4.349-4.515,4.349-8.356c0-3.764-1.693-6.49-4.431-7.771c-2.492-1.42-6.328-1.584-10.006-1.584h-25.978v19.523h25.63C380.7,154.134,384.131,154.074,387.03,152.321z"></path></g>`,
                discover: `<g><path fill="#4D4D4D" d="M52.877,0C23.679,0,0,23.155,0,51.71v367.58C0,447.845,23.672,471,52.877,471h644.246C726.321,471,750,447.845,750,419.29V51.71C750,23.149,726.328,0,697.123,0H52.877z"></path><path fill="#F47216" d="M749.983,271.094c-25.048,17.233-212.574,140.397-537.264,199.891h484.386c29.198,0,52.877-23.155,52.877-51.71V271.094z"></path></g>`,
                jcb: `<g><rect fill="#0E4C96" x="0" y="0" width="750" height="471" rx="40"></rect><path fill="white" d="M617.242,346.766c0,41.615-33.729,75.36-75.357,75.36H132.759V124.245c0-41.626,33.73-75.371,75.364-75.371h409.12V346.766z"></path></g>`,
                diners: `<g><path fill="#0079BE" d="M584.934,236.947c0-99.416-82.98-168.133-173.896-168.1h-78.241c-92.003-0.033-167.73,68.705-167.73,168.1c0,90.931,75.729,165.641,167.73,165.203h78.241C501.951,402.587,584.934,327.857,584.934,236.947z"></path><path fill="white" d="M333.281,82.932c-84.069,0.026-152.193,68.308-152.215,152.58c0.021,84.258,68.145,152.532,152.215,152.559c84.088-0.026,152.229-68.301,152.239-152.559C485.508,151.238,417.369,82.958,333.281,82.932z"></path><path fill="#0079BE" d="M237.066,235.098c0.08-41.18,25.747-76.296,61.94-90.25v180.479C262.813,311.381,237.145,276.283,237.066,235.098z M368.066,325.373V144.848c36.208,13.921,61.915,49.057,61.981,90.256C429.981,276.316,404.274,311.426,368.066,325.373z"></path></g>`,
                maestro: `<g><rect fill="#000000" x="0" y="0" width="750" height="471" rx="40"></rect><rect fill="#7673C0" x="176.95" y="32.39" width="130.5" height="234.51"></rect><path fill="#EB001B" d="M185.24,149.64c-0.035-45.717,20.985-88.955,57-117.26c-61.128-48.072-148.928-41.086-201.687,16.048c-52.759,57.132-52.759,145.225,0,202.357c52.759,57.133,140.559,64.119,201.687,16.048C206.225,238.596,185.275,195.371,185.24,149.64z"></path><path fill="#00A1DF" d="M483.5,149.64c0.041,57.047-32.504,109.106-83.806,134.057c-51.301,24.95-112.346,18.407-157.195-16.847c35.839-28.31,56.742-71.49,56.742-117.21s-20.902-88.9-56.742-117.21c44.849-35.254,105.894-41.797,157.195-16.846C450.996,40.534,483.541,92.593,483.5,149.64z"></path></g>`,
                unionpay: `<g><rect fill="white" x="0" y="0" width="750" height="471" rx="40"></rect><path fill="#D10429" d="M201.81,55h142.393c19.869,0,32.287,16.406,27.63,36.47L305.5,378.948c-4.657,20.064-24.629,36.47-44.498,36.47H118.609c-19.869,0-32.287-16.406-27.63-36.47L157.312,91.47C161.968,71.302,181.837,55,201.706,55H201.81z"></path><path fill="#022E64" d="M331.75,55h163.815c19.869,0-8.964,16.406-3.307,36.47L426.925,378.948c-4.657,20.064-2.208,36.47-22.077,36.47H240.863c-19.973,0-32.287-16.406-27.63-36.47L279.566,91.47C284.223,71.302,304.092,55,323.964,55H331.75z"></path><path fill="#076F74" d="M489.815,55h142.394c19.869,0,32.287,16.406,27.63,36.47L593.506,378.948c-4.657,20.064-24.629,36.47-44.498,36.47H406.614c-19.973,0-32.287-16.406-27.63-36.47L444.317,91.47C448.974,71.302,468.843,55,488.711,55H489.815z"></path></g>`
            };
            
            switch(brand) {
                case 'visa':
                    ccicon.innerHTML = cardIcons.visa;
                    ccsingle.innerHTML = cardIcons.visa;
                    swapColor('blue');
                    break;
                case 'mastercard':
                    ccicon.innerHTML = cardIcons.mastercard;
                    ccsingle.innerHTML = cardIcons.mastercard;
                    swapColor('red');
                    break;
                case 'amex':
                    ccicon.innerHTML = cardIcons.amex;
                    ccsingle.innerHTML = cardIcons.amex;
                    swapColor('green');
                    break;
                case 'discover':
                    ccicon.innerHTML = cardIcons.discover;
                    ccsingle.innerHTML = cardIcons.discover;
                    swapColor('orange');
                    break;
                case 'jcb':
                    ccicon.innerHTML = cardIcons.jcb;
                    ccsingle.innerHTML = cardIcons.jcb;
                    swapColor('purple');
                    break;
                case 'diners':
                    ccicon.innerHTML = cardIcons.diners;
                    ccsingle.innerHTML = cardIcons.diners;
                    swapColor('cyan');
                    break;
                case 'maestro':
                    ccicon.innerHTML = cardIcons.maestro;
                    ccsingle.innerHTML = cardIcons.maestro;
                    swapColor('yellow');
                    break;
                case 'unionpay':
                    ccicon.innerHTML = cardIcons.unionpay;
                    ccsingle.innerHTML = cardIcons.unionpay;
                    swapColor('lime');
                    break;
                default:
                    ccicon.innerHTML = '';
                    ccsingle.innerHTML = '';
                    swapColor('grey');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã –ø–æ –±—Ä–µ–Ω–¥—É –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        function getCardNumberByBrand(brand) {
            switch(brand) {
                case 'visa': return '4242 4242 4242 4242';
                case 'mastercard': return '5555 5555 5555 4444';
                case 'amex': return '3782 8224 6310 005';
                default: return '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 1234';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã
        function getPartialCardNumber(brand) {
            switch(brand) {
                case 'visa': return '4242 ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                case 'mastercard': return '5555 ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                case 'amex': return '3782 ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                default: return '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –∫–∞—Ä—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–æ–º–µ—Ä–∞
        function updateCardType(number) {
            const ccicon = document.getElementById('ccicon');
            const ccsingle = document.getElementById('ccsingle');
            
            if (!ccicon || !ccsingle) return;
            
            const cleanNumber = number.replace(/\s/g, '');
            
            if (cleanNumber.match(/^4/)) {
                // Visa
                ccicon.innerHTML = '<use href="#visa"></use>';
                ccsingle.innerHTML = '<use href="#visa"></use>';
                swapColor('blue');
            } else if (cleanNumber.match(/^5[1-5]/)) {
                // Mastercard
                ccicon.innerHTML = '<use href="#mastercard"></use>';
                ccsingle.innerHTML = '<use href="#mastercard"></use>';
                swapColor('red');
            } else if (cleanNumber.match(/^3[47]/)) {
                // American Express
                ccicon.innerHTML = '<use href="#amex"></use>';
                ccsingle.innerHTML = '<use href="#amex"></use>';
                swapColor('green');
            } else {
                ccicon.innerHTML = '';
                ccsingle.innerHTML = '';
                swapColor('grey');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –∫–∞—Ä—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ Stripe brand (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ)
        function updateCardTypeFromBrand(brand) {
            const ccicon = document.getElementById('ccicon');
            const ccsingle = document.getElementById('ccsingle');
            
            if (!ccicon || !ccsingle) return;
            
            switch(brand) {
                case 'visa':
                    ccicon.innerHTML = '<use href="#visa"></use>';
                    ccsingle.innerHTML = '<use href="#visa"></use>';
                    swapColor('blue');
                    break;
                case 'mastercard':
                    ccicon.innerHTML = '<use href="#mastercard"></use>';
                    ccsingle.innerHTML = '<use href="#mastercard"></use>';
                    swapColor('red');
                    break;
                case 'amex':
                    ccicon.innerHTML = '<use href="#amex"></use>';
                    ccsingle.innerHTML = '<use href="#amex"></use>';
                    swapColor('green');
                    break;
                default:
                    ccicon.innerHTML = '';
                    ccsingle.innerHTML = '';
                    swapColor('grey');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö Stripe
        function updateCardAnimationFromStripe(event) {
            // –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, Stripe –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã –ø–æ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            // –ù–æ –º—ã –º–æ–∂–µ–º –æ–±–Ω–æ–≤–∏—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∞–Ω–∏–º–∞—Ü–∏–∏
            
            if (event.complete) {
                showDebug('Stripe Element –∑–∞–ø–æ–ª–Ω–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é!');
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –∫–∞—Ä—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞
                const svgnumber = document.getElementById('svgnumber');
                if (svgnumber && !svgnumber.innerHTML.includes('*')) {
                    svgnumber.innerHTML = '**** **** **** ****';
                }
            }
            
            if (event.brand) {
                updateCardTypeFromBrand(event.brand);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è —Å–º–µ–Ω—ã —Ü–≤–µ—Ç–∞ –∫–∞—Ä—Ç—ã (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è)
        function swapColor(color) {
            const creditcard = document.querySelector('.creditcard');
            if (!creditcard) return;
            
            creditcard.className = creditcard.className.replace(/\b(blue|red|green|grey)\b/g, '');
            creditcard.classList.add(color);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        function showDebug(message) {
            const debugInfo = document.getElementById('debug-info');
            const debugContent = document.getElementById('debug-content');
            if (debugInfo && debugContent) {
                debugContent.innerHTML += message + '<br>';
                debugInfo.style.display = 'block';
            }
        }
        
        function clearDebug() {
            const debugContent = document.getElementById('debug-content');
            if (debugContent) {
                debugContent.innerHTML = '';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–Ω–æ–ø–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª—É—á–∞–π–Ω–æ–π –∫–∞—Ä—Ç—ã
        function initGenerateCard() {
            const generateBtn = document.getElementById('generatecard');
            if (!generateBtn) return;
            
            generateBtn.addEventListener('click', function() {
                // –¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã Stripe
                const testCards = [
                    { number: '4242424242424242', brand: 'visa' },    // Visa
                    { number: '5555555555554444', brand: 'mastercard' }, // Mastercard
                    { number: '378282246310005', brand: 'amex' },     // American Express
                ];
                
                const randomCard = testCards[Math.floor(Math.random() * testCards.length)];
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –Ω–∞–ø—Ä—è–º—É—é
                const formattedNumber = formatCardNumber(randomCard.number);
                updateCardDisplay(formattedNumber, '12/25', '123');
                updateCardTypeFromBrandAdvanced(randomCard.brand);
                
                showDebug('üé≤ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Å–ª—É—á–∞–π–Ω–∞—è –∫–∞—Ä—Ç–∞: ' + randomCard.brand + ' - ' + formattedNumber);
                showNotification('–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Ç–µ—Å—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞ ' + randomCard.brand.toUpperCase() + '! –í–≤–µ–¥–∏—Ç–µ —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –≤ –ø–æ–ª–µ Stripe.', 'info');
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã
        function formatCardNumber(number) {
            return number.replace(/(\d{4})(?=\d)/g, '$1 ');
        }
        
        // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ª–∞–¥–∫–∏
        function initDebugButton() {
            // –°–æ–∑–¥–∞–µ–º —Å–∫—Ä—ã—Ç—É—é –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –æ—Ç–ª–∞–¥–∫–∏
            const debugToggle = document.createElement('div');
            debugToggle.innerHTML = 'üîß';
            debugToggle.title = 'Toggle Debug (Click to show/hide debug info)';
            debugToggle.style.cssText = `
                position: fixed; 
                bottom: 10px; 
                right: 10px; 
                width: 30px; 
                height: 30px; 
                border-radius: 50%; 
                background: rgba(108, 117, 125, 0.8); 
                color: white; 
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px; 
                cursor: pointer; 
                z-index: 1002;
                opacity: 0.6;
                transition: all 0.3s ease;
            `;
            debugToggle.onmouseover = function() {
                this.style.opacity = '1';
                this.style.transform = 'scale(1.1)';
            };
            debugToggle.onmouseout = function() {
                this.style.opacity = '0.6';
                this.style.transform = 'scale(1)';
            };
            debugToggle.onclick = function() {
                const debugInfo = document.getElementById('debug-info');
                if (debugInfo.style.display === 'none') {
                    debugInfo.style.display = 'block';
                    this.style.background = 'rgba(40, 167, 69, 0.8)';
                    this.innerHTML = 'üîß';
                } else {
                    debugInfo.style.display = 'none';
                    this.style.background = 'rgba(108, 117, 125, 0.8)';
                    this.innerHTML = 'üîß';
                }
            };
            document.body.appendChild(debugToggle);
            
            // –¢–∞–∫–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Å—Ç–∞—Ä—É—é –∫–Ω–æ–ø–∫—É –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
            const debugBtn = document.getElementById('show-debug');
            if (debugBtn) {
                debugBtn.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—É—é –∫–Ω–æ–ø–∫—É
                debugBtn.addEventListener('click', function() {
                    clearDebug();
                    showDebug('=== –û–¢–õ–ê–î–ö–ê –ü–û –ó–ê–ü–†–û–°–£ ===');
                    
                    const cardnumberField = document.getElementById('cardnumber');
                    const expirationdateField = document.getElementById('expirationdate');
                    const securitycodeField = document.getElementById('securitycode');
                    
                    showDebug('cardnumberField.value: "' + (cardnumberField?.value || '–ø—É—Å—Ç–æ–µ') + '"');
                    showDebug('expirationdateField.value: "' + (expirationdateField?.value || '–ø—É—Å—Ç–æ–µ') + '"');
                    showDebug('securitycodeField.value: "' + (securitycodeField?.value || '–ø—É—Å—Ç–æ–µ') + '"');
                    
                    if (window.cardMasks) {
                        showDebug('cardMasks –Ω–∞–π–¥–µ–Ω!');
                        if (window.cardMasks.cardnumber) {
                            showDebug('cardMasks.cardnumber.value: "' + window.cardMasks.cardnumber.value + '"');
                            showDebug('cardMasks.cardnumber.unmaskedValue: "' + window.cardMasks.cardnumber.unmaskedValue + '"');
                        } else {
                            showDebug('cardMasks.cardnumber –ù–ï –ù–ê–ô–î–ï–ù!');
                        }
                    } else {
                        showDebug('window.cardMasks –ù–ï –ù–ê–ô–î–ï–ù!');
                    }
                });
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Ñ–æ—Ä–º—ã
        document.addEventListener('DOMContentLoaded', function() {
             const donationForm = document.querySelector('.donation-form');
             if (donationForm) {
                 donationForm.addEventListener('submit', async function(e) {
                     e.preventDefault();
                      
                                             // Validate required fields
                       const amountField = document.getElementById('id_amount');
                       const nameField = document.getElementById('name');
                       const emailField = document.getElementById('id_email');
                       const currencyField = document.getElementById('currency');
                                              const cardnumberField = document.getElementById('cardnumber');
                       const expirationdateField = document.getElementById('expirationdate');
                       const securitycodeField = document.getElementById('securitycode');
                       
                       if (!amountField || !amountField.value || parseFloat(amountField.value) < 1) {
                           showNotification('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –Ω–µ –º–µ–Ω–µ–µ $1', 'error');
                           return;
                       }
                       
                       if (!nameField || !nameField.value.trim()) {
                           showNotification('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –Ω–∞ –∫–∞—Ä—Ç–µ', 'error');
                           return;
                       }
                       
                       // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–æ–ª–µ–π (Stripe Element –ø—Ä–æ–≤–µ—Ä–∏—Ç –∫–∞—Ä—Ç—É —Å–∞–º)
                       clearDebug();
                       showDebug('=== –í–ê–õ–ò–î–ê–¶–ò–Ø –û–°–ù–û–í–ù–´–• –ü–û–õ–ï–ô ===');
                       showDebug('–ü–æ–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã');
                       showDebug('Stripe Element –ø—Ä–æ–≤–µ—Ä–∏—Ç –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã —Å–∞–º');
                       
                       showDebug('–í–°–ï –í–ê–õ–ò–î–ê–¶–ò–ò –ü–†–û–®–õ–ò! –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ Stripe...');
                       
                       // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Stripe Elements
                       showDebug('–ü—Ä–æ–≤–µ—Ä—è–µ–º Stripe Elements...');
                       showDebug('window.stripeInstance: ' + (window.stripeInstance ? '–Ω–∞–π–¥–µ–Ω' : '–ù–ï –ù–ê–ô–î–ï–ù'));
                       showDebug('window.cardElement: ' + (window.cardElement ? '–Ω–∞–π–¥–µ–Ω' : '–ù–ï –ù–ê–ô–î–ï–ù'));
                       
                       if (!window.stripeInstance || !window.cardElement) {
                           showDebug('–û–®–ò–ë–ö–ê: Stripe Elements –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!');
                           showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã', 'error');
                           return;
                       }
                       
                       showDebug('Stripe Elements –Ω–∞–π–¥–µ–Ω—ã, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º...');
                      
                      try {
                          showNotification('–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞...', 'info');
                          showDebug('–ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–ª–∞—Ç–µ–∂–∞...');
                          
                          // 1. –°–æ–∑–¥–∞–µ–º Payment Intent
                          const paymentData = {
                              amount: parseFloat(amountField.value),
                              currency: currencyField?.value || 'usd',
                              name: nameField.value.trim(),
                              email: emailField?.value || ''
                          };
                          
                          showDebug('Payment data: ' + JSON.stringify(paymentData));
                          
                          const createResponse = await fetch('/donation/create-payment-intent/', {
                              method: 'POST',
                              headers: {
                                  'Content-Type': 'application/json',
                                  'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                              },
                              body: JSON.stringify(paymentData)
                          });
                          
                          const createData = await createResponse.json();
                          showDebug('Server response: ' + JSON.stringify(createData));
                          
                          if (!createData.success) {
                              showDebug('–û–®–ò–ë–ö–ê –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ' + createData.message);
                              throw new Error(createData.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞');
                          }
                          
                          showDebug('Payment Intent —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!');
                          
                                                     // 2. –ò—Å–ø–æ–ª—å–∑—É–µ–º Stripe Element –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
                           showDebug('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ Stripe Element...');
                           
                           const {error, paymentIntent} = await window.stripeInstance.confirmCardPayment(
                               createData.client_secret,
                               {
                                   payment_method: {
                                       card: window.cardElement,
                                       billing_details: {
                                           name: nameField.value.trim(),
                                           email: emailField?.value || ''
                                       }
                                   }
                               }
                           );
                           
                           if (error) {
                               showDebug('–û–®–ò–ë–ö–ê –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞: ' + error.message);
                               throw new Error(error.message || '–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞');
                           }
                           
                           showDebug('–ü–ª–∞—Ç–µ–∂ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                          
                          if (paymentIntent.status === 'succeeded') {
                              // 4. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º —É—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                              const confirmResponse = await fetch('/donation/confirm-payment/', {
                                  method: 'POST',
                                  headers: {
                                      'Content-Type': 'application/json',
                                      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                                  },
                                  body: JSON.stringify({
                                      payment_intent_id: paymentIntent.id
                                  })
                              });
                              
                              const confirmData = await confirmResponse.json();
                              
                              if (confirmData.success) {
                                  const currencySymbols = {
                                      'usd': '$',
                                      'eur': '‚Ç¨',
                                      'rub': '‚ÇΩ'
                                  };
                                  const symbol = currencySymbols[currencyField ? currencyField.value : 'usd'] || '$';
                                  showNotification(`–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à donation ${symbol}${amountField.value}! –ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω.`, 'success');
                                  
                                                                     // Reset form
                                   donationForm.reset();
                                   nameField.value = '';
                                   
                                   // Clear Stripe Elements
                                   window.cardElement.clear();
                                   
                                   // Clear animation fields
                                   if (window.cardMasks) {
                                       window.cardMasks.cardnumber.value = '';
                                       window.cardMasks.expirationdate.value = '';
                                       window.cardMasks.securitycode.value = '';
                                   }
                                   
                                   // Reset card display
                                   const svgname = document.getElementById('svgname');
                                   const svgnameback = document.getElementById('svgnameback'); 
                                   const svgnumber = document.getElementById('svgnumber');
                                   const svgexpire = document.getElementById('svgexpire');
                                   const svgsecurity = document.getElementById('svgsecurity');
                                   const ccicon = document.getElementById('ccicon');
                                   const ccsingle = document.getElementById('ccsingle');
                                   
                                   if (svgname) svgname.innerHTML = 'JOHN DOE';
                                   if (svgnameback) svgnameback.innerHTML = 'John Doe';
                                   if (svgnumber) svgnumber.innerHTML = '0123 4567 8910 1112';
                                   if (svgexpire) svgexpire.innerHTML = '01/23';
                                   if (svgsecurity) svgsecurity.innerHTML = '985';
                                   if (ccicon) ccicon.innerHTML = '';
                                   if (ccsingle) ccsingle.innerHTML = '';
                                   
                                   // Reset card flip
                                   document.querySelector('.creditcard')?.classList.remove('flipped');
                                   swapColor('grey');
                              } else {
                                  throw new Error(confirmData.message || '–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞');
                              }
                          } else {
                              throw new Error('–ü–ª–∞—Ç–µ–∂ –Ω–µ –±—ã–ª –∑–∞–≤–µ—Ä—à–µ–Ω');
                          }
                          
                      } catch (error) {
                          showDebug('–ü–û–ô–ú–ê–ù–ê –û–®–ò–ë–ö–ê: ' + error.message);
                          showDebug('Stack trace: ' + error.stack);
                          showNotification('–û—à–∏–±–∫–∞: ' + (error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞'), 'error');
                      }
                  });
                             }
         });
    </script>
    
</article>
{% endblock %} 