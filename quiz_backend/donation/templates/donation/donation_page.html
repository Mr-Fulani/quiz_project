{% extends 'blog/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}Donation{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css?family=Raleway:300,400,600" rel="stylesheet">
<link rel="stylesheet" href="{% static 'donation/css/donation.css' %}">
{% endblock %}

{% block content %}
<article class="donation active" data-page="donation">
    <header>
        <h1 class="h2 article-title">Donation</h1>
    </header>
<div class="container preload">
    <div class="creditcard">
        <div class="front">
            <div id="ccsingle"></div>
            <svg version="1.1" id="cardfront" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                x="0px" y="0px" viewBox="0 0 750 471" style="enable-background:new 0 0 750 471;" xml:space="preserve">
                <g id="Front">
                    <g id="CardBackground">
                        <g id="Page-1_1_">
                            <g id="amex_1_">
                                <path id="Rectangle-1_1_" class="lightcolor grey" d="M40,0h670c22.1,0,40,17.9,40,40v391c0,22.1-17.9,40-40,40H40c-22.1,0-40-17.9-40-40V40
                        C0,17.9,17.9,0,40,0z" />
                            </g>
                        </g>
                        <path class="darkcolor greydark" d="M750,431V193.2c-217.6-57.5-556.4-13.5-750,24.9V431c0,22.1,17.9,40,40,40h670C732.1,471,750,453.1,750,431z" />
                    </g>
                    <text transform="matrix(1 0 0 1 60.106 295.0121)" id="svgnumber" class="st2 st3 st4">0123 4567 8910 1112</text>
                    <text transform="matrix(1 0 0 1 54.1064 428.1723)" id="svgname" class="st2 st5 st6">JOHN DOE</text>
                    <text transform="matrix(1 0 0 1 54.1074 389.8793)" class="st7 st5 st8">cardholder name</text>
                    <text transform="matrix(1 0 0 1 479.7754 388.8793)" class="st7 st5 st8">expiration</text>
                    <text transform="matrix(1 0 0 1 65.1054 241.5)" class="st7 st5 st8">card number</text>
                    <g>
                        <text transform="matrix(1 0 0 1 574.4219 433.8095)" id="svgexpire" class="st2 st5 st9">01/23</text>
                        <text transform="matrix(1 0 0 1 479.3848 417.0097)" class="st2 st10 st11">VALID</text>
                        <text transform="matrix(1 0 0 1 479.3848 435.6762)" class="st2 st10 st11">THRU</text>
                        <polygon class="st2" points="554.5,421 540.4,414.2 540.4,427.9 		" />
                    </g>
                    <g id="cchip">
                        <g>
                            <path class="st2" d="M168.1,143.6H82.9c-10.2,0-18.5-8.3-18.5-18.5V74.9c0-10.2,8.3-18.5,18.5-18.5h85.3
                    c10.2,0,18.5,8.3,18.5,18.5v50.2C186.6,135.3,178.3,143.6,168.1,143.6z" />
                        </g>
                        <g>
                            <g>
                                <rect x="82" y="70" class="st12" width="1.5" height="60" />
                            </g>
                            <g>
                                <rect x="167.4" y="70" class="st12" width="1.5" height="60" />
                            </g>
                            <g>
                                <path class="st12" d="M125.5,130.8c-10.2,0-18.5-8.3-18.5-18.5c0-4.6,1.7-8.9,4.7-12.3c-3-3.4-4.7-7.7-4.7-12.3
                        c0-10.2,8.3-18.5,18.5-18.5s18.5,8.3,18.5,18.5c0,4.6-1.7,8.9-4.7,12.3c3,3.4,4.7,7.7,4.7,12.3
                        C143.9,122.5,135.7,130.8,125.5,130.8z M125.5,70.8c-9.3,0-16.9,7.6-16.9,16.9c0,4.4,1.7,8.6,4.8,11.8l0.5,0.5l-0.5,0.5
                        c-3.1,3.2-4.8,7.4-4.8,11.8c0,9.3,7.6,16.9,16.9,16.9s16.9-7.6,16.9-16.9c0-4.4-1.7-8.6-4.8-11.8l-0.5-0.5l0.5-0.5
                        c3.1-3.2,4.8-7.4,4.8-11.8C142.4,78.4,134.8,70.8,125.5,70.8z" />
                            </g>
                            <g>
                                <rect x="82.8" y="82.1" class="st12" width="25.8" height="1.5" />
                            </g>
                            <g>
                                <rect x="82.8" y="117.9" class="st12" width="26.1" height="1.5" />
                            </g>
                            <g>
                                <rect x="142.4" y="82.1" class="st12" width="25.8" height="1.5" />
                            </g>
                            <g>
                                <rect x="142" y="117.9" class="st12" width="26.2" height="1.5" />
                            </g>
                        </g>
                    </g>
                </g>
                <g id="Back">
                </g>
            </svg>
        </div>
        <div class="back">
            <svg version="1.1" id="cardback" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                x="0px" y="0px" viewBox="0 0 750 471" style="enable-background:new 0 0 750 471;" xml:space="preserve">
                <g id="Front">
                    <line class="st0" x1="35.3" y1="10.4" x2="36.7" y2="11" />
                </g>
                <g id="Back">
                    <g id="Page-1_2_">
                        <g id="amex_2_">
                            <path id="Rectangle-1_2_" class="darkcolor greydark" d="M40,0h670c22.1,0,40,17.9,40,40v391c0,22.1-17.9,40-40,40H40c-22.1,0-40-17.9-40-40V40
                    C0,17.9,17.9,0,40,0z" />
                        </g>
                    </g>
                    <rect y="61.6" class="st2" width="750" height="78" />
                    <g>
                        <path class="st3" d="M701.1,249.1H48.9c-3.3,0-6-2.7-6-6v-52.5c0-3.3,2.7-6,6-6h652.1c3.3,0,6,2.7,6,6v52.5
                C707.1,246.4,704.4,249.1,701.1,249.1z" />
                        <rect x="42.9" y="198.6" class="st4" width="664.1" height="10.5" />
                        <rect x="42.9" y="224.5" class="st4" width="664.1" height="10.5" />
                        <path class="st5" d="M701.1,184.6H618h-8h-10v64.5h10h8h83.1c3.3,0,6-2.7,6-6v-52.5C707.1,187.3,704.4,184.6,701.1,184.6z" />
                    </g>
                    <text transform="matrix(1 0 0 1 621.999 227.2734)" id="svgsecurity" class="st6 st7">985</text>
                    <g class="st8">
                        <text transform="matrix(1 0 0 1 518.083 280.0879)" class="st9 st6 st10">security code</text>
                    </g>
                    <rect x="58.1" y="378.6" class="st11" width="375.5" height="13.5" />
                    <rect x="58.1" y="405.6" class="st11" width="421.7" height="13.5" />
                    <text transform="matrix(1 0 0 1 59.5073 228.6099)" id="svgnameback" class="st12 st13">John Doe</text>
                </g>
            </svg>
        </div>
    </div>
</div>
<div class="form-container">
    <div class="field-container">
        <label for="name">Name</label>
        <input id="name" maxlength="20" type="text">
    </div>
    <!-- –ü–æ–ª—è –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ - –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ –ø–æ–≤–µ—Ä—Ö Stripe Elements -->
    <div class="field-container">
        <label for="cardnumber">Card Number</label>
        <span id="generatecard" style="cursor: pointer; color: blue; margin-left: 10px;">generate random</span>
        <span id="show-debug" style="cursor: pointer; color: green; margin-left: 10px;">–ø–æ–∫–∞–∑–∞—Ç—å –æ—Ç–ª–∞–¥–∫—É</span>
        <!-- Stripe Element - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø–æ–ª–µ –≤–≤–æ–¥–∞ -->
        <div style="padding: 10px; border: 2px solid #4CAF50; border-radius: 8px; background: #f8fff8;">
            <div style="font-weight: bold; color: #2E7D32; margin-bottom: 8px;">
                üí≥ –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã
            </div>
            <div id="card-element-visible" style="padding: 15px; border: 1px solid #ccc; border-radius: 4px; background: white; 
                                                   font-size: 16px; min-height: 50px; box-sizing: border-box;">
                <!-- Stripe Elements –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                üé® –ê–Ω–∏–º–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ
            </div>
        </div>
        
        <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ -->
        <input id="cardnumber" type="hidden">
        <input id="expirationdate" type="hidden">  
        <input id="securitycode" type="hidden">
        <svg id="ccicon" class="ccicon" width="750" height="471" viewBox="0 0 750 471" version="1.1" xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink">
        </svg>
    </div>
    

    
    <div id="card-errors" role="alert" style="color: #fa755a; margin-top: 8px; text-align: center;"></div>
    
    <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div id="debug-info" style="background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; display: none;">
        <strong>–û—Ç–ª–∞–¥–∫–∞:</strong><br>
        <div id="debug-content"></div>
    </div>
</div>

<!-- Donation Form -->
<div class="donation-form-container">
    <form method="post" class="donation-form">
        {% csrf_token %}
        <input type="hidden" name="card_name" id="hidden_card_name" value="">
        <div class="donation-fields">
            <div class="field-container">
                <label for="{{ form.amount.id_for_label }}">{{ form.amount.label }}</label>
                {{ form.amount }}
            </div>
            <div class="field-container">
                <label for="currency">{% trans "Currency" %}</label>
                <select id="currency" name="currency" class="form-control">
                    <option value="usd">USD ($)</option>
                    <option value="eur">EUR (‚Ç¨)</option>
                    <option value="rub">RUB (‚ÇΩ)</option>
                </select>
            </div>
            <div class="field-container">
                <label for="{{ form.email.id_for_label }}">{{ form.email.label }}</label>
                {{ form.email }}
            </div>
        </div>
        <button type="submit" class="donate-btn">Complete Donation</button>
    </form>
</div>

    <link rel="stylesheet" href="{% static 'donation/css/donation.css' %}">
    <script src="https://js.stripe.com/v3/"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/imask/3.4.0/imask.min.js'></script>
    <script src="{% static 'donation/js/notifications.js' %}"></script>
    <script src="{% static 'donation/js/donation.js' %}"></script>
    
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Stripe
        console.log('Template script loading...');
        console.log('Stripe publishable key:', '{{ stripe_publishable_key }}');
        
        if ('{{ stripe_publishable_key }}') {
            const stripe = Stripe('{{ stripe_publishable_key }}');
            console.log('Stripe object created:', stripe);
            
            // –°–æ–∑–¥–∞–µ–º Elements
            const elements = stripe.elements();
            
            // –°–æ–∑–¥–∞–µ–º –æ–¥–∏–Ω –æ–±—â–∏–π Card Element (—Å–∫—Ä—ã—Ç—ã–π)
            const cardElement = elements.create('card', {
                style: {
                    base: {
                        fontSize: '16px',
                        color: 'transparent',
                        '::placeholder': { color: 'transparent' },
                    }
                },
                hidePostalCode: true
            });
            
            // –ú–æ–Ω—Ç–∏—Ä—É–µ–º Stripe Element –≤ –≤–∏–¥–∏–º—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            cardElement.mount('#card-element-visible');
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –∫–∞—Ä—Ç—ã –∏ –∞–Ω–∏–º–∞—Ü–∏–∏
            cardElement.on('change', (event) => {
                const displayError = document.getElementById('card-errors');
                if (event.error) {
                    displayError.textContent = event.error.message;
                } else {
                    displayError.textContent = '';
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Stripe
                updateCardAnimationFromStripe(event);
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ–∫—É—Å–∞ –Ω–∞ Stripe Element
            cardElement.on('focus', (event) => {
                showDebug('üéØ Focus on Stripe Element');
                const creditcard = document.querySelector('.creditcard');
                if (creditcard) creditcard.classList.remove('flipped');
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Ç–µ—Ä–∏ —Ñ–æ–∫—É—Å–∞
            cardElement.on('blur', (event) => {
                showDebug('üëã Blur from Stripe Element');
            });
            
            // –ü–µ—Ä–µ–¥–∞–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            window.stripeInstance = stripe;
            window.cardElement = cardElement;
            
                         // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã
             initCardAnimation();
             
             // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª—É—á–∞–π–Ω–æ–π –∫–∞—Ä—Ç—ã
             initGenerateCard();
             
             // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–ª–∞–¥–∫–∏
             initDebugButton();
        } else {
            console.error('No Stripe publishable key provided');
        }
        
                                 // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–Ω–∏–º–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã
        function initCardAnimation() {
            const nameField = document.getElementById('name');
            
            if (!nameField) return;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
            nameField.addEventListener('input', function() {
                const name = this.value || 'JOHN DOE';
                const svgname = document.getElementById('svgname');
                const svgnameback = document.getElementById('svgnameback');
                if (svgname) svgname.innerHTML = name.toUpperCase();
                if (svgnameback) svgnameback.innerHTML = name;
            });
            
            // –°–æ–±—ã—Ç–∏—è —Ñ–æ–∫—É—Å–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –∫–∞—Ä—Ç—ã
            nameField.addEventListener('focus', function() {
                document.querySelector('.creditcard')?.classList.remove('flipped');
            });
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            updateCardDisplay('‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢', '‚Ä¢‚Ä¢/‚Ä¢‚Ä¢', '‚Ä¢‚Ä¢‚Ä¢');
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ä—Ç—ã
        function updateCardDisplay(number, expiry, cvv) {
            const svgnumber = document.getElementById('svgnumber');
            const svgexpire = document.getElementById('svgexpire');
            const svgsecurity = document.getElementById('svgsecurity');
            
            if (svgnumber) svgnumber.innerHTML = number || '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            if (svgexpire) svgexpire.innerHTML = expiry || '‚Ä¢‚Ä¢/‚Ä¢‚Ä¢';
            if (svgsecurity) svgsecurity.innerHTML = cvv || '‚Ä¢‚Ä¢‚Ä¢';
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–±—ã—Ç–∏–π Stripe
        function updateCardAnimationFromStripe(event) {
            showDebug('Stripe event: ' + JSON.stringify({
                brand: event.brand,
                complete: event.complete,
                empty: event.empty,
                error: event.error ? event.error.message : null
            }));
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∏–ø –∫–∞—Ä—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ brand –æ—Ç Stripe
            if (event.brand) {
                updateCardTypeFromBrand(event.brand);
            }
            
            // –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è Stripe
            if (event.complete) {
                // –ü–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø–æ–ª–Ω–µ–Ω–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                const cardNumber = getCardNumberByBrand(event.brand);
                updateCardDisplay(cardNumber, '12/25', '123');
                showDebug('‚úÖ Stripe field complete - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—É—é –∞–Ω–∏–º–∞—Ü–∏—é');
                
                // –£–±–∏—Ä–∞–µ–º –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç –∫–∞—Ä—Ç—ã
                const creditcard = document.querySelector('.creditcard');
                if (creditcard) creditcard.classList.remove('flipped');
                
            } else if (event.empty) {
                // –ü—É—Å—Ç–æ–µ –ø–æ–ª–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º placeholder
                updateCardDisplay('‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢', '‚Ä¢‚Ä¢/‚Ä¢‚Ä¢', '‚Ä¢‚Ä¢‚Ä¢');
                showDebug('‚≠ï Stripe field empty - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç—É—é –∞–Ω–∏–º–∞—Ü–∏—é');
                
                // –£–±–∏—Ä–∞–µ–º –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç –∫–∞—Ä—Ç—ã
                const creditcard = document.querySelector('.creditcard');
                if (creditcard) creditcard.classList.remove('flipped');
                
            } else {
                // –ß–∞—Å—Ç–∏—á–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                const cardNumber = getPartialCardNumber(event.brand);
                updateCardDisplay(cardNumber, '‚Ä¢‚Ä¢/‚Ä¢‚Ä¢', '‚Ä¢‚Ä¢‚Ä¢');
                showDebug('‚è≥ Stripe field partially filled');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã –ø–æ –±—Ä–µ–Ω–¥—É –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        function getCardNumberByBrand(brand) {
            switch(brand) {
                case 'visa': return '4242 4242 4242 4242';
                case 'mastercard': return '5555 5555 5555 4444';
                case 'amex': return '3782 8224 6310 005';
                default: return '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 1234';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã
        function getPartialCardNumber(brand) {
            switch(brand) {
                case 'visa': return '4242 ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                case 'mastercard': return '5555 ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                case 'amex': return '3782 ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                default: return '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –∫–∞—Ä—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–æ–º–µ—Ä–∞
        function updateCardType(number) {
            const ccicon = document.getElementById('ccicon');
            const ccsingle = document.getElementById('ccsingle');
            
            if (!ccicon || !ccsingle) return;
            
            const cleanNumber = number.replace(/\s/g, '');
            
            if (cleanNumber.match(/^4/)) {
                // Visa
                ccicon.innerHTML = '<use href="#visa"></use>';
                ccsingle.innerHTML = '<use href="#visa"></use>';
                swapColor('blue');
            } else if (cleanNumber.match(/^5[1-5]/)) {
                // Mastercard
                ccicon.innerHTML = '<use href="#mastercard"></use>';
                ccsingle.innerHTML = '<use href="#mastercard"></use>';
                swapColor('red');
            } else if (cleanNumber.match(/^3[47]/)) {
                // American Express
                ccicon.innerHTML = '<use href="#amex"></use>';
                ccsingle.innerHTML = '<use href="#amex"></use>';
                swapColor('green');
            } else {
                ccicon.innerHTML = '';
                ccsingle.innerHTML = '';
                swapColor('grey');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –∫–∞—Ä—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ Stripe brand (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ)
        function updateCardTypeFromBrand(brand) {
            const ccicon = document.getElementById('ccicon');
            const ccsingle = document.getElementById('ccsingle');
            
            if (!ccicon || !ccsingle) return;
            
            switch(brand) {
                case 'visa':
                    ccicon.innerHTML = '<use href="#visa"></use>';
                    ccsingle.innerHTML = '<use href="#visa"></use>';
                    swapColor('blue');
                    break;
                case 'mastercard':
                    ccicon.innerHTML = '<use href="#mastercard"></use>';
                    ccsingle.innerHTML = '<use href="#mastercard"></use>';
                    swapColor('red');
                    break;
                case 'amex':
                    ccicon.innerHTML = '<use href="#amex"></use>';
                    ccsingle.innerHTML = '<use href="#amex"></use>';
                    swapColor('green');
                    break;
                default:
                    ccicon.innerHTML = '';
                    ccsingle.innerHTML = '';
                    swapColor('grey');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö Stripe
        function updateCardAnimationFromStripe(event) {
            // –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, Stripe –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã –ø–æ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            // –ù–æ –º—ã –º–æ–∂–µ–º –æ–±–Ω–æ–≤–∏—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∞–Ω–∏–º–∞—Ü–∏–∏
            
            if (event.complete) {
                showDebug('Stripe Element –∑–∞–ø–æ–ª–Ω–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é!');
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –∫–∞—Ä—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞
                const svgnumber = document.getElementById('svgnumber');
                if (svgnumber && !svgnumber.innerHTML.includes('*')) {
                    svgnumber.innerHTML = '**** **** **** ****';
                }
            }
            
            if (event.brand) {
                updateCardTypeFromBrand(event.brand);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è —Å–º–µ–Ω—ã —Ü–≤–µ—Ç–∞ –∫–∞—Ä—Ç—ã (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è)
        function swapColor(color) {
            const creditcard = document.querySelector('.creditcard');
            if (!creditcard) return;
            
            creditcard.className = creditcard.className.replace(/\b(blue|red|green|grey)\b/g, '');
            creditcard.classList.add(color);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        function showDebug(message) {
            const debugInfo = document.getElementById('debug-info');
            const debugContent = document.getElementById('debug-content');
            if (debugInfo && debugContent) {
                debugContent.innerHTML += message + '<br>';
                debugInfo.style.display = 'block';
            }
        }
        
        function clearDebug() {
            const debugContent = document.getElementById('debug-content');
            if (debugContent) {
                debugContent.innerHTML = '';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–Ω–æ–ø–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª—É—á–∞–π–Ω–æ–π –∫–∞—Ä—Ç—ã
        function initGenerateCard() {
            const generateBtn = document.getElementById('generatecard');
            if (!generateBtn) return;
            
            generateBtn.addEventListener('click', function() {
                // –¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã Stripe
                const testCards = [
                    { number: '4242424242424242', brand: 'visa' },    // Visa
                    { number: '5555555555554444', brand: 'mastercard' }, // Mastercard
                    { number: '378282246310005', brand: 'amex' },     // American Express
                ];
                
                const randomCard = testCards[Math.floor(Math.random() * testCards.length)];
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –Ω–∞–ø—Ä—è–º—É—é
                const formattedNumber = formatCardNumber(randomCard.number);
                updateCardDisplay(formattedNumber, '12/25', '123');
                updateCardTypeFromBrand(randomCard.brand);
                
                showDebug('üé≤ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Å–ª—É—á–∞–π–Ω–∞—è –∫–∞—Ä—Ç–∞: ' + randomCard.brand + ' - ' + formattedNumber);
                showNotification('–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Ç–µ—Å—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞ ' + randomCard.brand.toUpperCase() + '! –í–≤–µ–¥–∏—Ç–µ —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –≤ –ø–æ–ª–µ Stripe.', 'info');
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã
        function formatCardNumber(number) {
            return number.replace(/(\d{4})(?=\d)/g, '$1 ');
        }
        
        // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ª–∞–¥–∫–∏
        function initDebugButton() {
            const debugBtn = document.getElementById('show-debug');
            if (!debugBtn) return;
            
            debugBtn.addEventListener('click', function() {
                clearDebug();
                showDebug('=== –û–¢–õ–ê–î–ö–ê –ü–û –ó–ê–ü–†–û–°–£ ===');
                
                const cardnumberField = document.getElementById('cardnumber');
                const expirationdateField = document.getElementById('expirationdate');
                const securitycodeField = document.getElementById('securitycode');
                
                showDebug('cardnumberField.value: "' + (cardnumberField?.value || '–ø—É—Å—Ç–æ–µ') + '"');
                showDebug('expirationdateField.value: "' + (expirationdateField?.value || '–ø—É—Å—Ç–æ–µ') + '"');
                showDebug('securitycodeField.value: "' + (securitycodeField?.value || '–ø—É—Å—Ç–æ–µ') + '"');
                
                if (window.cardMasks) {
                    showDebug('cardMasks –Ω–∞–π–¥–µ–Ω!');
                    if (window.cardMasks.cardnumber) {
                        showDebug('cardMasks.cardnumber.value: "' + window.cardMasks.cardnumber.value + '"');
                        showDebug('cardMasks.cardnumber.unmaskedValue: "' + window.cardMasks.cardnumber.unmaskedValue + '"');
                    } else {
                        showDebug('cardMasks.cardnumber –ù–ï –ù–ê–ô–î–ï–ù!');
                    }
                } else {
                    showDebug('window.cardMasks –ù–ï –ù–ê–ô–î–ï–ù!');
                }
            });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Ñ–æ—Ä–º—ã
        document.addEventListener('DOMContentLoaded', function() {
             const donationForm = document.querySelector('.donation-form');
             if (donationForm) {
                 donationForm.addEventListener('submit', async function(e) {
                     e.preventDefault();
                      
                                             // Validate required fields
                       const amountField = document.getElementById('id_amount');
                       const nameField = document.getElementById('name');
                       const emailField = document.getElementById('id_email');
                       const currencyField = document.getElementById('currency');
                                              const cardnumberField = document.getElementById('cardnumber');
                       const expirationdateField = document.getElementById('expirationdate');
                       const securitycodeField = document.getElementById('securitycode');
                       
                       if (!amountField || !amountField.value || parseFloat(amountField.value) < 1) {
                           showNotification('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –Ω–µ –º–µ–Ω–µ–µ $1', 'error');
                           return;
                       }
                       
                       if (!nameField || !nameField.value.trim()) {
                           showNotification('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –Ω–∞ –∫–∞—Ä—Ç–µ', 'error');
                           return;
                       }
                       
                       // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–æ–ª–µ–π (Stripe Element –ø—Ä–æ–≤–µ—Ä–∏—Ç –∫–∞—Ä—Ç—É —Å–∞–º)
                       clearDebug();
                       showDebug('=== –í–ê–õ–ò–î–ê–¶–ò–Ø –û–°–ù–û–í–ù–´–• –ü–û–õ–ï–ô ===');
                       showDebug('–ü–æ–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã');
                       showDebug('Stripe Element –ø—Ä–æ–≤–µ—Ä–∏—Ç –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã —Å–∞–º');
                       
                       showDebug('–í–°–ï –í–ê–õ–ò–î–ê–¶–ò–ò –ü–†–û–®–õ–ò! –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ Stripe...');
                       
                       // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Stripe Elements
                       showDebug('–ü—Ä–æ–≤–µ—Ä—è–µ–º Stripe Elements...');
                       showDebug('window.stripeInstance: ' + (window.stripeInstance ? '–Ω–∞–π–¥–µ–Ω' : '–ù–ï –ù–ê–ô–î–ï–ù'));
                       showDebug('window.cardElement: ' + (window.cardElement ? '–Ω–∞–π–¥–µ–Ω' : '–ù–ï –ù–ê–ô–î–ï–ù'));
                       
                       if (!window.stripeInstance || !window.cardElement) {
                           showDebug('–û–®–ò–ë–ö–ê: Stripe Elements –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!');
                           showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã', 'error');
                           return;
                       }
                       
                       showDebug('Stripe Elements –Ω–∞–π–¥–µ–Ω—ã, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º...');
                      
                      try {
                          showNotification('–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞...', 'info');
                          showDebug('–ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–ª–∞—Ç–µ–∂–∞...');
                          
                          // 1. –°–æ–∑–¥–∞–µ–º Payment Intent
                          const paymentData = {
                              amount: parseFloat(amountField.value),
                              currency: currencyField?.value || 'usd',
                              name: nameField.value.trim(),
                              email: emailField?.value || ''
                          };
                          
                          showDebug('Payment data: ' + JSON.stringify(paymentData));
                          
                          const createResponse = await fetch('/donation/create-payment-intent/', {
                              method: 'POST',
                              headers: {
                                  'Content-Type': 'application/json',
                                  'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                              },
                              body: JSON.stringify(paymentData)
                          });
                          
                          const createData = await createResponse.json();
                          showDebug('Server response: ' + JSON.stringify(createData));
                          
                          if (!createData.success) {
                              showDebug('–û–®–ò–ë–ö–ê –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ' + createData.message);
                              throw new Error(createData.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞');
                          }
                          
                          showDebug('Payment Intent —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!');
                          
                                                     // 2. –ò—Å–ø–æ–ª—å–∑—É–µ–º Stripe Element –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
                           showDebug('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ Stripe Element...');
                           
                           const {error, paymentIntent} = await window.stripeInstance.confirmCardPayment(
                               createData.client_secret,
                               {
                                   payment_method: {
                                       card: window.cardElement,
                                       billing_details: {
                                           name: nameField.value.trim(),
                                           email: emailField?.value || ''
                                       }
                                   }
                               }
                           );
                           
                           if (error) {
                               showDebug('–û–®–ò–ë–ö–ê –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞: ' + error.message);
                               throw new Error(error.message || '–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞');
                           }
                           
                           showDebug('–ü–ª–∞—Ç–µ–∂ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                          
                          if (paymentIntent.status === 'succeeded') {
                              // 4. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º —É—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                              const confirmResponse = await fetch('/donation/confirm-payment/', {
                                  method: 'POST',
                                  headers: {
                                      'Content-Type': 'application/json',
                                      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                                  },
                                  body: JSON.stringify({
                                      payment_intent_id: paymentIntent.id
                                  })
                              });
                              
                              const confirmData = await confirmResponse.json();
                              
                              if (confirmData.success) {
                                  const currencySymbols = {
                                      'usd': '$',
                                      'eur': '‚Ç¨',
                                      'rub': '‚ÇΩ'
                                  };
                                  const symbol = currencySymbols[currencyField ? currencyField.value : 'usd'] || '$';
                                  showNotification(`–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à donation ${symbol}${amountField.value}! –ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω.`, 'success');
                                  
                                                                     // Reset form
                                   donationForm.reset();
                                   nameField.value = '';
                                   
                                   // Clear Stripe Elements
                                   window.cardElement.clear();
                                   
                                   // Clear animation fields
                                   if (window.cardMasks) {
                                       window.cardMasks.cardnumber.value = '';
                                       window.cardMasks.expirationdate.value = '';
                                       window.cardMasks.securitycode.value = '';
                                   }
                                   
                                   // Reset card display
                                   const svgname = document.getElementById('svgname');
                                   const svgnameback = document.getElementById('svgnameback'); 
                                   const svgnumber = document.getElementById('svgnumber');
                                   const svgexpire = document.getElementById('svgexpire');
                                   const svgsecurity = document.getElementById('svgsecurity');
                                   const ccicon = document.getElementById('ccicon');
                                   const ccsingle = document.getElementById('ccsingle');
                                   
                                   if (svgname) svgname.innerHTML = 'JOHN DOE';
                                   if (svgnameback) svgnameback.innerHTML = 'John Doe';
                                   if (svgnumber) svgnumber.innerHTML = '0123 4567 8910 1112';
                                   if (svgexpire) svgexpire.innerHTML = '01/23';
                                   if (svgsecurity) svgsecurity.innerHTML = '985';
                                   if (ccicon) ccicon.innerHTML = '';
                                   if (ccsingle) ccsingle.innerHTML = '';
                                   
                                   // Reset card flip
                                   document.querySelector('.creditcard')?.classList.remove('flipped');
                                   swapColor('grey');
                              } else {
                                  throw new Error(confirmData.message || '–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞');
                              }
                          } else {
                              throw new Error('–ü–ª–∞—Ç–µ–∂ –Ω–µ –±—ã–ª –∑–∞–≤–µ—Ä—à–µ–Ω');
                          }
                          
                      } catch (error) {
                          showDebug('–ü–û–ô–ú–ê–ù–ê –û–®–ò–ë–ö–ê: ' + error.message);
                          showDebug('Stack trace: ' + error.stack);
                          showNotification('–û—à–∏–±–∫–∞: ' + (error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞'), 'error');
                      }
                  });
                             }
         });
    </script>
    
</article>
{% endblock %} 