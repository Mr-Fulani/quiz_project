{% extends "admin/change_list.html" %}
{% load static i18n %}

{% block extrastyle %}
  <link rel="stylesheet" href="{% static 'admin/css/message_styles.css' %}">
{% endblock %}

{% block content %}
  {% if is_dialog_view %}
    <div class="conversation-container">
      <h2 style="text-align: center; margin: 20px 0;">
        {% trans "Переписка между" %}
        {% if cl.result_list|length > 0 %}
          {% with first_message=cl.result_list|first %}
            {{ first_message.sender.username|default:"Аноним" }} ↔ {{ first_message.recipient.username|default:"Аноним" }}
          {% endwith %}
        {% else %}
          {% trans "Неизвестно" %}
        {% endif %}
      </h2>
      {% if cl.result_list %}
        {% with first_message=cl.result_list|first %}
          {% for result in cl.result_list %}
            <div class="message-item {% if result.sender_id == first_message.sender_id %}sender{% else %}recipient{% endif %}">
              <div class="message-header">
                <strong>
                  {% if result.sender %}
                    {{ result.sender.username }}
                  {% elif result.fullname %}
                    {{ result.fullname }} {% if result.email %}({{ result.email }}){% endif %}
                  {% else %}
                    {% trans "Аноним" %}
                  {% endif %}
                </strong>
                <small>{{ result.created_at|date:"d M Y, H:i" }}</small>
              </div>
              <div class="message-content">
                {{ result.content|default:"Нет текста"|linebreaksbr }}
              </div>
              <div class="message-attachments">
                <strong style="font-size: 0.9em; color: #555;">{% trans "Вложения" %}:</strong><br>
                {% if result.attachments.exists %}
                  {% for attachment in result.attachments.all %}
                    <div class="attachment-item">
                      {% if attachment.file %}
                        <a href="{{ attachment.file.url }}" target="_blank" title="{{ attachment.filename }}">
                          {% with attachment.filename|lower as lower_filename %}
                            {% if lower_filename|slice:"-4:" in ".jpg,.png,.gif" or lower_filename|slice:"-5:" in ".jpeg,.webp" %}
                              <img src="{{ attachment.file.url }}" alt="{{ attachment.filename }}">
                            {% else %}
                              <img src="{% static 'admin/img/icon-unknown.svg' %}" alt="file" class="icon">
                              {{ attachment.filename }}
                            {% endif %}
                          {% endwith %}
                        </a>
                      {% else %}
                        <span style="color: #999;">{% trans "Нет файла" %}</span>
                      {% endif %}
                    </div>
                  {% endfor %}
                {% else %}
                  <span style="color: #999;">{% trans "Нет вложений" %}</span>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        {% endwith %}
      {% else %}
        <p style="text-align: center; color: #777;">{% trans "Сообщений не найдено." %}</p>
      {% endif %}
      <p style="text-align: center;">
        <a href="{% url 'admin:blog_message_changelist' %}" class="button" style="text-decoration: none; padding: 8px 16px; background: #007bff; color: #fff; border-radius: 4px;">{% trans "Назад к диалогам" %}</a>
      </p>
    </div>
  {% else %}
    <div class="results">
      <h2>{% trans "Диалоги" %}</h2>
      {% if dialogs %}
        <table class="dialogs-table">
          <thead>
            <tr>
              <th>{% trans "Диалог" %}</th>
              <th>{% trans "Последнее сообщение" %}</th>
              <th>{% trans "Сообщений" %}</th>
              <th>{% trans "Дата" %}</th>
              <th>{% trans "Статус" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for dialog in dialogs %}
              <tr>
                <td>
                  <a href="{% url 'admin:blog_message_changelist' %}?dialog={{ dialog.sender_id }}-{{ dialog.recipient_id }}">
                    {{ dialog.sender_username|default:"Аноним" }} ↔ {{ dialog.recipient_username|default:"Аноним" }}
                  </a>
                </td>
                <td>{{ dialog.last_message|default:"-"|truncatechars:50 }}</td>
                <td>{{ dialog.message_count }}</td>
                <td>{{ dialog.last_message_date|date:"d M Y, H:i"|default:"-" }}</td>
                <td>
                  <span class="read-status {% if dialog.is_read %}read{% endif %}"></span>
                  {% if dialog.is_read %}{% trans "Прочитано" %}{% else %}{% trans "Не прочитано" %}{% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p>{% trans "Диалогов не найдено." %}</p>
      {% endif %}
    </div>
  {% endif %}
{% endblock %}