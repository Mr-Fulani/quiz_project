{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block title %}–ò–º–ø–æ—Ä—Ç –∑–∞–¥–∞—á –∏–∑ JSON{% endblock %}

{% block extrastyle %}
    {{ block.super }}
    <style>
        .import-form {
            max-width: 600px;
            margin: 40px auto;
            padding: 30px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .import-form h1 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #417690;
        }
        .import-form .form-group {
            margin-bottom: 20px;
        }
        .import-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        .import-form input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 2px dashed #ddd;
            border-radius: 4px;
            background: #f9f9f9;
        }
        .import-form input[type="file"]:hover {
            border-color: #417690;
            background: #f0f0f0;
        }
        .import-form .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .import-form .checkbox-group input[type="checkbox"] {
            width: auto;
        }
        .import-form .help-text {
            margin-top: 5px;
            font-size: 12px;
            color: #333;
            font-weight: 500;
        }
        .import-form .btn-submit {
            padding: 12px 24px;
            background: #417690;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }
        .import-form .btn-submit:hover {
            background: #2e5266;
        }
        .import-form .btn-cancel {
            margin-left: 10px;
            padding: 12px 24px;
            background: #ccc;
            color: #333;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
            display: inline-block;
        }
        .import-form .btn-cancel:hover {
            background: #b3b3b3;
        }
        .info-box {
            padding: 15px;
            background: #e7f3ff;
            border-left: 4px solid #417690;
            margin-bottom: 20px;
            border-radius: 4px;
            color: #1a1a1a;
        }
        .info-box h3 {
            margin-top: 0;
            color: #2e5266;
            font-weight: bold;
        }
        .info-box p {
            color: #1a1a1a;
            font-weight: 500;
        }
        .info-box ul {
            margin-bottom: 0;
            color: #1a1a1a;
        }
        .info-box li {
            color: #1a1a1a;
            font-weight: 500;
        }
        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .radio-option input[type="radio"] {
            width: auto;
            cursor: pointer;
        }
        .radio-option label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
        }
        .import-form textarea {
            width: 100%;
            min-height: 300px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 15px;
            font-weight: 600;
            resize: vertical;
            background: #ffffff;
            color: #000000;
            line-height: 1.6;
        }
        .import-form textarea:focus {
            outline: none;
            border-color: #417690;
            background: #ffffff;
            box-shadow: 0 0 0 3px rgba(65, 118, 144, 0.1);
        }
        .import-form textarea::placeholder {
            color: #aaa;
            font-weight: normal;
        }
        .import-form textarea.error {
            border-color: #dc3545;
            background: #fff5f5;
        }
        .json-validation-error {
            margin-top: 5px;
            padding: 8px 12px;
            background: #fff5f5;
            border-left: 3px solid #dc3545;
            color: #dc3545;
            font-size: 12px;
            border-radius: 4px;
            display: none;
        }
        .json-validation-error.show {
            display: block;
        }
        .btn-clear {
            padding: 8px 16px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 5px;
            transition: background 0.3s;
        }
        .btn-clear:hover {
            background: #5a6268;
        }
        .hidden {
            display: none !important;
        }
    </style>
{% endblock %}

{% block content %}
<div class="import-form">
    <h1>{% trans "–ò–º–ø–æ—Ä—Ç –∑–∞–¥–∞—á –∏–∑ JSON" %}</h1>
    
    <div class="info-box">
        <h3>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
        <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ JSON —Ñ–∞–π–ª —Å –∑–∞–¥–∞—á–∞–º–∏. –§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–µ:</p>
        <ul>
            <li>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è —Ç–µ–º—ã –∏ –ø–æ–¥—Ç–µ–º—ã</li>
            <li>–ì–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –∑–∞–¥–∞—á –±–µ–∑ image_url</li>
            <li>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ AWS S3</li>
            <li>–ú–æ–∂–Ω–æ —Å—Ä–∞–∑—É –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∑–∞–¥–∞—á–∏ –≤ Telegram</li>
        </ul>
    </div>
    
    <form method="post" enctype="multipart/form-data" id="import-form">
        {% csrf_token %}
        
        <div class="form-group">
            <label>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –∏–º–ø–æ—Ä—Ç–∞:</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" 
                           id="method-file" 
                           name="import_method" 
                           value="file" 
                           checked>
                    <label for="method-file">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</label>
                </div>
                <div class="radio-option">
                    <input type="radio" 
                           id="method-text" 
                           name="import_method" 
                           value="text">
                    <label for="method-text">üìù –í—Å—Ç–∞–≤–∏—Ç—å JSON —Ç–µ–∫—Å—Ç</label>
                </div>
            </div>
        </div>
        
        <div class="form-group" id="file-input-group">
            <label for="json_file">–í—ã–±–µ—Ä–∏—Ç–µ JSON —Ñ–∞–π–ª:</label>
            <input type="file" 
                   id="json_file" 
                   name="json_file" 
                   accept=".json">
            <div class="help-text">
                –¢–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã .json
            </div>
        </div>
        
        <div class="form-group hidden" id="json-input-group">
            <label for="json_text">–í—Å—Ç–∞–≤—å—Ç–µ JSON —Ç–µ–∫—Å—Ç:</label>
            <textarea id="json_text" 
                      name="json_text" 
                      placeholder='{"tasks": [...]}'>
            </textarea>
            <div class="json-validation-error" id="json-error"></div>
            <button type="button" class="btn-clear" id="clear-json">
                üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
            </button>
            <div class="help-text">
                –í—Å—Ç–∞–≤—å—Ç–µ JSON –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
            </div>
        </div>
        
        <div class="form-group">
            <div class="checkbox-group">
                <input type="checkbox" 
                       id="publish" 
                       name="publish">
                <label for="publish" style="margin-bottom: 0;">
                    –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ Telegram —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞
                </label>
            </div>
            <div class="help-text">
                ‚ö†Ô∏è –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–ª—è –∑–∞–¥–∞—á —É–∫–∞–∑–∞–Ω—ã Telegram –≥—Ä—É–ø–ø—ã
            </div>
        </div>
        
        <div class="form-group">
            <button type="submit" class="btn-submit">
                üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
            </button>
            <a href="{% url 'admin:tasks_task_changelist' %}" class="btn-cancel">
                ‚Üê –û—Ç–º–µ–Ω–∞
            </a>
        </div>
    </form>
</div>

<script>
(function() {
    const methodFileRadio = document.getElementById('method-file');
    const methodTextRadio = document.getElementById('method-text');
    const fileInputGroup = document.getElementById('file-input-group');
    const jsonInputGroup = document.getElementById('json-input-group');
    const jsonFileInput = document.getElementById('json_file');
    const jsonTextarea = document.getElementById('json_text');
    const jsonError = document.getElementById('json-error');
    const clearButton = document.getElementById('clear-json');
    const form = document.getElementById('import-form');
    
    let validationTimeout;
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –º–µ—Ç–æ–¥–∞–º–∏ –∏–º–ø–æ—Ä—Ç–∞
    function toggleImportMethod() {
        if (methodFileRadio.checked) {
            fileInputGroup.classList.remove('hidden');
            jsonInputGroup.classList.add('hidden');
            jsonFileInput.required = true;
            jsonTextarea.required = false;
            clearValidationError();
        } else {
            fileInputGroup.classList.add('hidden');
            jsonInputGroup.classList.remove('hidden');
            jsonFileInput.required = false;
            jsonTextarea.required = true;
        }
    }
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è JSON
    function validateJSON(text) {
        if (!text || text.trim() === '') {
            return { valid: true, error: null };
        }
        
        try {
            JSON.parse(text);
            return { valid: true, error: null };
        } catch (e) {
            return { valid: false, error: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON: ' + e.message };
        }
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    function showValidationError(message) {
        jsonError.textContent = message;
        jsonError.classList.add('show');
        jsonTextarea.classList.add('error');
    }
    
    // –°–∫—Ä—ã—Ç—å –æ—à–∏–±–∫—É –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    function clearValidationError() {
        jsonError.textContent = '';
        jsonError.classList.remove('show');
        jsonTextarea.classList.remove('error');
    }
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ (—Å –∑–∞–¥–µ—Ä–∂–∫–æ–π)
    function handleTextareaInput() {
        clearTimeout(validationTimeout);
        validationTimeout = setTimeout(() => {
            const result = validateJSON(jsonTextarea.value);
            if (!result.valid) {
                showValidationError(result.error);
            } else {
                clearValidationError();
            }
        }, 500);
    }
    
    // –û—á–∏—Å—Ç–∫–∞ textarea
    function clearTextarea() {
        jsonTextarea.value = '';
        clearValidationError();
        jsonTextarea.focus();
    }
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ñ–æ—Ä–º—ã
    function handleFormSubmit(e) {
        if (methodTextRadio.checked) {
            const text = jsonTextarea.value.trim();
            if (!text) {
                e.preventDefault();
                showValidationError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—Å—Ç–∞–≤—å—Ç–µ JSON —Ç–µ–∫—Å—Ç');
                return false;
            }
            
            const result = validateJSON(text);
            if (!result.valid) {
                e.preventDefault();
                showValidationError(result.error);
                return false;
            }
        } else if (methodFileRadio.checked) {
            if (!jsonFileInput.files || jsonFileInput.files.length === 0) {
                e.preventDefault();
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ JSON —Ñ–∞–π–ª');
                return false;
            }
        }
        
        return true;
    }
    
    // –°–æ–±—ã—Ç–∏—è
    methodFileRadio.addEventListener('change', toggleImportMethod);
    methodTextRadio.addEventListener('change', toggleImportMethod);
    jsonTextarea.addEventListener('input', handleTextareaInput);
    clearButton.addEventListener('click', clearTextarea);
    form.addEventListener('submit', handleFormSubmit);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    toggleImportMethod();
})();
</script>
{% endblock %}

