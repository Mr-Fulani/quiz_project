"""
–°–∏–≥–Ω–∞–ª—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.

–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ –∂–∞–ª–æ–±,
–æ—Ç–ø—Ä–∞–≤–ª—è—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ Telegram –≤—Å–µ–º –∞–∫—Ç–∏–≤–Ω—ã–º –∞–¥–º–∏–Ω–∞–º.
"""

import logging
from django.db.models.signals import post_save
from django.dispatch import receiver
from .models import Task, TaskComment, TaskCommentReport

logger = logging.getLogger(__name__)


@receiver(post_save, sender=TaskComment)
def comment_created_notification(sender, instance, created, **kwargs):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è.
    
    –û–¢–ö–õ–Æ–ß–ï–ù–û: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ comment_views.py,
    —Ç–∞–∫ –∫–∞–∫ —Ç–æ–ª—å–∫–æ —Ç–∞–º –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ request –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è URL.
    
    Args:
        sender: –ú–æ–¥–µ–ª—å TaskComment
        instance: –°–æ–∑–¥–∞–Ω–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
        created: True –µ—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç, False –µ—Å–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        **kwargs: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã —Å–∏–≥–Ω–∞–ª–∞
    """
    # –û—Ç–∫–ª—é—á–µ–Ω–æ ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ comment_views.py —Å –ø–µ—Ä–µ–¥–∞—á–µ–π request
    pass


@receiver(post_save, sender=TaskCommentReport)
def report_created_notification(sender, instance, created, **kwargs):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –∂–∞–ª–æ–±—ã.
    
    –û–¢–ö–õ–Æ–ß–ï–ù–û: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ comment_views.py
    –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ URL –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.
    
    Args:
        sender: –ú–æ–¥–µ–ª—å TaskCommentReport
        instance: –°–æ–∑–¥–∞–Ω–Ω–∞—è –∂–∞–ª–æ–±–∞
        created: True –µ—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç, False –µ—Å–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        **kwargs: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã —Å–∏–≥–Ω–∞–ª–∞
    """
    # –û—Ç–∫–ª—é—á–µ–Ω–æ ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ comment_views.py
    pass


@receiver(post_save, sender=Task)
def auto_publish_to_social_media(sender, instance, created, **kwargs):
    """
    –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—É–±–ª–∏–∫—É–µ—Ç –∑–∞–¥–∞—á—É –≤ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏ –ø—Ä–∏ published=True.
    
    –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–≥–¥–∞:
    1. –ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å published=True
    2. –ó–∞–¥–∞—á–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∏ published –º–µ–Ω—è–µ—Ç—Å—è —Å False –Ω–∞ True
    
    Args:
        sender: –ú–æ–¥–µ–ª—å Task
        instance: –û–±—ä–µ–∫—Ç –∑–∞–¥–∞—á–∏
        created: True –µ—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç
        **kwargs: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã —Å–∏–≥–Ω–∞–ª–∞
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–¥–∞—á–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞
    if not instance.published:
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    if not instance.image_url:
        logger.warning(f"‚ö†Ô∏è –ó–∞–¥–∞—á–∞ {instance.id} –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞ –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –≤ —Å–æ—Ü—Å–µ—Ç–∏")
        return
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥ –∑–∞–¥–∞—á–∏
    translation = instance.translations.first()
    if not translation:
        logger.warning(f"‚ö†Ô∏è –ó–∞–¥–∞—á–∞ {instance.id} –Ω–µ –∏–º–µ–µ—Ç –ø–µ—Ä–µ–≤–æ–¥–æ–≤, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –≤ —Å–æ—Ü—Å–µ—Ç–∏")
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ –ª–∏ —É–∂–µ —ç—Ç—É –∑–∞–¥–∞—á—É (–∏–∑–±–µ–≥–∞–µ–º –¥—É–±–ª–µ–π)
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª—é–±—ã–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏ –¥–ª—è —ç—Ç–æ–π –∑–∞–¥–∞—á–∏
    existing_posts = instance.social_media_posts.exists()
    
    if existing_posts:
        logger.info(f"‚ÑπÔ∏è –ó–∞–¥–∞—á–∞ {instance.id} —É–∂–µ –∏–º–µ–µ—Ç –∑–∞–ø–∏—Å–∏ –æ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ —Å–æ—Ü—Å–µ—Ç–∏, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏—é")
        return
    
    # –ü—É–±–ª–∏–∫—É–µ–º –≤ —Å–æ—Ü—Å–µ—Ç–∏
    try:
        from .services.social_media_service import publish_to_social_media
        
        logger.info(f"üåê –ê–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏—è –∑–∞–¥–∞—á–∏ {instance.id} –≤ —Å–æ—Ü—Å–µ—Ç–∏")
        result = publish_to_social_media(instance, translation)
        
        if result['success'] > 0:
            logger.info(f"‚úÖ –ó–∞–¥–∞—á–∞ {instance.id} –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞: {result['success']}/{result['total']} –ø–ª–∞—Ç—Ñ–æ—Ä–º")
        else:
            logger.warning(f"‚ö†Ô∏è –ó–∞–¥–∞—á–∞ {instance.id}: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–∏ –≤ –æ–¥–Ω–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ")
            
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∑–∞–¥–∞—á–∏ {instance.id}: {e}", exc_info=True)
