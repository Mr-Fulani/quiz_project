#!/bin/bash

# Entrypoint –¥–ª—è Django –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏, —Å–æ–±–∏—Ä–∞–µ—Ç —Å—Ç–∞—Ç–∏–∫—É –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏–∫–æ–Ω–∫–∏

# –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –æ–ø–µ—Ä–∞—Ü–∏–∏ - –¥–æ–ª–∂–Ω—ã –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è —Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π –æ—à–∏–±–æ–∫
set -e

echo "üöÄ –ó–∞–ø—É—Å–∫ Django –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."

# –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
python manage.py wait_for_db

# –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
echo "üîÑ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π..."
python manage.py migrate

# –û—Ç–∫–ª—é—á–∞–µ–º set -e –¥–ª—è –Ω–µ–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
set +e

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É staticfiles –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ staticfiles..."
mkdir -p staticfiles

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
echo "üîê –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è staticfiles..."
chmod -R 755 staticfiles

# –¢–æ–ª—å–∫–æ —Å–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏–∫—É –ë–ï–ó –æ—á–∏—Å—Ç–∫–∏ (–æ—á–∏—Å—Ç–∫–∞ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤ start-prod.sh)
# –≠—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É—Å–∫–æ—Ä—è–µ—Ç –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
echo "üìÅ –°–±–æ—Ä —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤..."
python manage.py collectstatic --noinput || {
    echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: collectstatic –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∑–∞–ø—É—Å–∫"
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—Ç–∞—Ç–∏–∫–∞ —Å–æ–±—Ä–∞–ª–∞—Å—å
if [ -d "staticfiles" ] && [ "$(ls -A staticfiles 2>/dev/null)" ]; then
    echo "‚úÖ –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –≥–æ—Ç–æ–≤—ã"
    chmod -R 755 staticfiles
else
    echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: staticfiles –ø—É—Å—Ç –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∑–∞–ø—É—Å–∫"
fi

# –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∏–∫–æ–Ω–æ–∫ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞
# –ï—Å–ª–∏ –∏–∫–æ–Ω–∫–∏ –Ω—É–∂–Ω—ã - –∑–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Ä—É—á–Ω—É—é: python manage.py fix_icon_mapping
echo "‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤ –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ –ª–æ–≥–æ–≤..."
mkdir -p logs
chmod -R 755 logs

# –í–æ–∑–≤—Ä–∞—â–∞–µ–º set -e –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è)
set -e

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç DEBUG
echo "üåê –ó–∞–ø—É—Å–∫ Django —Å–µ—Ä–≤–µ—Ä–∞..."
if [ "$DEBUG" = "True" ]; then
    # –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º runserver —Å –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π
    exec python manage.py runserver 0.0.0.0:8000
else
    # –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º Gunicorn —Å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
    echo "üöÄ –ó–∞–ø—É—Å–∫ Gunicorn –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω —Ä–µ–∂–∏–º–µ..."
    
    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ workers (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1 –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ —Å–ª–∞–±—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤)
    WORKERS=${GUNICORN_WORKERS:-1}
    THREADS=${GUNICORN_THREADS:-1}
    TIMEOUT=${GUNICORN_TIMEOUT:-120}
    WORKER_CLASS=${GUNICORN_WORKER_CLASS:-sync}
    
    echo "‚öôÔ∏è  –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Gunicorn: workers=$WORKERS, threads=$THREADS, timeout=$TIMEOUT"
    
    exec gunicorn config.wsgi:application \
        --bind 0.0.0.0:8000 \
        --workers $WORKERS \
        --threads $THREADS \
        --worker-class $WORKER_CLASS \
        --timeout $TIMEOUT \
        --max-requests 1000 \
        --max-requests-jitter 50 \
        --access-logfile /app/logs/gunicorn-access.log \
        --error-logfile /app/logs/gunicorn-error.log \
        --log-level info \
        --capture-output \
        --enable-stdio-inheritance
fi 