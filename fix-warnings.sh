#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะธัะฟัะฐะฒะปะตะฝะธั ะฟัะตะดัะฟัะตะถะดะตะฝะธะน PostgreSQL ะธ Redis
# ะัะฟะพะปัะทะพะฒะฐะฝะธะต: ./fix-warnings.sh

echo "๐ง ะัะฟัะฐะฒะปะตะฝะธะต ะฟัะตะดัะฟัะตะถะดะตะฝะธะน PostgreSQL ะธ Redis..."

# ะะพะปััะฐะตะผ ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั ะธะท .env ัะฐะนะปะฐ
# ะะตะทะพะฟะฐัะฝัะน ัะฟะพัะพะฑ ะฟะฐััะธะฝะณะฐ .env ั ะฟะพะดะดะตัะถะบะพะน ะฟัะพะฑะตะปะพะฒ ะฒ ะทะฝะฐัะตะฝะธัั
if [ -f .env ]; then
    set -a
    source .env 2>/dev/null || {
        # ะัะปะธ source ะฝะต ัะฐะฑะพัะฐะตั, ะธัะฟะพะปัะทัะตะผ ะฐะปััะตัะฝะฐัะธะฒะฝัะน ะผะตัะพะด
        while IFS= read -r line || [ -n "$line" ]; do
            # ะัะพะฟััะบะฐะตะผ ะบะพะผะผะตะฝัะฐัะธะธ ะธ ะฟััััะต ัััะพะบะธ
            [[ "$line" =~ ^[[:space:]]*# ]] && continue
            [[ -z "${line// }" ]] && continue
            
            # ะญะบัะฟะพััะธััะตะผ ะฟะตัะตะผะตะฝะฝัั, ะตัะปะธ ะพะฝะฐ ัะพะดะตัะถะธั =
            if [[ "$line" =~ ^[[:space:]]*([^=]+)=(.*)$ ]]; then
                key="${BASH_REMATCH[1]// /}"
                value="${BASH_REMATCH[2]}"
                # ะฃะฑะธัะฐะตะผ ะบะฐะฒััะบะธ ะตัะปะธ ะพะฝะธ ะตััั
                value="${value#\"}"
                value="${value%\"}"
                value="${value#\'}"
                value="${value%\'}"
                export "$key=$value" 2>/dev/null || true
            fi
        done < .env
    }
    set +a
fi

# ะะฝะฐัะตะฝะธั ะฟะพ ัะผะพะปัะฐะฝะธั
DB_NAME=${DB_NAME:-fulani_quiz_db}
DB_USER=${DB_USER:-postgres}
DB_PASSWORD=${DB_PASSWORD:-postgres}
POSTGRES_CONTAINER="postgres_db_local_prod"

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ง ะัะฟัะฐะฒะปะตะฝะธะต ะฟัะตะดัะฟัะตะถะดะตะฝะธะน"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# 1. ะัะฟัะฐะฒะปะตะฝะธะต PostgreSQL collation version mismatch
echo "1๏ธโฃ ะัะฟัะฐะฒะปะตะฝะธะต ะฟัะตะดัะฟัะตะถะดะตะฝะธั ะพ collation version mismatch ะฒ PostgreSQL..."
if docker ps | grep -q "$POSTGRES_CONTAINER"; then
    echo "   ๐ ะะพะฝัะตะนะฝะตั PostgreSQL ะฝะฐะนะดะตะฝ, ะฒัะฟะพะปะฝัะตะผ ะธัะฟัะฐะฒะปะตะฝะธะต..."
    
    # ะัะฟะพะปะฝัะตะผ ะบะพะผะฐะฝะดั ะดะปั ะพะฑะฝะพะฒะปะตะฝะธั ะฒะตััะธะธ collation
    docker exec -e PGPASSWORD="$DB_PASSWORD" "$POSTGRES_CONTAINER" \
        psql -U "$DB_USER" -d "$DB_NAME" -c "ALTER DATABASE $DB_NAME REFRESH COLLATION VERSION;" 2>&1
    
    if [ $? -eq 0 ]; then
        echo "   โ ะะตััะธั collation ััะฟะตัะฝะพ ะพะฑะฝะพะฒะปะตะฝะฐ ะดะปั ะฑะฐะทั ะดะฐะฝะฝัั $DB_NAME"
    else
        echo "   โ๏ธ  ะะต ัะดะฐะปะพัั ะพะฑะฝะพะฒะธัั ะฒะตััะธั collation. ะะพะทะผะพะถะฝะพ, ััะตะฑัะตััั ะฟะตัะตัะพะทะดะฐะฝะธะต ะพะฑัะตะบัะพะฒ ะะ."
        echo "   ๐ก ะะปััะตัะฝะฐัะธะฒะฝะพะต ัะตัะตะฝะธะต: ะฟะตัะตัะพะทะดะฐัั ะฑะฐะทั ะดะฐะฝะฝัั (ั ะฟัะตะดะฒะฐัะธัะตะปัะฝัะผ ะฑัะบะฐะฟะพะผ!)"
    fi
else
    echo "   โ๏ธ  ะะพะฝัะตะนะฝะตั PostgreSQL ะฝะต ะฝะฐะนะดะตะฝ. ะฃะฑะตะดะธัะตัั, ััะพ ะพะฝ ะทะฐะฟััะตะฝ."
    echo "   ๐ก ะะฐะฟัััะธัะต: docker compose -f docker-compose.local-prod.yml up -d postgres_db"
fi

echo ""

# 2. ะัะตะดัะฟัะตะถะดะตะฝะธะต ะพ Redis memory overcommit (ััะตะฑัะตั ะฝะฐัััะพะนะบะธ ะฝะฐ ัะพััะต)
echo "2๏ธโฃ ะัะตะดัะฟัะตะถะดะตะฝะธะต Redis ะพ memory overcommit..."
echo "   โน๏ธ  ะะปั ะฟะพะปะฝะพะณะพ ะธัะฟัะฐะฒะปะตะฝะธั ะฒัะฟะพะปะฝะธัะต ะฝะฐ ัะพััะต (ัะตัะฒะตัะต):"
echo "      sudo sysctl vm.overcommit_memory=1"
echo "      sudo echo 'vm.overcommit_memory=1' >> /etc/sysctl.conf"
echo "   ๐ก ะญัะพ ะฟัะตะดะพัะฒัะฐัะธั ะฒะพะทะผะพะถะฝัะต ัะฑะพะธ Redis ะฟัะธ ะฝะตัะฒะฐัะบะต ะฟะฐะผััะธ."
echo "   โ๏ธ  ะขัะตะฑัะตั ะฟะตัะตะทะฐะณััะทะบะธ ะธะปะธ ะฟัะธะผะตะฝะตะฝะธั ะฝะฐัััะพะตะบ sysctl."

echo ""

# 3. ะัะตะดัะฟัะตะถะดะตะฝะธะต Redis ะพ ะฒะพะทะผะพะถะฝะพะน ะฐัะฐะบะต (ะปะพะถะฝัะต ััะฐะฑะฐััะฒะฐะฝะธั)
echo "3๏ธโฃ ะัะตะดัะฟัะตะถะดะตะฝะธะต Redis ะพ ะฒะพะทะผะพะถะฝะพะน ะฐัะฐะบะต..."
echo "   โน๏ธ  ะญัะธ ะฟัะตะดัะฟัะตะถะดะตะฝะธั ะพะฑััะฝะพ ะฒัะทะฒะฐะฝั HTTP-ะทะฐะฟัะพัะฐะผะธ, ะฝะฐะฟัะฐะฒะปะตะฝะฝัะผะธ ะฝะฐ Redis ะฟะพัั."
echo "   ๐ก ะะตัะตะฝะธะต: ะฃะฑะตะดะธัะตัั, ััะพ Redis ะฝะต ะดะพัััะฟะตะฝ ะธะทะฒะฝะต (ะดะพะปะถะตะฝ ะฑััั ัะพะปัะบะพ ะฒะฝัััะธ Docker ัะตัะธ)."
echo "   ๐ก ะัะพะฒะตัััะต firewall ะธ ัะตัะตะฒัั ะบะพะฝัะธะณััะฐัะธั."

echo ""

# 4. ะัะธะฑะบะธ ะฐััะตะฝัะธัะธะบะฐัะธะธ PostgreSQL
echo "4๏ธโฃ ะัะธะฑะบะธ ะฐััะตะฝัะธัะธะบะฐัะธะธ PostgreSQL..."
echo "   โน๏ธ  ะะฑะฝะฐััะถะตะฝั ะฟะพะฟััะบะธ ะฟะพะดะบะปััะตะฝะธั ั ะฝะตัััะตััะฒัััะธะผ ะฟะพะปัะทะพะฒะฐัะตะปะตะผ 'administrator'."
echo "   ๐ก ะญัะพ ะฝะพัะผะฐะปัะฝะพ - ะบัะพ-ัะพ (ัะบะฐะฝะตั ะธะปะธ ะฑะพั) ะฟััะฐะตััั ะฟะพะดะบะปััะธัััั ั ัะฐัะฟัะพัััะฐะฝัะฝะฝัะผะธ ััััะฝัะผะธ ะดะฐะฝะฝัะผะธ."
echo "   ๐ก ะะตะบะพะผะตะฝะดัะตััั:"
echo "      - ะฃะฑะตะดะธัะตัั, ััะพ PostgreSQL ะดะพัััะฟะตะฝ ัะพะปัะบะพ ัะตัะตะท Docker ัะตัั"
echo "      - ะัะพะฒะตัััะต firewall ะฟัะฐะฒะธะปะฐ"
echo "      - ะะฐััะผะพััะธัะต ะฒะพะทะผะพะถะฝะพััั ัะผะตะฝั ะฟะพััะฐ ะฟะพ ัะผะพะปัะฐะฝะธั"

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ ะัะพะฒะตัะบะฐ ะทะฐะฒะตััะตะฝะฐ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "๐ ะะตะทัะผะต:"
echo "   โ Collation version mismatch - ะธัะฟัะฐะฒะปะตะฝะพ (ะตัะปะธ ะบะพะฝัะตะนะฝะตั ะฑัะป ะทะฐะฟััะตะฝ)"
echo "   โ๏ธ  Redis memory overcommit - ััะตะฑัะตั ะฝะฐัััะพะนะบะธ ะฝะฐ ัะพััะต"
echo "   โ๏ธ  Redis security warnings - ะฟัะพะฒะตัััะต ัะตัะตะฒัั ะบะพะฝัะธะณััะฐัะธั"
echo "   โ๏ธ  PostgreSQL auth failures - ะฝะพัะผะฐะปัะฝะพ ะดะปั ะธะฝัะตัะฝะตั-ะดะพัััะฟะฝัั ะฟะพััะพะฒ"
echo ""
echo "๐ก ะะพัะปะต ะธัะฟัะฐะฒะปะตะฝะธั collation version, ะฟัะตะดัะฟัะตะถะดะตะฝะธั ะดะพะปะถะฝั ะธััะตะทะฝััั"
echo "   ะฟัะธ ัะปะตะดัััะตะผ ะฟะพะดะบะปััะตะฝะธะธ ะบ ะฑะฐะทะต ะดะฐะฝะฝัั."

