{% extends "base.html" %}

{% block title %}
{{ translations.get('home', '–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞') }}
{% endblock %}

{% block content %}
<!-- –ü–æ–∏—Å–∫ -->
<div class="search-container">
    <input type="text" id="search-input" data-translate-placeholder="search_placeholder" placeholder="{{ translations.get('search_placeholder', '–ü–æ–∏—Å–∫ —Ç–µ–º...') }}" onkeyup="handleSearch(event)">
    <div class="search-results" id="search-results"></div>
</div>

<!-- –ì–∞–ª–µ—Ä–µ—è -->
<div class="gallery" id="gallery">
    <div class="gallery__container">
        <!-- –ö–∞–∂–¥—ã–π span –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É —Ç–µ–º—ã -->
        {% for topic in topics %}
        <span class="topic-card" data-topic-id="{{ topic.id }}" data-i="{{ loop.index0 }}">
            <img src="{{ topic.image_url }}" alt="{{ topic.name }}">
            <div class="card-overlay always-visible">
                <h3>{{ topic.name }}</h3>
                <p class="difficulty">{{ topic.difficulty }}</p>
                <p class="questions">{{ topic.questions_count }} <span data-translate="questions_count">{{ translations.get('questions_count', '–≤–æ–ø—Ä–æ—Å–æ–≤') }}</span></p>
                <div class="card-actions">
                    <button class="btn-start" onclick="handleStartTopic(event, {{ topic.id }})" data-translate="start_button">{{ translations.get('start_button', '–ù–∞—á–∞—Ç—å') }}</button>
                    <button class="btn-back" onclick="goBackFromCard(event)" data-translate="back_button">{{ translations.get('back_button', '–ù–∞–∑–∞–¥') }}</button>
                </div>
            </div>
        </span>
        {% endfor %}
    </div>
</div>

<!-- –î–µ—Ç–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ç–µ–º -->
<div class="topic-list-container">
    {% for topic in topics %}
    <div class="topic-item" data-topic-id="{{ topic.id }}" onclick="handleStartTopic(event, {{ topic.id }})">
        <div class="topic-info">
            <h3>{{ topic.name }}</h3>
            <p class="topic-questions">{{ topic.questions_count }} <span data-translate="questions_count">{{ translations.get('questions_count', '–≤–æ–ø—Ä–æ—Å–æ–≤') }}</span></p>
            {% set completed_tasks_count = topic.get('completed_tasks_count', 0) %}
            {% if completed_tasks_count is not none and topic.questions_count > 0 %}
                {% set progress_percentage = (completed_tasks_count / topic.questions_count * 100) | int %}
                <div class="progress-bar-container">
                    <div class="progress-bar" style="width: {{ progress_percentage }}%; transform: translateX(0);"></div>
                    <span class="progress-text">{{ progress_percentage }}% <span data-translate="completed">{{ translations.get('completed', '–∑–∞–≤–µ—Ä—à–µ–Ω–æ') }}</span> ({{ completed_tasks_count }}/{{ topic.questions_count }})</span>
                </div>
            {% elif topic.questions_count == 0 %}
                <p class="no-tasks" data-translate="no_tasks_in_topic">{{ translations.get('no_tasks_in_topic', '–ù–µ—Ç –∑–∞–¥–∞—á –≤ —Ç–µ–º–µ') }}</p>
            {% else %}
                <p class="progress-text" data-translate="not_started">{{ translations.get('not_started', '–ù–µ –Ω–∞—á–∞—Ç–æ') }}</p>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>



<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∫—Ä–∏–ø—Ç—ã -->
<script src='{{ get_js_url("topic-cards.js") }}'></script>
<script src='{{ get_js_url("search.js") }}'></script>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–ª–∏–Ω–∏–∏ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–æ–≤, –µ—Å–ª–∏ –µ—Å—Ç—å
document.addEventListener('DOMContentLoaded', function() {
    try {
        document.querySelectorAll('.topic-list-container .progress-bar-container').forEach(container => {
            const total = parseInt(container.getAttribute('data-total') || '0', 10);
            const completed = parseInt(container.getAttribute('data-completed') || '0', 10);
            const percent = total > 0 ? Math.floor((completed / total) * 100) : 0;
            const bar = container.querySelector('.progress-bar');
            const text = container.querySelector('.progress-text');
            if (bar) bar.style.width = `${percent}%`;
            if (text) text.innerHTML = `${percent}% <span data-translate="completed">{{ translations.get('completed', '–∑–∞–≤–µ—Ä—à–µ–Ω–æ') }}</span> (${completed}/${total})`;
        });
    } catch (e) {
        console.warn('Init progress render failed:', e);
    }
});

// –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —Ç–µ–º–∞–º —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º telegram_id
document.addEventListener('DOMContentLoaded', async function() {
    try {
        const isTelegram = typeof window.Telegram !== 'undefined' && window.Telegram.WebApp;
        let telegramId = isTelegram && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user ? window.Telegram.WebApp.initDataUnsafe.user.id : null;
        const lang = window.currentLanguage || '{{ current_language }}' || 'en';

        // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å telegram_id —á–µ—Ä–µ–∑ verify-init-data, –µ—Å–ª–∏ –æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞–ø—Ä—è–º—É—é
        if (isTelegram && !telegramId && window.Telegram.WebApp.initData) {
            try {
                const verifyResp = await fetch('/api/verify-init-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: window.Telegram.WebApp.initData })
                });
                if (verifyResp.ok) {
                    const data = await verifyResp.json();
                    telegramId = data.telegram_id || null;
                }
            } catch (e) {
                console.warn('verify-init-data failed:', e);
            }
        }

        if (!telegramId) return;

        const resp = await fetch(`/api/topics?language=${encodeURIComponent(lang)}&telegram_id=${encodeURIComponent(telegramId)}`);
        if (!resp.ok) return;
        const topics = await resp.json();

        // –ò–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º –ø–æ id
        const byId = new Map();
        topics.forEach(t => byId.set(String(t.id), t));

        // –û–±–Ω–æ–≤–ª—è–µ–º –±–ª–æ–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤ –¥–µ—Ç–∞–ª—å–Ω–æ–º —Å–ø–∏—Å–∫–µ
        document.querySelectorAll('.topic-list-container .topic-item').forEach(item => {
            const topicId = item.getAttribute('data-topic-id');
            const info = byId.get(String(topicId));
            if (!info) return;
            const total = info.questions_count || 0;
            const completed = info.completed_tasks_count || 0;
            const percent = total > 0 ? Math.floor((completed / total) * 100) : 0;

            let container = item.querySelector('.progress-bar-container');
            if (!container) {
                const wrapper = document.createElement('div');
                wrapper.className = 'progress-bar-container';
                wrapper.innerHTML = `
                    <div class="progress-bar" style="width: ${percent}%;"></div>
                    <span class="progress-text">${percent}% <span data-translate="completed">{{ translations.get('completed', '–∑–∞–≤–µ—Ä—à–µ–Ω–æ') }}</span> (${completed}/${total})</span>
                `;
                const topicInfo = item.querySelector('.topic-info');
                topicInfo && topicInfo.appendChild(wrapper);
            } else {
                const bar = container.querySelector('.progress-bar');
                const text = container.querySelector('.progress-text');
                if (bar) bar.style.width = `${percent}%`;
                if (text) text.innerHTML = `${percent}% <span data-translate="completed">{{ translations.get('completed', '–∑–∞–≤–µ—Ä—à–µ–Ω–æ') }}</span> (${completed}/${total})`;
            }
        });
    } catch (e) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å —Ç–µ–º:', e);
    }
});

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–ª–∏–∫–∞ –Ω–∞ –∫–Ω–æ–ø–∫—É "–ù–∞—á–∞—Ç—å"
function handleStartTopic(event, topicId) {
    console.log('üöÄ handleStartTopic called with topicId:', topicId);
    
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω–æ –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Telegram Web App
    function isTelegramWebApp() {
        return window.Telegram && window.Telegram.WebApp;
    }
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å —É—á–µ—Ç–æ–º —Ç–µ–∫—É—â–µ–≥–æ —è–∑—ã–∫–∞
    const currentLang = window.currentLanguage || 'en';
    const topicUrl = `/topic/${topicId}?lang=${currentLang}`;
    
    console.log('Navigating to:', topicUrl);
    
    // –ï—Å–ª–∏ –≤ Telegram Web App, –∏—Å–ø–æ–ª—å–∑—É–µ–º Telegram API –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    if (isTelegramWebApp()) {
        console.log('Using Telegram Web App navigation');
        window.Telegram.WebApp.navigateTo(topicUrl);
    } else {
        // –î–ª—è –æ–±—ã—á–Ω–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é
        console.log('Using standard browser navigation');
        window.location.href = topicUrl;
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ
window.handleStartTopic = handleStartTopic;
</script>
{% endblock %}