{% extends "base.html" %}

{% block title %}
{{ translations.get('home', '–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞') }}
{% endblock %}

{% block content %}
<!-- –ü–æ–∏—Å–∫ -->
<div class="search-container">
    <input type="text" id="search-input" data-translate-placeholder="search_placeholder" placeholder="{{ translations.get('search_placeholder', '–ü–æ–∏—Å–∫ —Ç–µ–º...') }}" onkeyup="handleSearch(event)">
    <div class="search-results" id="search-results"></div>
</div>

<!-- –ì–∞–ª–µ—Ä–µ—è -->
<div class="gallery" id="gallery">
    <div class="gallery__container">
        <!-- –ö–∞–∂–¥—ã–π span –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É —Ç–µ–º—ã -->
        {% for topic in topics %}
        <span style="--i:{{ loop.index0 }};" class="topic-card" data-topic-id="{{ topic.id }}">
            <img src="{{ topic.image_url }}" alt="{{ topic.name }}">
            <div class="card-overlay always-visible">
                <h3>{{ topic.name }}</h3>
                <p class="difficulty">{{ topic.difficulty }}</p>
                <p class="questions">{{ topic.questions_count }} <span data-translate="questions_count">{{ translations.get('questions_count', '–≤–æ–ø—Ä–æ—Å–æ–≤') }}</span></p>
                <div class="card-actions">
                    <button class="btn-start" onclick="handleStartTopic(event, {{ topic.id }})" data-translate="start_button">{{ translations.get('start_button', '–ù–∞—á–∞—Ç—å') }}</button>
                    <button class="btn-back" onclick="goBackFromCard(event)" data-translate="back_button">{{ translations.get('back_button', '–ù–∞–∑–∞–¥') }}</button>
                </div>
            </div>
        </span>
        {% endfor %}
    </div>
</div>

<!-- –î–µ—Ç–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ç–µ–º -->
<div class="topic-list-container">
    {% for topic in topics %}
    <div class="topic-item" onclick="handleStartTopic(event, {{ topic.id }})">
        <div class="topic-info">
            <h3>{{ topic.name }}</h3>
            <p class="topic-questions">{{ topic.questions_count }} <span data-translate="questions_count">{{ translations.get('questions_count', '–≤–æ–ø—Ä–æ—Å–æ–≤') }}</span></p>
            {% set completed_tasks_count = topic.get('completed_tasks_count', 0) %}
            {% if completed_tasks_count is not none and topic.questions_count > 0 %}
                {% set progress_percentage = (completed_tasks_count / topic.questions_count * 100) | int %}
                <div class="progress-bar-container">
                    <div class="progress-bar" style="width: {{ progress_percentage }}%;"></div>
                    <span class="progress-text">{{ progress_percentage }}% <span data-translate="completed">{{ translations.get('completed', '–∑–∞–≤–µ—Ä—à–µ–Ω–æ') }}</span> ({{ completed_tasks_count }}/{{ topic.questions_count }})</span>
                </div>
            {% elif topic.questions_count == 0 %}
                <p class="no-tasks" data-translate="no_tasks_in_topic">{{ translations.get('no_tasks_in_topic', '–ù–µ—Ç –∑–∞–¥–∞—á –≤ —Ç–µ–º–µ') }}</p>
            {% else %}
                <p class="progress-text" data-translate="not_started">{{ translations.get('not_started', '–ù–µ –Ω–∞—á–∞—Ç–æ') }}</p>
            {% endif %}
        </div>
        <button class="btn-start" onclick="handleStartTopic(event, {{ topic.id }})" data-translate="start_button">{{ translations.get('start_button', '–ù–∞—á–∞—Ç—å') }}</button>
    </div>
    {% endfor %}
</div>



<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∫—Ä–∏–ø—Ç—ã -->
<script src="{{ get_js_url("topic-cards.js") }}"></script>
<script src="{{ get_js_url("search.js") }}"></script>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–ª–∏–∫–∞ –Ω–∞ –∫–Ω–æ–ø–∫—É "–ù–∞—á–∞—Ç—å"
function handleStartTopic(event, topicId) {
    console.log('üöÄ handleStartTopic called with topicId:', topicId);
    
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω–æ –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Telegram Web App
    function isTelegramWebApp() {
        return window.Telegram && window.Telegram.WebApp;
    }
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å —É—á–µ—Ç–æ–º —Ç–µ–∫—É—â–µ–≥–æ —è–∑—ã–∫–∞
    const currentLang = window.currentLanguage || 'en';
    const topicUrl = `/topic/${topicId}?lang=${currentLang}`;
    
    console.log('Navigating to:', topicUrl);
    
    // –ï—Å–ª–∏ –≤ Telegram Web App, –∏—Å–ø–æ–ª—å–∑—É–µ–º Telegram API –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    if (isTelegramWebApp()) {
        console.log('Using Telegram Web App navigation');
        window.Telegram.WebApp.navigateTo(topicUrl);
    } else {
        // –î–ª—è –æ–±—ã—á–Ω–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é
        console.log('Using standard browser navigation');
        window.location.href = topicUrl;
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ
window.handleStartTopic = handleStartTopic;
</script>
{% endblock %}