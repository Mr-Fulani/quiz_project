{% extends "base.html" %}

{% block title %}{{ subtopic.name }} - {{ translations.get('tasks', '–ó–∞–¥–∞—á–∏') }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ get_css_url('comments.css') }}">
{% endblock %}

{% block content %}
<div class="container" id="tasks-root" data-subtopic-id="{{ subtopic.id }}" data-topic-id="{{ topic.id if topic else '' }}" data-language="{{ current_language }}">
    <header class="page-header">
        <div class="back-button" onclick="goBackFromTasks()">
            <i class="fas fa-arrow-left"></i>
            <span>{{ translations.get('back_button', '–ù–∞–∑–∞–¥') }}</span>
        </div>
        <h1>{{ subtopic.name }}</h1>
    </header>

    <div class="tasks-container">
        {% if tasks %}
            {% for task in tasks %}
            <div class="task-item" data-task-id="{{ task.id }}" data-solved="{{ task.is_solved | lower }}">
                <!-- –ö–∞—Ä—Ç–∏–Ω–∫–∞ –∑–∞–¥–∞—á–∏ -->
                {% if task.image_url %}
                <div class="task-image">
                    <img src="{{ task.image_url }}" alt="{{ translations.get('task_image', '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏') }}" loading="lazy">
                </div>
                {% endif %}

                <!-- –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ -->
                <div class="task-answers">
                    {% for answer in task.answers %}
                    <button class="answer-option" 
                            data-answer="{{ answer }}"
                            data-correct="{% if answer == task.correct_answer %}true{% else %}false{% endif %}"
                            data-explanation="{{ task.explanation }}">
                        {{ answer }}
                    </button>
                    {% endfor %}
                </div>

                <!-- –û–±—ä—è—Å–Ω–µ–Ω–∏–µ (—Å–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                <div class="task-explanation" id="explanation-{{ task.id }}" style="display: none;">
                    <div class="explanation-content">
                        <h4>{{ translations.get('explanation', '–û–±—ä—è—Å–Ω–µ–Ω–∏–µ') }}</h4>
                        <p>{{ task.explanation }}</p>
                    </div>
                </div>

                <!-- –°–µ–∫—Ü–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
                <div class="comments-section" id="comments-{{ task.translation_id }}" data-translation-id="{{ task.translation_id }}">
                    <h4>
                        {{ translations.get('comments', '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏') }}
                        <span class="comments-count">(0)</span>
                    </h4>
                    
                    <div class="comments-list" id="comments-list-{{ task.translation_id }}">
                        <div class="comments-loading">{{ translations.get('loading', '–ó–∞–≥—Ä—É–∑–∫–∞') }}...</div>
                    </div>
                    
                    <div class="comment-form" id="comment-form-{{ task.translation_id }}">
                        <textarea placeholder="{{ translations.get('add_comment', '–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π') }}..."></textarea>
                        <div class="comment-form-actions">
                            <div class="comment-form-left">
                                <input type="file" class="comment-image-input" accept="image/*" multiple>
                                <button class="comment-image-btn">üì∑ {{ translations.get('photo', '–§–æ—Ç–æ') }}</button>
                            </div>
                            <button class="comment-submit-btn">{{ translations.get('send', '–û—Ç–ø—Ä–∞–≤–∏—Ç—å') }}</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="no-tasks">
                <p>{{ translations.get('no_tasks_available', '–ó–∞–¥–∞—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã') }}</p>
            </div>
        {% endif %}
    </div>
</div>

<script src="{{ get_js_url('comments.js') }}"></script>
<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏ (–≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
window.initializeComments = function() {
    console.log('üîß Initializing comments...');
    
    // –ñ–¥—ë–º —Å–æ–∑–¥–∞–Ω–∏—è currentUser (–º–∞–∫—Å–∏–º—É–º 5 —Å–µ–∫—É–Ω–¥)
    const waitForUser = setInterval(() => {
        if (window.currentUser && window.currentUser.telegram_id) {
            clearInterval(waitForUser);
            
            const telegramId = window.currentUser.telegram_id;
            const username = window.currentUser.first_name || window.currentUser.username || 'User';
            
            console.log('‚úÖ Got user - Telegram ID:', telegramId, 'Username:', username);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏
            const sections = document.querySelectorAll('.comments-section');
            console.log('üìù Found comment sections:', sections.length);
            
            sections.forEach(section => {
                const translationId = section.dataset.translationId;
                console.log('üîç Section translation ID:', translationId);
                
                if (translationId && telegramId) {
                    const manager = new CommentsManager(translationId, telegramId, username);
                    manager.init();
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ HTML
                    if (!window.commentManagers) {
                        window.commentManagers = {};
                    }
                    window.commentManagers[translationId] = manager;
                    console.log('‚úÖ Initialized manager for translation:', translationId);
                } else {
                    console.warn('‚ö†Ô∏è Missing translation ID or telegram ID for section');
                }
            });
        }
    }, 100);
    
    // –¢–∞–π–º–∞—É—Ç —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        clearInterval(waitForUser);
        if (!window.currentUser || !window.currentUser.telegram_id) {
            console.error('‚ùå Failed to initialize comments: currentUser not found');
        }
    }, 5000);
}

// –ù–ï –∑–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω–æ –∏–∑ base.html –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
// –≠—Ç–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –∑–∞—Ç–∏—Ä–∞–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø—Ä–∏ SPA –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
</script>
{% endblock %} 