{% extends "base.html" %}

{% block title %}
{{ translations.get('top_users_title', '–¢–æ–ø —é–∑–µ—Ä–æ–≤') }}
{% endblock %}

{% block extra_head %}
<!-- Swiper CSS –∏ custom CSS –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ base.html –∫–∞–∫ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ -->
<!-- –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–±—Ä–æ—Å —Å—Ç–∏–ª–µ–π –ø—Ä–∏ AJAX –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->

<!-- Swiper JS -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script src="{{ get_js_url('top_users_swiper.js') }}"></script>

<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function openUserProfile(telegramId) {
    console.log('üë§ –§–£–ù–ö–¶–ò–Ø openUserProfile –í–´–ó–í–ê–ù–ê!');
    console.log('üë§ Telegram ID:', telegramId);
    console.log('üë§ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ—Ñ–∏–ª—è:', `/user_profile/${telegramId}`);
    
    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    window.location.href = `/user_profile/${telegramId}`;
}

// –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ–π –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –æ–Ω–∞ –Ω—É–∂–Ω–∞ –∏–∑ –¥—Ä—É–≥–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
window.openUserProfile = openUserProfile;
</script>

<!-- SVG —Ñ–∏–ª—å—Ç—Ä –ø–µ—Ä–µ–º–µ—â–µ–Ω –≤ base.html –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ -->
{% endblock %}

{% block content %}
<div class="top-users-container">
    <div class="filter-section">
        <div class="filter-controls">
            <div class="filter-group">
                <label class="filter-label" data-translate="gender">{{ translations.get('gender', '–ü–æ–ª') }}:</label>
                <select class="filter-select" id="gender-filter">
                    <option value="" data-translate="gender_placeholder">{{ translations.get('gender_placeholder', '–ü–æ–ª') }}</option>
                    <option value="male" data-translate="male">{{ translations.get('male', '–ú—É–∂—Å–∫–æ–π') }}</option>
                    <option value="female" data-translate="female">{{ translations.get('female', '–ñ–µ–Ω—Å–∫–∏–π') }}</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label" data-translate="age">{{ translations.get('age', '–í–æ–∑—Ä–∞—Å—Ç') }}:</label>
                <select class="filter-select" id="age-filter">
                    <option value="" data-translate="age_placeholder">{{ translations.get('age_placeholder', '–í–æ–∑—Ä–∞—Å—Ç') }}</option>
                    <option value="18-25">18-25</option>
                    <option value="26-35">26-35</option>
                    <option value="36-45">36-45</option>
                    <option value="46+">46+</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label" data-translate="technology">{{ translations.get('technology', '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è') }}:</label>
                <select class="filter-select" id="language-filter">
                    <option value="" data-translate="technology_placeholder">{{ translations.get('technology_placeholder', '–¢–µ–º–∞') }}</option>
                    {% if programming_languages %}
                        {% for lang in programming_languages %}
                            <option value="{{ lang.name }}">{{ lang.name }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label" data-translate="online_status">{{ translations.get('online_status', '–°—Ç–∞—Ç—É—Å') }}:</label>
                <select class="filter-select" id="online-filter">
                    <option value="" data-translate="all">{{ translations.get('all', '–í—Å–µ') }}</option>
                    <option value="true" data-translate="online">{{ translations.get('online', '–û–Ω–ª–∞–π–Ω') }}</option>
                </select>
            </div>
            
            <button class="filter-reset-btn" id="reset-filters" data-translate="reset_filters">
                {{ translations.get('reset_filters', '–°–±—Ä–æ—Å–∏—Ç—å') }}
            </button>
        </div>
    </div>
    
    <!-- –¢–æ–ø-5 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º—ã–µ) -->
    <div class="top-5-users">
        <div class="top-users-list" id="top-5-list">
        {% if top_users %}
                {% for user in top_users[:3] %}
            <div class="user-item" data-telegram-id="{{ user.telegram_id }}" data-user-index="{{ loop.index0 }}" onclick="event.stopPropagation(); openSwiperAtIndex({{ loop.index0 }});">
                <div class="user-rank">{{ loop.index }}</div>
                <div class="user-avatar-wrapper">
                    <img class="user-avatar" src="{{ user.avatar_url or '/static/images/default_avatar.png' }}" alt="{{ user.username }}">
                    {% if user.is_online %}
                    <div class="online-indicator"></div>
                    {% endif %}
                    {% if not user.is_online and user.last_seen_formatted %}
                    <div class="last-seen-badge" title="{{ translations.get('last_seen', '–ë—ã–ª –≤ —Å–µ—Ç–∏') }} {{ user.last_seen_formatted }}">
                        <i class="far fa-clock"></i>
                    </div>
                    {% endif %}
                </div>
                <div class="user-info">
                    <h3 class="user-username">{{ user.username }}</h3>
                    <p class="user-name">{{ user.first_name }} {{ user.last_name }}</p>
                    <div class="user-stats">
                        <div class="stat-item">
                            <span class="stat-label" data-translate="rating">{{ translations.get('rating', '–†–µ–π—Ç–∏–Ω–≥') }}:</span>
                            <span class="stat-value">{{ user.rating }}</span>
                        </div>
                        <div class="personal-info-item">
                            <span class="gender-icon">
                                {% if user.gender == 'male' %}
                                    ‚ôÇÔ∏è
                                {% elif user.gender == 'female' %}
                                    ‚ôÄÔ∏è
                                {% else %}
                                    ‚ùì
                                {% endif %}
                            </span>
                        </div>
                        <div class="personal-info-item">
                            <span class="age-info">
                                {% if user.age %}
                                    {{ user.age }} {{ translations.get('years_old', '–ª–µ—Ç') }}
                                {% else %}
                                    {{ translations.get('age_unknown', '–í–æ–∑—Ä–∞—Å—Ç –Ω–µ —É–∫–∞–∑–∞–Ω') }}
                                {% endif %}
                            </span>
                        </div>
                        <div class="personal-info-item">
                            <span class="grade-info grade-{{ user.grade or 'none' }}">
                                {% if user.grade %}
                                    {% if user.grade == 'junior' %}
                                        {{ translations.get('junior', 'Junior') }}
                                    {% elif user.grade == 'middle' %}
                                        {{ translations.get('middle', 'Middle') }}
                                    {% elif user.grade == 'senior' %}
                                        {{ translations.get('senior', 'Senior') }}
                                    {% else %}
                                        {{ user.grade }}
                                    {% endif %}
                                {% else %}
                                    {{ translations.get('grade_unknown', '–ì—Ä–µ–π–¥ –Ω–µ —É–∫–∞–∑–∞–Ω') }}
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">üèÜ</div>
                <p data-translate="no_top_users">{{ translations.get('no_top_users', '–ü–æ–∫–∞ –Ω–µ—Ç –ª—É—á—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π') }}</p>
            </div>
        {% endif %}
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ "–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏" -->
    {% if top_users %}
    <div class="show-all-section">
        <button class="show-all-btn" id="show-all-users" data-translate="show_all_users">
            {{ translations.get('show_all_users', '–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏') }} ({{ top_users|length }})
        </button>
    </div>
    {% endif %}

</div>

<!-- Backdrop –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (–í–ù–ï –ö–û–ù–¢–ï–ô–ù–ï–†–ê) -->
<div class="carousel-backdrop" id="carousel-backdrop"></div>

<!-- –°–≤–∞–π–ø-–∫–∞—Ä—É—Å–µ–ª—å –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–í–ù–ï –ö–û–ù–¢–ï–ô–ù–ï–†–ê - –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ position: fixed) -->
<div class="all-users-carousel" id="all-users-carousel" style="display: none;">
    <div class="swiper" id="users-swiper">
        <div class="swiper-wrapper">
            {% if top_users %}
            {% for user in top_users %}
                <div class="swiper-slide">
                    <div class="user-item" data-telegram-id="{{ user.telegram_id }}">
                        <!-- –ê–≤–∞—Ç–∞—Ä–∫–∞ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω -->
                        <img class="user-avatar" src="{{ user.avatar_url or '/static/images/default_avatar.png' }}" alt="{{ user.username }}">
                        {% if user.is_online %}
                        <div class="online-indicator"></div>
                        <div class="online-status-text" data-translate="online">{{ translations.get('online', '–í —Å–µ—Ç–∏') }}</div>
                        {% elif user.last_seen %}
                        <div class="last-seen-text" data-last-seen="{{ user.last_seen }}" data-translate-prefix="last_seen"></div>
                        {% endif %}
                        
                        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞ -->
                        <div class="user-info-container">
                            <div class="user-name">{{ user.first_name }} {{ user.last_name }}</div>
                            <div class="user-username">@{{ user.username }}</div>
                            
                            <div class="user-stats">
                                <div class="user-rating">
                                    ‚≠ê {{ user.rating }} {{ translations.get('rating', '–†–µ–π—Ç–∏–Ω–≥') }}
                                </div>
                                <div class="user-details">
                                    {% if user.gender %}
                                    <span class="gender-icon">
                                        {% if user.gender == 'male' %}
                                            ‚ôÇÔ∏è
                                        {% elif user.gender == 'female' %}
                                            ‚ôÄÔ∏è
                                        {% endif %}
                                    </span>
                                    {% endif %}
                                    {% if user.age %}
                                    <span class="age-info">
                                        {{ user.age }} {{ translations.get('years_old', '–ª–µ—Ç') }}
                                    </span>
                                    {% endif %}
                                    {% if user.grade %}
                                    <span class="grade-info grade-{{ user.grade }}">
                                        {% if user.grade == 'junior' %}
                                            {{ translations.get('junior', 'Junior') }}
                                        {% elif user.grade == 'middle' %}
                                            {{ translations.get('middle', 'Middle') }}
                                        {% elif user.grade == 'senior' %}
                                            {{ translations.get('senior', 'Senior') }}
                                        {% endif %}
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% endif %}
        </div>
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <div class="swiper-button-next"></div>
        <div class="swiper-button-prev"></div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ø—Ä—è–º–æ–π –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–Ω–µ —á–µ—Ä–µ–∑ SPA)
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Top users page loaded (DOMContentLoaded), initializing...');
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –∫–∞—Ä—É—Å–µ–ª–∏ –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (typeof window.initCarouselButtons === 'function') {
        console.log('üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –∫–∞—Ä—É—Å–µ–ª–∏ (DOMContentLoaded)');
        window.initCarouselButtons();
    } else {
        console.error('‚ùå window.initCarouselButtons not found yet (DOMContentLoaded)');
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç top_users.js –∑–∞–≥—Ä—É–∂–µ–Ω
    if (typeof window.TopUsersFilter === 'function') {
        console.log('‚úÖ TopUsersFilter class found, initializing...');
        window.topUsersFilter = new window.TopUsersFilter();
        console.log('‚úÖ TopUsersFilter initialized successfully');
    } else {
        console.error('‚ùå TopUsersFilter class not found! (DOMContentLoaded)');
    }
    
    console.log('‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (DOMContentLoaded)');
});

</script>
{% endblock %}
