{% extends "base.html" %}

{% block title %}
{{ translations.get('top_users_title', '–¢–æ–ø —é–∑–µ—Ä–æ–≤') }}
{% endblock %}

{% block extra_head %}
<style>
/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
</style>
<!-- SVG —Ñ–∏–ª—å—Ç—Ä –¥–ª—è —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–æ–π –æ–±–≤–æ–¥–∫–∏ -->
<svg style="position: absolute; width: 0; height: 0;" aria-hidden="true">
    <defs>
        <filter id="turbulent-displace" colorInterpolationFilters="sRGB" x="-20%" y="-20%" width="140%" height="140%">
            <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="10" result="noise1" seed="1" />
            <feOffset in="noise1" dx="0" dy="0" result="offsetNoise1">
                <animate attributeName="dy" values="700; 0" dur="6s" repeatCount="indefinite" calcMode="linear" />
            </feOffset>

            <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="10" result="noise2" seed="1" />
            <feOffset in="noise2" dx="0" dy="0" result="offsetNoise2">
                <animate attributeName="dy" values="0; -700" dur="6s" repeatCount="indefinite" calcMode="linear" />
            </feOffset>

            <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="10" result="noise1" seed="2" />
            <feOffset in="noise1" dx="0" dy="0" result="offsetNoise3">
                <animate attributeName="dx" values="490; 0" dur="6s" repeatCount="indefinite" calcMode="linear" />
            </feOffset>

            <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="10" result="noise2" seed="2" />
            <feOffset in="noise2" dx="0" dy="0" result="offsetNoise4">
                <animate attributeName="dx" values="0; -490" dur="6s" repeatCount="indefinite" calcMode="linear" />
            </feOffset>

            <feComposite in="offsetNoise1" in2="offsetNoise2" result="part1" />
            <feComposite in="offsetNoise3" in2="offsetNoise4" result="part2" />
            <feBlend in="part1" in2="part2" mode="color-dodge" result="combinedNoise" />

            <feDisplacementMap in="SourceGraphic" in2="combinedNoise" scale="30" xChannelSelector="R" yChannelSelector="B" />
        </filter>
    </defs>
</svg>
{% endblock %}

{% block content %}
<div class="top-users-container">
    <div class="filter-section">
        <div class="filter-controls">
            <div class="filter-group">
                <label class="filter-label" data-translate="gender">{{ translations.get('gender', '–ü–æ–ª') }}:</label>
                <select class="filter-select" id="gender-filter">
                    <option value="" data-translate="all">{{ translations.get('all', '–í—Å–µ') }}</option>
                    <option value="male" data-translate="male">{{ translations.get('male', '–ú—É–∂—Å–∫–æ–π') }}</option>
                    <option value="female" data-translate="female">{{ translations.get('female', '–ñ–µ–Ω—Å–∫–∏–π') }}</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label" data-translate="age">{{ translations.get('age', '–í–æ–∑—Ä–∞—Å—Ç') }}:</label>
                <select class="filter-select" id="age-filter">
                    <option value="" data-translate="all">{{ translations.get('all', '–í—Å–µ') }}</option>
                    <option value="18-25">18-25</option>
                    <option value="26-35">26-35</option>
                    <option value="36-45">36-45</option>
                    <option value="46+">46+</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label" data-translate="technology">{{ translations.get('technology', '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è') }}:</label>
                <select class="filter-select" id="language-filter">
                    <option value="" data-translate="all">{{ translations.get('all', '–í—Å–µ') }}</option>
                    {% if programming_languages %}
                        {% for lang in programming_languages %}
                            <option value="{{ lang.name }}">{{ lang.name }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label" data-translate="grade">{{ translations.get('grade', '–ì—Ä–µ–π–¥') }}:</label>
                <select class="filter-select" id="grade-filter">
                    <option value="" data-translate="all">{{ translations.get('all', '–í—Å–µ') }}</option>
                    <option value="junior">Junior</option>
                    <option value="middle">Middle</option>
                    <option value="senior">Senior</option>
                </select>
            </div>
            
            <button class="filter-reset-btn" id="reset-filters" data-translate="reset_filters">
                {{ translations.get('reset_filters', '–°–±—Ä–æ—Å–∏—Ç—å') }}
            </button>
        </div>
    </div>
    
    <div class="top-users-list">
        {% if top_users %}
            {% for user in top_users %}
            <div class="user-item" data-telegram-id="{{ user.telegram_id }}" onclick="openUserProfile({{ user.telegram_id }})">
                <div class="user-rank">{{ loop.index }}</div>
                <div class="user-avatar-wrapper">
                    <img class="user-avatar" src="{{ user.avatar_url or '/static/images/default_avatar.png' }}" alt="{{ user.username }}">
                    {% if user.is_online %}
                    <div class="online-indicator"></div>
                    {% endif %}
                </div>
                <div class="user-info">
                    <h3 class="user-username">{{ user.username }}</h3>
                    <p class="user-name">{{ user.first_name }} {{ user.last_name }}</p>
                    <div class="user-stats">
                        <div class="stat-item">
                            <span class="stat-label" data-translate="rating">{{ translations.get('rating', '–†–µ–π—Ç–∏–Ω–≥') }}:</span>
                            <span class="stat-value">{{ user.rating }}</span>
                        </div>
                        <div class="personal-info-item">
                            <span class="gender-icon">
                                {% if user.gender == 'male' %}
                                    ‚ôÇÔ∏è
                                {% elif user.gender == 'female' %}
                                    ‚ôÄÔ∏è
                                {% else %}
                                    ‚ùì
                                {% endif %}
                            </span>
                        </div>
                        <div class="personal-info-item">
                            <span class="age-info">
                                {% if user.age %}
                                    {{ user.age }} {{ translations.get('years_old', '–ª–µ—Ç') }}
                                {% else %}
                                    {{ translations.get('age_unknown', '–í–æ–∑—Ä–∞—Å—Ç –Ω–µ —É–∫–∞–∑–∞–Ω') }}
                                {% endif %}
                            </span>
                        </div>
                        <div class="personal-info-item">
                            <span class="grade-info grade-{{ user.grade or 'none' }}">
                                {% if user.grade %}
                                    {% if user.grade == 'junior' %}
                                        {{ translations.get('junior', 'Junior') }}
                                    {% elif user.grade == 'middle' %}
                                        {{ translations.get('middle', 'Middle') }}
                                    {% elif user.grade == 'senior' %}
                                        {{ translations.get('senior', 'Senior') }}
                                    {% else %}
                                        {{ user.grade }}
                                    {% endif %}
                                {% else %}
                                    {{ translations.get('grade_unknown', '–ì—Ä–µ–π–¥ –Ω–µ —É–∫–∞–∑–∞–Ω') }}
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">üèÜ</div>
                <p data-translate="no_top_users">{{ translations.get('no_top_users', '–ü–æ–∫–∞ –Ω–µ—Ç –ª—É—á—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π') }}</p>
            </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Ç–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Top users page loaded, initializing filters...');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç top_users.js –∑–∞–≥—Ä—É–∂–µ–Ω
    if (typeof window.TopUsersFilter === 'function') {
        console.log('‚úÖ TopUsersFilter class found, initializing...');
        window.topUsersFilter = new window.TopUsersFilter();
        console.log('‚úÖ TopUsersFilter initialized successfully');
    } else {
        console.error('‚ùå TopUsersFilter class not found! Trying to load script...');
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∫—Ä–∏–ø—Ç –µ—Å–ª–∏ –æ–Ω –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
        const script = document.createElement('script');
        script.src = '{{ get_js_url("top_users.js") }}';
        script.onload = function() {
            console.log('‚úÖ Top users script loaded, initializing...');
            if (typeof window.TopUsersFilter === 'function') {
                window.topUsersFilter = new window.TopUsersFilter();
                console.log('‚úÖ TopUsersFilter initialized after script load');
            } else {
                // Fallback - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                window.location.href = url.toString();
            }
        })
        .catch(error => {
            console.error('‚ùå –û—à–∏–±–∫–∞ AJAX –∑–∞–ø—Ä–æ—Å–∞:', error);
            // Fallback - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            window.location.href = url.toString();
        });
    }
    
    // –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–∞–µ–º –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—é –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (window.localizationService) {
        window.localizationService.updateInterface = function() {
            console.log('üö´ –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤');
            return;
        };
    }
    
    // –¢–∞–∫–∂–µ –æ—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏
    if (window.initLocalization) {
        window.initLocalization = function() {
            console.log('üö´ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤');
            return;
        };
    }
    
    // –û—Ç–∫–ª—é—á–∞–µ–º –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏
    document.removeEventListener('DOMContentLoaded', window.initLocalization);
    document.removeEventListener('click', function(e) {
        if (e.target.matches('[data-translate]')) {
            e.preventDefault();
            e.stopPropagation();
        }
    });
    
    // –û—Ç–∫–ª—é—á–∞–µ–º –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏
    document.addEventListener('DOMContentLoaded', function() {
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏
        const languageSelect = document.querySelector('select[name="language"]');
        if (languageSelect) {
            languageSelect.removeEventListener('change', function() {});
            console.log('üö´ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ —É–¥–∞–ª–µ–Ω—ã');
        }
    });
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    function restoreFilterState() {
        const urlParams = new URLSearchParams(window.location.search);
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ–ª–∞
        const gender = urlParams.get('gender');
        if (gender) {
            const genderSelect = document.getElementById('gender-filter');
            if (genderSelect) {
                genderSelect.value = gender;
            }
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –≤–æ–∑—Ä–∞—Å—Ç–∞
        const age = urlParams.get('age');
        if (age) {
            const ageSelect = document.getElementById('age-filter');
            if (ageSelect) {
                ageSelect.value = age;
            }
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä —è–∑—ã–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è
        const languagePref = urlParams.get('language_pref');
        if (languagePref) {
            const languageSelect = document.getElementById('language-filter');
            if (languageSelect) {
                // –ò—â–µ–º –æ–ø—Ü–∏—é –ø–æ —Ç–µ–∫—Å—Ç—É
                for (let option of languageSelect.options) {
                    if (option.text === languagePref) {
                        languageSelect.value = option.value;
                        break;
                    }
                }
            }
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä —Ä–µ–π—Ç–∏–Ω–≥–∞
        const rating = urlParams.get('rating');
        if (rating) {
            const ratingSelect = document.getElementById('rating-filter');
            if (ratingSelect) {
                ratingSelect.value = rating;
            }
        }
        
        console.log('‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä
    document.addEventListener('DOMContentLoaded', () => {
        console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TopUsersFilter...');
        window.topUsersFilter = new window.TopUsersFilter();
        console.log('‚úÖ TopUsersFilter –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    });
    
    console.log('‚úÖ –§—É–Ω–∫—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
</script>
{% endblock %}
