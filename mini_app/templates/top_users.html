{% extends "base.html" %}

{% block title %}
{{ translations.get('top_users_title', '–¢–æ–ø —é–∑–µ—Ä–æ–≤') }}
{% endblock %}

{% block extra_head %}
<!-- Swiper CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
<!-- Custom Swiper styles -->
<link rel="stylesheet" href="{{ get_css_url('top_users_swiper.css') }}" />

<!-- Swiper JS -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script src="{{ get_js_url('top_users_swiper.js') }}"></script>

<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function openUserProfile(telegramId) {
    console.log('üë§ –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', telegramId);
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–æ—Ñ–∏–ª—è
    alert('–û—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + telegramId);
}
</script>

<!-- SVG —Ñ–∏–ª—å—Ç—Ä –¥–ª—è —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–æ–π –æ–±–≤–æ–¥–∫–∏ -->
<svg style="position: absolute; width: 0; height: 0;" aria-hidden="true">
    <defs>
        <filter id="turbulent-displace" colorInterpolationFilters="sRGB" x="-20%" y="-20%" width="140%" height="140%">
            <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="10" result="noise1" seed="1" />
            <feOffset in="noise1" dx="0" dy="0" result="offsetNoise1">
                <animate attributeName="dy" values="700; 0" dur="6s" repeatCount="indefinite" calcMode="linear" />
            </feOffset>

            <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="10" result="noise2" seed="1" />
            <feOffset in="noise2" dx="0" dy="0" result="offsetNoise2">
                <animate attributeName="dy" values="0; -700" dur="6s" repeatCount="indefinite" calcMode="linear" />
            </feOffset>

            <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="10" result="noise1" seed="2" />
            <feOffset in="noise1" dx="0" dy="0" result="offsetNoise3">
                <animate attributeName="dx" values="490; 0" dur="6s" repeatCount="indefinite" calcMode="linear" />
            </feOffset>

            <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="10" result="noise2" seed="2" />
            <feOffset in="noise2" dx="0" dy="0" result="offsetNoise4">
                <animate attributeName="dx" values="0; -490" dur="6s" repeatCount="indefinite" calcMode="linear" />
            </feOffset>

            <feComposite in="offsetNoise1" in2="offsetNoise2" result="part1" />
            <feComposite in="offsetNoise3" in2="offsetNoise4" result="part2" />
            <feBlend in="part1" in2="part2" mode="color-dodge" result="combinedNoise" />

            <feDisplacementMap in="SourceGraphic" in2="combinedNoise" scale="30" xChannelSelector="R" yChannelSelector="B" />
        </filter>
    </defs>
</svg>
{% endblock %}

{% block content %}
<div class="top-users-container">
    <div class="filter-section">
        <div class="filter-controls">
            <div class="filter-group">
                <label class="filter-label" data-translate="gender">{{ translations.get('gender', '–ü–æ–ª') }}:</label>
                <select class="filter-select" id="gender-filter">
                    <option value="" data-translate="gender_placeholder">{{ translations.get('gender_placeholder', '–ü–æ–ª') }}</option>
                    <option value="male" data-translate="male">{{ translations.get('male', '–ú—É–∂—Å–∫–æ–π') }}</option>
                    <option value="female" data-translate="female">{{ translations.get('female', '–ñ–µ–Ω—Å–∫–∏–π') }}</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label" data-translate="age">{{ translations.get('age', '–í–æ–∑—Ä–∞—Å—Ç') }}:</label>
                <select class="filter-select" id="age-filter">
                    <option value="" data-translate="age_placeholder">{{ translations.get('age_placeholder', '–í–æ–∑—Ä–∞—Å—Ç') }}</option>
                    <option value="18-25">18-25</option>
                    <option value="26-35">26-35</option>
                    <option value="36-45">36-45</option>
                    <option value="46+">46+</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label" data-translate="technology">{{ translations.get('technology', '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è') }}:</label>
                <select class="filter-select" id="language-filter">
                    <option value="" data-translate="technology_placeholder">{{ translations.get('technology_placeholder', '–¢–µ–º–∞') }}</option>
                    {% if programming_languages %}
                        {% for lang in programming_languages %}
                            <option value="{{ lang.name }}">{{ lang.name }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label" data-translate="online_status">{{ translations.get('online_status', '–°—Ç–∞—Ç—É—Å') }}:</label>
                <select class="filter-select" id="online-filter">
                    <option value="" data-translate="all">{{ translations.get('all', '–í—Å–µ') }}</option>
                    <option value="true" data-translate="online">{{ translations.get('online', '–û–Ω–ª–∞–π–Ω') }}</option>
                </select>
            </div>
            
            <button class="filter-reset-btn" id="reset-filters" data-translate="reset_filters">
                {{ translations.get('reset_filters', '–°–±—Ä–æ—Å–∏—Ç—å') }}
            </button>
        </div>
    </div>
    
    <!-- –¢–æ–ø-5 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º—ã–µ) -->
    <div class="top-5-users">
        <div class="top-users-list" id="top-5-list">
        {% if top_users %}
                {% for user in top_users[:3] %}
            <div class="user-item" data-telegram-id="{{ user.telegram_id }}" onclick="openUserProfile('{{ user.telegram_id }}')">
                <div class="user-rank">{{ loop.index }}</div>
                <div class="user-avatar-wrapper">
                    <img class="user-avatar" src="{{ user.avatar_url or '/static/images/default_avatar.png' }}" alt="{{ user.username }}">
                    {% if user.is_online %}
                    <div class="online-indicator"></div>
                    {% endif %}
                </div>
                <div class="user-info">
                    <h3 class="user-username">{{ user.username }}</h3>
                    <p class="user-name">{{ user.first_name }} {{ user.last_name }}</p>
                    <div class="user-stats">
                        <div class="stat-item">
                            <span class="stat-label" data-translate="rating">{{ translations.get('rating', '–†–µ–π—Ç–∏–Ω–≥') }}:</span>
                            <span class="stat-value">{{ user.rating }}</span>
                        </div>
                        <div class="personal-info-item">
                            <span class="gender-icon">
                                {% if user.gender == 'male' %}
                                    ‚ôÇÔ∏è
                                {% elif user.gender == 'female' %}
                                    ‚ôÄÔ∏è
                                {% else %}
                                    ‚ùì
                                {% endif %}
                            </span>
                        </div>
                        <div class="personal-info-item">
                            <span class="age-info">
                                {% if user.age %}
                                    {{ user.age }} {{ translations.get('years_old', '–ª–µ—Ç') }}
                                {% else %}
                                    {{ translations.get('age_unknown', '–í–æ–∑—Ä–∞—Å—Ç –Ω–µ —É–∫–∞–∑–∞–Ω') }}
                                {% endif %}
                            </span>
                        </div>
                        <div class="personal-info-item">
                            <span class="grade-info grade-{{ user.grade or 'none' }}">
                                {% if user.grade %}
                                    {% if user.grade == 'junior' %}
                                        {{ translations.get('junior', 'Junior') }}
                                    {% elif user.grade == 'middle' %}
                                        {{ translations.get('middle', 'Middle') }}
                                    {% elif user.grade == 'senior' %}
                                        {{ translations.get('senior', 'Senior') }}
                                    {% else %}
                                        {{ user.grade }}
                                    {% endif %}
                                {% else %}
                                    {{ translations.get('grade_unknown', '–ì—Ä–µ–π–¥ –Ω–µ —É–∫–∞–∑–∞–Ω') }}
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">üèÜ</div>
                <p data-translate="no_top_users">{{ translations.get('no_top_users', '–ü–æ–∫–∞ –Ω–µ—Ç –ª—É—á—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π') }}</p>
            </div>
        {% endif %}
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ "–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏" -->
    {% if top_users %}
    <div class="show-all-section">
        <button class="show-all-btn" id="show-all-users" data-translate="show_all_users">
            {{ translations.get('show_all_users', '–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏') }} ({{ top_users|length }})
        </button>
    </div>
    {% endif %}

    <!-- –°–≤–∞–π–ø-–∫–∞—Ä—É—Å–µ–ª—å –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Å–∫—Ä—ã—Ç–∞—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
    <div class="all-users-carousel" id="all-users-carousel" style="display: none;">
        <h2 class="section-title" data-translate="all_users_title">{{ translations.get('all_users_title', '–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏') }}</h2>
        <div class="swiper" id="users-swiper">
            <div class="swiper-wrapper">
                {% if top_users %}
                {% for user in top_users[3:] %}
                    <div class="swiper-slide">
                        <div class="user-item" data-telegram-id="{{ user.telegram_id }}" onclick="openUserProfile('{{ user.telegram_id }}')">
                            <!-- –ê–≤–∞—Ç–∞—Ä–∫–∞ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω -->
                            <img class="user-avatar" src="{{ user.avatar_url or '/static/images/default_avatar.png' }}" alt="{{ user.username }}">
                            
                            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞ -->
                            <div class="user-info-container">
                                <div class="user-name">{{ user.first_name }} {{ user.last_name }}</div>
                                <div class="user-username">@{{ user.username }}</div>
                                
                                <div class="user-stats">
                                    <div class="user-rating">
                                        ‚≠ê {{ user.rating }} {{ translations.get('rating', '–†–µ–π—Ç–∏–Ω–≥') }}
                                    </div>
                                    <div class="user-details">
                                        <span class="gender-icon">
                                            {% if user.gender == 'male' %}
                                                ‚ôÇÔ∏è
                                            {% elif user.gender == 'female' %}
                                                ‚ôÄÔ∏è
                                            {% else %}
                                                ‚ùì
                                            {% endif %}
                                        </span>
                                        <span class="age-info">
                                            {% if user.age %}
                                                {{ user.age }} {{ translations.get('years_old', '–ª–µ—Ç') }}
                                            {% endif %}
                                        </span>
                                        <span class="grade-info">
                                            {% if user.grade %}
                                                {% if user.grade == 'junior' %}
                                                    {{ translations.get('junior', 'Junior') }}
                                                {% elif user.grade == 'middle' %}
                                                    {{ translations.get('middle', 'Middle') }}
                                                {% elif user.grade == 'senior' %}
                                                    {{ translations.get('senior', 'Senior') }}
                                                {% endif %}
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
            <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
            <div class="swiper-pagination"></div>
            <div class="swiper-button-next"></div>
            <div class="swiper-button-prev"></div>
        </div>
        
        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–≤–∞–π–ø–∞ -->
        <div class="swipe-indicator">‚Üê –°–≤–∞–π–ø–∞–π—Ç–µ ‚Üí</div>
        
        <!-- –ö–Ω–æ–ø–∫–∞ "–°–∫—Ä—ã—Ç—å" —É–±—Ä–∞–Ω–∞ - –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –æ–±–ª–∞—Å—Ç–∏ -->
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ø—Ä—è–º–æ–π –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–Ω–µ —á–µ—Ä–µ–∑ SPA)
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Top users page loaded (DOMContentLoaded), initializing...');
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –∫–∞—Ä—É—Å–µ–ª–∏ –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (typeof window.initCarouselButtons === 'function') {
        console.log('üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –∫–∞—Ä—É—Å–µ–ª–∏ (DOMContentLoaded)');
        window.initCarouselButtons();
    } else {
        console.error('‚ùå window.initCarouselButtons not found yet (DOMContentLoaded)');
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç top_users.js –∑–∞–≥—Ä—É–∂–µ–Ω
    if (typeof window.TopUsersFilter === 'function') {
        console.log('‚úÖ TopUsersFilter class found, initializing...');
        window.topUsersFilter = new window.TopUsersFilter();
        console.log('‚úÖ TopUsersFilter initialized successfully');
    } else {
        console.error('‚ùå TopUsersFilter class not found! (DOMContentLoaded)');
    }
    
    console.log('‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (DOMContentLoaded)');
});

</script>
{% endblock %}
