{% extends "base.html" %}

{% block title %}
{{ translations.get('settings_title', '–ù–∞—Å—Ç—Ä–æ–π–∫–∏') }}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ get_css_url('settings.css') }}">
{% endblock %}

{% block extra_js %}
<script src="{{ get_js_url('feedback.js') }}"></script>
{% endblock %}

{% block content %}
<div class="settings-container">
    
    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —è–∑—ã–∫–∞ -->
    <div class="settings-section">
        <h2 data-translate="language_settings">{{ translations.get('language_settings', '–Ø–∑—ã–∫') }}</h2>
        <div class="language-selector">
            {% for lang in supported_languages %}
            <button 
                class="language-btn {% if lang == current_language %}active{% endif %}" 
                onclick="changeLanguage('{{ lang }}')"
                data-lang="{{ lang }}"
            >
                {% if lang == 'en' %}üá∫üá∏ English{% endif %}
                {% if lang == 'ru' %}üá∑üá∫ –†—É—Å—Å–∫–∏–π{% endif %}
            </button>
            {% endfor %}
        </div>
    </div>
    
    <!-- –î—Ä—É–≥–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <div class="settings-section">
        <h2 data-translate="notifications">{{ translations.get('notifications', '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è') }}</h2>
        <div class="setting-item">
            <label class="switch">
                <input type="checkbox" id="notifications-toggle" checked>
                <span class="slider round"></span>
            </label>
            <span data-translate="notifications">{{ translations.get('notifications', '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è') }}</span>
        </div>
    </div>
    
    <!-- –°–∏—Å—Ç–µ–º–∞ –¥–æ–Ω–∞—Ç–æ–≤ -->
    <div class="settings-section">
        <h2 data-translate="support_project">{{ translations.get('support_project', '–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–µ–∫—Ç') }}</h2>
        <div class="donation-container">
            <p class="donation-description" data-translate="donation_description">
                {{ translations.get('donation_description', '–ü–æ–¥–¥–µ—Ä–∂–∏—Ç–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É —ç—Ç–æ–≥–æ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è') }}
            </p>
            
            <div class="donation-form">
                <h3 data-translate="donation_amount">{{ translations.get('donation_amount', '–°—É–º–º–∞ –¥–æ–Ω–∞—Ç–∞') }}</h3>
                
                <!-- –í—ã–±–æ—Ä —Å—É–º–º—ã -->
                <div class="amount-selector">
                    <span class="amount-option" data-amount="1">$1</span>
                    <span class="amount-option" data-amount="3">$3</span>
                    <span class="amount-option selected" data-amount="5">$5</span>
                    <span class="amount-option" data-amount="10">$10</span>
                    <span class="amount-option" data-amount="25">$25</span>
                    <span class="amount-option" data-amount="50">$50</span>
                </div>
                
                <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Å—É–º–º—ã -->
                <div class="amount-input-container">
                    <input type="number" class="amount-input" min="1" step="0.01" 
                           data-translate-placeholder="donation_amount_placeholder" 
                           placeholder="{{ translations.get('donation_amount_placeholder', '–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É') }}">
                </div>
                
                <!-- –í—ã–±–æ—Ä –≤–∞–ª—é—Ç—ã -->
                <div class="currency-selector">
                    <span class="currency-option selected" data-currency="usd" data-translate="donation_currency_usd">
                        {{ translations.get('donation_currency_usd', 'USD ($)') }}
                    </span>
                    <span class="currency-option" data-currency="eur" data-translate="donation_currency_eur">
                        {{ translations.get('donation_currency_eur', 'EUR (‚Ç¨)') }}
                    </span>
                    <span class="currency-option" data-currency="rub" data-translate="donation_currency_rub">
                        {{ translations.get('donation_currency_rub', 'RUB (‚ÇΩ)') }}
                    </span>
                </div>
                
                <!-- –ü–æ–ª—è –≤–≤–æ–¥–∞ -->
                <div class="input-group">
                    <label data-translate="donation_name_placeholder">{{ translations.get('donation_name_placeholder', '–í–∞—à–µ –∏–º—è') }}</label>
                    <input type="text" class="donation-name" required
                           data-translate-placeholder="donation_name_placeholder" 
                           placeholder="{{ translations.get('donation_name_placeholder', '–í–∞—à–µ –∏–º—è') }}">
                </div>
                
                <div class="input-group">
                    <label data-translate="donation_email_placeholder">{{ translations.get('donation_email_placeholder', '–í–∞—à email (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)') }}</label>
                    <input type="email" class="donation-email"
                           data-translate-placeholder="donation_email_placeholder" 
                           placeholder="{{ translations.get('donation_email_placeholder', '–í–∞—à email (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)') }}">
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–Ω–∞—Ç–∞ -->
                <button class="donate-btn" type="button">
                    <span data-translate="donate_button">{{ translations.get('donate_button', '–ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞—Ç—å') }}</span>
                </button>
                
                <p class="min-amount" data-translate="donation_min_amount">
                    {{ translations.get('donation_min_amount', '–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: $1') }}
                </p>
            </div>
        </div>
    </div>
    
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ -->
    <div class="settings-section">
        <h2 data-translate="about">{{ translations.get('about', '–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏') }}</h2>
        <div class="app-info">
            <p><strong data-translate="version">{{ translations.get('version', '–í–µ—Ä—Å–∏—è') }}</strong>: 1.0.0</p>
            <p data-translate="app_description">Educational quiz app for learning various topics</p>
            
            <!-- –ö–Ω–æ–ø–∫–∞ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º" -->
            <div class="share-app-container">
                <button class="share-app-btn" type="button" onclick="if(window.shareApp) window.shareApp.showQRCode(); else console.log('ShareApp not ready');">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/>
                    </svg>
                    <span data-translate="share_app">{{ translations.get('share_app', '–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º') }}</span>
                </button>
                <p class="share-app-description" data-translate="share_app_description">
                    {{ translations.get('share_app_description', '–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º —Å –¥—Ä—É–∑—å—è–º–∏') }}
                </p>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤) -->
            <div class="admin-panel-container" id="admin-panel-container" style="display: none;">
                <button class="admin-panel-btn" type="button" onclick="window.location.href='/admin-analytics'">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                        <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                    </svg>
                    <span data-translate="admin_panel">{{ translations.get('admin_panel', '–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å') }}</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å -->
    <div class="settings-section">
        <h2 data-translate="feedback_title">{{ translations.get('feedback_title', '–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å') }}</h2>
        <div class="feedback-container">
            <p class="feedback-description" data-translate="feedback_description">
                {{ translations.get('feedback_description', '–°–æ–æ–±—â–∏—Ç–µ –Ω–∞–º –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç–µ —É–ª—É—á—à–µ–Ω–∏—è') }}
            </p>
            
            <!-- –í—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
            <div class="feedback-category-selector">
                <span class="category-option selected" data-category="bug" data-translate="feedback_category_bug">
                    üêõ {{ translations.get('feedback_category_bug', '–ë–∞–≥') }}
                </span>
                <span class="category-option" data-category="suggestion" data-translate="feedback_category_suggestion">
                    üí° {{ translations.get('feedback_category_suggestion', '–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ') }}
                </span>
                <span class="category-option" data-category="complaint" data-translate="feedback_category_complaint">
                    üòû {{ translations.get('feedback_category_complaint', '–ñ–∞–ª–æ–±–∞') }}
                </span>
                <span class="category-option" data-category="other" data-translate="feedback_category_other">
                    üìù {{ translations.get('feedback_category_other', '–î—Ä—É–≥–æ–µ') }}
                </span>
            </div>
            
            <!-- –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è -->
            <textarea class="feedback-message" 
                      data-translate-placeholder="feedback_message_placeholder" 
                      placeholder="{{ translations.get('feedback_message_placeholder', '–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ...') }}" 
                      rows="5"></textarea>
            
            <!-- –ö–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
            <div class="feedback-actions">
                <button class="send-feedback-btn" type="button">
                    <span data-translate="send_feedback">{{ translations.get('send_feedback', '–û—Ç–ø—Ä–∞–≤–∏—Ç—å') }}</span>
                </button>
                <button class="contact-admin-btn" type="button">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                        <path d="M12 12.713l-11.985-9.713h23.971l-11.986 9.713zm-5.425-1.822l-6.575-5.329v12.501l6.575-7.172zm10.85 0l6.575 7.172v-12.501l-6.575 5.329zm-1.557 1.261l-3.868 3.135-3.868-3.135-8.11 8.848h23.956l-8.11-8.848z"/>
                    </svg>
                    <span data-translate="contact_admin">{{ translations.get('contact_admin', '–ù–∞–ø–∏—Å–∞—Ç—å –∞–¥–º–∏–Ω—É') }}</span>
                </button>
            </div>
            
            <!-- –°—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
            <div class="feedback-status" style="display: none;"></div>
        </div>
    </div>
</div>

<script>
// –ü–µ—Ä–µ–¥–∞–µ–º admin_telegram_id –≤ JavaScript
window.ADMIN_TELEGRAM_ID = "{{ admin_telegram_id }}";

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω–æ –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Telegram Web App
function isTelegramWebApp() {
    return window.Telegram && window.Telegram.WebApp;
}

// –§—É–Ω–∫—Ü–∏—è changeLanguage —Ç–µ–ø–µ—Ä—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ –≤ base.html

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–π
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîß Settings page DOM loaded');
    console.log('üîß window.localizationService:', window.localizationService);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    const notificationsEnabled = localStorage.getItem('notifications') !== 'false';
    const savedLanguage = localStorage.getItem('selectedLanguage');
    
    let notificationsToggle = document.getElementById('notifications-toggle');
    if (notificationsToggle) {
        notificationsToggle.checked = notificationsEnabled;
    }
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —è–∑—ã–∫ –∏ –æ–Ω –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º
    if (savedLanguage && savedLanguage !== window.currentLanguage) {
        console.log('Restoring saved language:', savedLanguage);
        window.currentLanguage = savedLanguage;
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.querySelectorAll('.language-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        const activeBtn = document.querySelector(`[data-lang="${savedLanguage}"]`);
        if (activeBtn) {
            activeBtn.classList.add('active');
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–π
    if (notificationsToggle) {
        notificationsToggle.addEventListener('change', function(e) {
            localStorage.setItem('notifications', e.target.checked);
        });
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    checkAdminAccess();
});

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∞
async function checkAdminAccess() {
    try {
        // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ window (—É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ base.html)
        const profileData = window.userProfileData;
        
        if (profileData && profileData.is_admin) {
            console.log('‚úÖ User is admin, showing admin panel button');
            const adminPanelContainer = document.getElementById('admin-panel-container');
            if (adminPanelContainer) {
                adminPanelContainer.style.display = 'block';
            }
        } else {
            console.log('‚ö†Ô∏è User is not admin, hiding admin panel button');
        }
    } catch (error) {
        console.error('‚ùå Error checking admin access:', error);
    }
}
</script>
{% endblock %}