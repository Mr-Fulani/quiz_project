<!DOCTYPE html>
<html lang="{{ current_language or 'en' }}">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>{% block title %}{{ translations.get('home', '–ú–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ') }}{% endblock %}</title>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —à—Ä–∏—Ñ—Ç–æ–≤ -->
<!--    <link rel="stylesheet" href="/static/css/fonts.css">-->

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å—Ç–∏–ª–∏ -->
    <link rel="stylesheet" href="/static/css/styles.css?v=1.9">
    
    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü -->
    {% block extra_css %}{% endblock %}

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Ionicons –¥–ª—è –∏–∫–æ–Ω–æ–∫ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–ª—è –º–µ–Ω—é) -->
    <script src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
</head>
<body>
    <!-- –°–ª–æ–π 1: –¢—ë–º–Ω—ã–π –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω -->
    <div class="background-layer"></div>

    <!-- –°–ª–æ–π 2: –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="content">
        {% block content %}
        <!-- —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
        {% endblock %}
    </div>
    </button>

    <!-- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é -->
    <nav class="navigation">
        <ul>
            <li class="list {% if request.url.path == '/' or request.url.path.startswith('/topic/') %}active{% endif %}" data-href="/">
                <a href="/?lang={{ current_language or 'en' }}">
                    <span class="icon"><ion-icon name="home-outline"></ion-icon></span>
                    <span class="text">{{ translations.get('home', '–ì–ª–∞–≤–Ω–∞—è') }}</span>
                </a>
            </li>
            <li class="list {% if request.url.path.startswith('/profile') %}active{% endif %}" data-href="/profile">
                <a href="/profile?lang={{ current_language or 'en' }}">
                    <span class="icon"><ion-icon name="person-outline"></ion-icon></span>
                    <span class="text">{{ translations.get('profile', '–ü—Ä–æ—Ñ–∏–ª—å') }}</span>
                </a>
            </li>
            <li class="list {% if request.url.path == '/achievements' %}active{% endif %}" data-href="/achievements">
                <a href="/achievements?lang={{ current_language or 'en' }}">
                    <span class="icon"><ion-icon name="trophy-outline"></ion-icon></span>
                    <span class="text">{{ translations.get('achievements', '–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è') }}</span>
                </a>
            </li>
            <li class="list {% if request.url.path == '/statistics' %}active{% endif %}" data-href="/statistics">
                <a href="/statistics?lang={{ current_language or 'en' }}">
                    <span class="icon"><ion-icon name="stats-chart-outline"></ion-icon></span>
                    <span class="text">{{ translations.get('statistics', '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞') }}</span>
                </a>
            </li>
            <li class="list {% if request.url.path == '/settings' %}active{% endif %}" data-href="/settings">
                <a href="/settings?lang={{ current_language or 'en' }}">
                    <span class="icon"><ion-icon name="settings-outline"></ion-icon></span>
                    <span class="text">{{ translations.get('settings', '–ù–∞—Å—Ç—Ä–æ–π–∫–∏') }}</span>
                </a>
            </li>
            <div class="indicator"></div>
        </ul>
    </nav>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏
        window.currentLanguage = '{{ current_language or "en" }}';
        window.translations = {{ translations | tojson }};
        window.supportedLanguages = {{ supported_languages | tojson }};
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        window.currentUser = null;
        window.isUserInitialized = false;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        async function initializeUser() {
            console.log('üöÄ Initializing user...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ Telegram Web App
            if (typeof window.Telegram === 'undefined' || !window.Telegram.WebApp) {
                console.log('‚ö†Ô∏è Not in Telegram Web App, skipping user initialization');
                return;
            }
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º initData –æ—Ç Telegram
                const initData = window.Telegram.WebApp.initData;
                console.log('üì± Got initData from Telegram:', initData ? 'present' : 'missing');
                
                if (!initData) {
                    console.log('‚ùå No initData available');
                    return;
                }
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
                const response = await fetch('/api/verify-init-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ initData: initData })
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    console.log('‚úÖ User data received:', userData);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ
                    window.currentUser = userData;
                    window.isUserInitialized = true;
                    
                    // –í—ã–∑—ã–≤–∞–µ–º callback –µ—Å–ª–∏ –æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
                    if (window.onUserInitialized) {
                        window.onUserInitialized(userData);
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –µ—Å–ª–∏ –º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–æ—Ñ–∏–ª—è
                    if (window.location.pathname === '/profile' && window.initProfilePage) {
                        console.log('üîÑ Reinitializing profile page with user data');
                        window.initProfilePage();
                    }
                    
                } else {
                    console.error('‚ùå Failed to verify initData:', response.status, response.statusText);
                }
                
            } catch (error) {
                console.error('‚ùå Error initializing user:', error);
            }
        }
        
        // Magic Navigation Menu Script —Å AJAX –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π
        const list = document.querySelectorAll('.list');
        const contentContainer = document.querySelector('.content');
        
        function activeLink(e){
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏
            e.preventDefault();
            e.stopPropagation();
            
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            list.forEach((item) => item.classList.remove('active'));
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º—É li
            const parentLi = this.closest('.list');
            if (parentLi) {
                parentLi.classList.add('active');
            }
            
            // –ü–æ–ª—É—á–∞–µ–º URL –∏–∑ href
            const href = this.getAttribute('href');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç —á–µ—Ä–µ–∑ AJAX
            loadPage(href);
        }
        
        async function loadPage(url) {
            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                contentContainer.style.opacity = '0.7';
                
                const response = await fetch(url, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (response.ok) {
                    const html = await response.text();
                    
                    // –ü–∞—Ä—Å–∏–º HTML –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newContent = doc.querySelector('.content');
                    
                    if (newContent) {
                        // –ü–ª–∞–≤–Ω–æ –∑–∞–º–µ–Ω—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
                        setTimeout(() => {
                            // –í–ê–ñ–ù–û: –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                            if (window.galleryController) {
                                window.galleryController.resetState();
                            }
                            
                            contentContainer.innerHTML = newContent.innerHTML;
                            contentContainer.style.opacity = '1';
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º URL –≤ –±—Ä–∞—É–∑–µ—Ä–µ
                            window.history.pushState({}, '', url);
                            
                            // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç—ã –∫–∞—Ä—Ç–æ—á–µ–∫ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                            if (window.initTopicCards) {
                                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∏–ª–µ–π
                                setTimeout(() => {
                                    console.log('üîÑ Reinitializing topic cards after page load');
                                    window.initTopicCards();
                                }, 100);
                            }

                            // –ï–°–õ–ò –ó–ê–ì–†–£–ñ–ï–ù–ê –°–¢–†–ê–ù–ò–¶–ê –ü–†–û–§–ò–õ–Ø - –í–´–ó–´–í–ê–ï–ú –ï–ï –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Æ
                            if (url === '/profile' && typeof window.initProfilePage === 'function') {
                                setTimeout(() => {
                                    console.log('üöÄ Calling initProfilePage for profile page.');
                                    window.initProfilePage();
                                }, 100);
                            }
                            
                            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                            loadPageSpecificScripts(url);
                        }, 200);
                    }
                } else {
                    // –ï—Å–ª–∏ AJAX –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –¥–µ–ª–∞–µ–º –æ–±—ã—á–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥
                    window.location.href = url;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã:', error);
                // Fallback –∫ –æ–±—ã—á–Ω–æ–º—É –ø–µ—Ä–µ—Ö–æ–¥—É
                window.location.href = url;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function loadPageSpecificScripts(url) {
            console.log('üìú Loading page-specific scripts for:', url);
            
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Å–∫—Ä–∏–ø—Ç—ã
            const dynamicScripts = document.querySelectorAll('script[data-dynamic="true"]');
            dynamicScripts.forEach(script => script.remove());
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∫—Ä–∏–ø—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            if (url.startsWith('/topic/')) {
                const script = document.createElement('script');
                script.setAttribute('data-dynamic', 'true');
                script.src = '/static/js/topic-detail.js?v=1.2';
                script.onload = function() {
                    console.log('‚úÖ Topic detail script loaded via base template');
                };
                document.head.appendChild(script);
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" –±—Ä–∞—É–∑–µ—Ä–∞
        window.addEventListener('popstate', function(e) {
            loadPage(window.location.pathname);
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π —Ç–æ–ª—å–∫–æ –∫ —Å—Å—ã–ª–∫–∞–º –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        document.querySelectorAll('.navigation a').forEach((link) => {
            link.addEventListener('click', activeLink);
        });

        // **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ**
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
        document.addEventListener('DOMContentLoaded', function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞–∂–∞—Ç–∏—è "–Ω–∞–∑–∞–¥"
            if (performance.navigation.type !== performance.navigation.TYPE_BACK_FORWARD) {
                loadPage(window.location.pathname);
            }
        });
        
        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö —Å–∫—Ä–∏–ø—Ç–∞—Ö
        window.initializeUser = initializeUser;
        window.loadPage = loadPage;
    </script>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∫—Ä–∏–ø—Ç—ã -->
    {% block extra_js %}
    {% endblock %}
</body>
</html>