{% extends "base.html" %}

{% block title %}
{{ translations.get('top_users_title', '–¢–æ–ø —é–∑–µ—Ä–æ–≤') }}
{% endblock %}

{% block extra_head %}
<!-- Swiper CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
<!-- Custom Swiper styles -->
<link rel="stylesheet" href="{{ get_css_url('top_users_swiper.css') }}?v=1.1&t={{ range(1000, 9999) | random }}&force={{ range(1000, 9999) | random }}" />

<!-- Swiper JS -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<script>
console.log('üîß –ü–†–Ø–ú–û–ô –¢–ï–°–¢: Swiper –∑–∞–≥—Ä—É–∂–µ–Ω?', typeof Swiper);
console.log('üîß –ü–†–Ø–ú–û–ô –¢–ï–°–¢: –î–æ–∫—É–º–µ–Ω—Ç –≥–æ—Ç–æ–≤?', document.readyState);

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function openUserProfile(telegramId) {
    console.log('üë§ –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', telegramId);
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–æ—Ñ–∏–ª—è
    alert('–û—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + telegramId);
}

// –ü—Ä–æ—Å—Ç–∞—è –æ—Ç–ª–∞–¥–∫–∞ –∫–Ω–æ–ø–∫–∏
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîß –û–¢–õ–ê–î–ö–ê: DOM –∑–∞–≥—Ä—É–∂–µ–Ω');
    
    const showAllBtn = document.getElementById('show-all-users');
    const carousel = document.getElementById('all-users-carousel');
    
    console.log('üîß –û–¢–õ–ê–î–ö–ê: showAllBtn –Ω–∞–π–¥–µ–Ω?', !!showAllBtn);
    console.log('üîß –û–¢–õ–ê–î–ö–ê: carousel –Ω–∞–π–¥–µ–Ω?', !!carousel);
    
    if (showAllBtn) {
        console.log('üîß –û–¢–õ–ê–î–ö–ê: –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞');
        showAllBtn.addEventListener('click', function(e) {
            console.log('üîß –û–¢–õ–ê–î–ö–ê: –ö–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞!');
            e.preventDefault();
            
            if (carousel) {
                console.log('üîß –û–¢–õ–ê–î–ö–ê: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—É—Å–µ–ª—å');
                showAllBtn.style.display = 'none';
                carousel.style.display = 'block';
                
                // –ü—Ä–æ—Å—Ç–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Swiper
                setTimeout(() => {
                    if (typeof Swiper !== 'undefined') {
                        console.log('üîß –û–¢–õ–ê–î–ö–ê: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Swiper');
                        const swiper = new Swiper('#users-swiper', {
                            slidesPerView: 1,
                            spaceBetween: 20,
                            navigation: {
                                nextEl: '.swiper-button-next',
                                prevEl: '.swiper-button-prev',
                            },
                            pagination: {
                                el: '.swiper-pagination',
                                clickable: true,
                            },
                            on: {
                                init: function() {
                                    console.log('üîß –û–¢–õ–ê–î–ö–ê: Swiper –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!');
                                }
                            }
                        });
                    } else {
                        console.error('üîß –û–¢–õ–ê–î–ö–ê: Swiper –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                    }
                }, 100);
            } else {
                console.error('üîß –û–¢–õ–ê–î–ö–ê: –ö–∞—Ä—É—Å–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
            }
        });
    } else {
        console.error('üîß –û–¢–õ–ê–î–ö–ê: –ö–Ω–æ–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
    }
});
</script>

<!-- SVG —Ñ–∏–ª—å—Ç—Ä –¥–ª—è —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–æ–π –æ–±–≤–æ–¥–∫–∏ -->
<svg style="position: absolute; width: 0; height: 0;" aria-hidden="true">
    <defs>
        <filter id="turbulent-displace" colorInterpolationFilters="sRGB" x="-20%" y="-20%" width="140%" height="140%">
            <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="10" result="noise1" seed="1" />
            <feOffset in="noise1" dx="0" dy="0" result="offsetNoise1">
                <animate attributeName="dy" values="700; 0" dur="6s" repeatCount="indefinite" calcMode="linear" />
            </feOffset>

            <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="10" result="noise2" seed="1" />
            <feOffset in="noise2" dx="0" dy="0" result="offsetNoise2">
                <animate attributeName="dy" values="0; -700" dur="6s" repeatCount="indefinite" calcMode="linear" />
            </feOffset>

            <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="10" result="noise1" seed="2" />
            <feOffset in="noise1" dx="0" dy="0" result="offsetNoise3">
                <animate attributeName="dx" values="490; 0" dur="6s" repeatCount="indefinite" calcMode="linear" />
            </feOffset>

            <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="10" result="noise2" seed="2" />
            <feOffset in="noise2" dx="0" dy="0" result="offsetNoise4">
                <animate attributeName="dx" values="0; -490" dur="6s" repeatCount="indefinite" calcMode="linear" />
            </feOffset>

            <feComposite in="offsetNoise1" in2="offsetNoise2" result="part1" />
            <feComposite in="offsetNoise3" in2="offsetNoise4" result="part2" />
            <feBlend in="part1" in2="part2" mode="color-dodge" result="combinedNoise" />

            <feDisplacementMap in="SourceGraphic" in2="combinedNoise" scale="30" xChannelSelector="R" yChannelSelector="B" />
        </filter>
    </defs>
</svg>
{% endblock %}

{% block content %}
<div class="top-users-container">
    <div class="filter-section">
        <div class="filter-controls">
            <div class="filter-group">
                <label class="filter-label" data-translate="gender">{{ translations.get('gender', '–ü–æ–ª') }}:</label>
                <select class="filter-select" id="gender-filter">
                    <option value="" data-translate="gender_placeholder">{{ translations.get('gender_placeholder', '–ü–æ–ª') }}</option>
                    <option value="male" data-translate="male">{{ translations.get('male', '–ú—É–∂—Å–∫–æ–π') }}</option>
                    <option value="female" data-translate="female">{{ translations.get('female', '–ñ–µ–Ω—Å–∫–∏–π') }}</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label" data-translate="age">{{ translations.get('age', '–í–æ–∑—Ä–∞—Å—Ç') }}:</label>
                <select class="filter-select" id="age-filter">
                    <option value="" data-translate="age_placeholder">{{ translations.get('age_placeholder', '–í–æ–∑—Ä–∞—Å—Ç') }}</option>
                    <option value="18-25">18-25</option>
                    <option value="26-35">26-35</option>
                    <option value="36-45">36-45</option>
                    <option value="46+">46+</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label" data-translate="technology">{{ translations.get('technology', '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è') }}:</label>
                <select class="filter-select" id="language-filter">
                    <option value="" data-translate="technology_placeholder">{{ translations.get('technology_placeholder', '–¢–µ–º–∞') }}</option>
                    {% if programming_languages %}
                        {% for lang in programming_languages %}
                            <option value="{{ lang.name }}">{{ lang.name }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label" data-translate="online_status">{{ translations.get('online_status', '–°—Ç–∞—Ç—É—Å') }}:</label>
                <select class="filter-select" id="online-filter">
                    <option value="" data-translate="all">{{ translations.get('all', '–í—Å–µ') }}</option>
                    <option value="true" data-translate="online">{{ translations.get('online', '–û–Ω–ª–∞–π–Ω') }}</option>
                </select>
            </div>
            
            <button class="filter-reset-btn" id="reset-filters" data-translate="reset_filters">
                {{ translations.get('reset_filters', '–°–±—Ä–æ—Å–∏—Ç—å') }}
            </button>
        </div>
    </div>
    
    <!-- –¢–æ–ø-5 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º—ã–µ) -->
    <div class="top-5-users">
        <div class="top-users-list" id="top-5-list">
            {% if top_users %}
                {% for user in top_users[:5] %}
                <div class="user-item" data-telegram-id="{{ user.telegram_id }}" onclick="openUserProfile({{ user.telegram_id }})">
                    <div class="user-rank">{{ loop.index }}</div>
                    <div class="user-avatar-wrapper">
                        <img class="user-avatar" src="{{ user.avatar_url or '/static/images/default_avatar.png' }}" alt="{{ user.username }}">
                        {% if user.is_online %}
                        <div class="online-indicator"></div>
                        {% endif %}
                    </div>
                    <div class="user-info">
                        <h3 class="user-username">{{ user.username }}</h3>
                        <p class="user-name">{{ user.first_name }} {{ user.last_name }}</p>
                        <div class="user-stats">
                            <div class="stat-item">
                                <span class="stat-label" data-translate="rating">{{ translations.get('rating', '–†–µ–π—Ç–∏–Ω–≥') }}:</span>
                                <span class="stat-value">{{ user.rating }}</span>
                            </div>
                            <div class="personal-info-item">
                                <span class="gender-icon">
                                    {% if user.gender == 'male' %}
                                        ‚ôÇÔ∏è
                                    {% elif user.gender == 'female' %}
                                        ‚ôÄÔ∏è
                                    {% else %}
                                        ‚ùì
                                    {% endif %}
                                </span>
                            </div>
                            <div class="personal-info-item">
                                <span class="age-info">
                                    {% if user.age %}
                                        {{ user.age }} {{ translations.get('years_old', '–ª–µ—Ç') }}
                                    {% else %}
                                        {{ translations.get('age_unknown', '–í–æ–∑—Ä–∞—Å—Ç –Ω–µ —É–∫–∞–∑–∞–Ω') }}
                                    {% endif %}
                                </span>
                            </div>
                            <div class="personal-info-item">
                                <span class="grade-info grade-{{ user.grade or 'none' }}">
                                    {% if user.grade %}
                                        {% if user.grade == 'junior' %}
                                            {{ translations.get('junior', 'Junior') }}
                                        {% elif user.grade == 'middle' %}
                                            {{ translations.get('middle', 'Middle') }}
                                        {% elif user.grade == 'senior' %}
                                            {{ translations.get('senior', 'Senior') }}
                                        {% else %}
                                            {{ user.grade }}
                                        {% endif %}
                                    {% else %}
                                        {{ translations.get('grade_unknown', '–ì—Ä–µ–π–¥ –Ω–µ —É–∫–∞–∑–∞–Ω') }}
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <div class="empty-icon">üèÜ</div>
                    <p data-translate="no_top_users">{{ translations.get('no_top_users', '–ü–æ–∫–∞ –Ω–µ—Ç –ª—É—á—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π') }}</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ "–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏" -->
    {% if top_users %}
    <div class="show-all-section">
        <button class="show-all-btn" id="show-all-users" data-translate="show_all_users">
            {{ translations.get('show_all_users', '–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏') }} ({{ top_users|length }})
        </button>
    </div>
    {% endif %}

    <!-- –°–≤–∞–π–ø-–∫–∞—Ä—É—Å–µ–ª—å –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Å–∫—Ä—ã—Ç–∞—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
    <div class="all-users-carousel" id="all-users-carousel" style="display: none;">
        <h2 class="section-title" data-translate="all_users_title">{{ translations.get('all_users_title', '–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏') }}</h2>
        <div class="swiper" id="users-swiper">
            <div class="swiper-wrapper">
                {% if top_users %}
                    {% for user in top_users[5:] %}
                    <div class="swiper-slide">
                        <div class="user-item" data-telegram-id="{{ user.telegram_id }}" onclick="openUserProfile({{ user.telegram_id }})">
                            <div class="user-rank">{{ loop.index + 5 }}</div>
                            <div class="user-avatar-wrapper">
                                <img class="user-avatar" src="{{ user.avatar_url or '/static/images/default_avatar.png' }}" alt="{{ user.username }}">
                                {% if user.is_online %}
                                <div class="online-indicator"></div>
                                {% endif %}
                            </div>
                            <div class="user-info">
                                <h3 class="user-username">{{ user.username }}</h3>
                                <p class="user-name">{{ user.first_name }} {{ user.last_name }}</p>
                                <div class="user-stats">
                                    <div class="stat-item">
                                        <span class="stat-label" data-translate="rating">{{ translations.get('rating', '–†–µ–π—Ç–∏–Ω–≥') }}:</span>
                                        <span class="stat-value">{{ user.rating }}</span>
                                    </div>
                                    <div class="personal-info-item">
                                        <span class="gender-icon">
                                            {% if user.gender == 'male' %}
                                                ‚ôÇÔ∏è
                                            {% elif user.gender == 'female' %}
                                                ‚ôÄÔ∏è
                                            {% else %}
                                                ‚ùì
                                            {% endif %}
                                        </span>
                                    </div>
                                    <div class="personal-info-item">
                                        <span class="age-info">
                                            {% if user.age %}
                                                {{ user.age }} {{ translations.get('years_old', '–ª–µ—Ç') }}
                                            {% else %}
                                                {{ translations.get('age_unknown', '–í–æ–∑—Ä–∞—Å—Ç –Ω–µ —É–∫–∞–∑–∞–Ω') }}
                                            {% endif %}
                                        </span>
                                    </div>
                                    <div class="personal-info-item">
                                        <span class="grade-info grade-{{ user.grade or 'none' }}">
                                            {% if user.grade %}
                                                {% if user.grade == 'junior' %}
                                                    {{ translations.get('junior', 'Junior') }}
                                                {% elif user.grade == 'middle' %}
                                                    {{ translations.get('middle', 'Middle') }}
                                                {% elif user.grade == 'senior' %}
                                                    {{ translations.get('senior', 'Senior') }}
                                                {% else %}
                                                    {{ user.grade }}
                                                {% endif %}
                                            {% else %}
                                                {{ translations.get('grade_unknown', '–ì—Ä–µ–π–¥ –Ω–µ —É–∫–∞–∑–∞–Ω') }}
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
            <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
            <div class="swiper-pagination"></div>
            <div class="swiper-button-next"></div>
            <div class="swiper-button-prev"></div>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∞ "–°–∫—Ä—ã—Ç—å" -->
        <div class="hide-all-section">
            <button class="hide-all-btn" id="hide-all-users" data-translate="hide_all_users">
                {{ translations.get('hide_all_users', '–°–∫—Ä—ã—Ç—å') }}
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Ç–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Top users page loaded, initializing filters...');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç top_users.js –∑–∞–≥—Ä—É–∂–µ–Ω
    if (typeof window.TopUsersFilter === 'function') {
        console.log('‚úÖ TopUsersFilter class found, initializing...');
        window.topUsersFilter = new window.TopUsersFilter();
        console.log('‚úÖ TopUsersFilter initialized successfully');
    } else {
        console.error('‚ùå TopUsersFilter class not found! Trying to load script...');
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∫—Ä–∏–ø—Ç –µ—Å–ª–∏ –æ–Ω –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
        const script = document.createElement('script');
        script.src = '{{ get_js_url("top_users.js") }}';
        script.onload = function() {
            console.log('‚úÖ Top users script loaded, initializing...');
            if (typeof window.TopUsersFilter === 'function') {
                window.topUsersFilter = new window.TopUsersFilter();
                console.log('‚úÖ TopUsersFilter initialized after script load');
            } else {
                // Fallback - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                window.location.href = url.toString();
            }
        }
        document.head.appendChild(script);
    }
    
    console.log('‚úÖ –§—É–Ω–∫—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
});
</script>
{% endblock %}
